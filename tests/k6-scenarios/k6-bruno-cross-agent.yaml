# ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
#
#  üí¨ K6 AGENT-BRUNO CROSS-AGENT COMMUNICATION
#
#  Purpose: Test Bruno's ability to communicate with other agents
#           and handle cross-agent workflows
#
#  Integrations Tested:
#    ‚Ä¢ ü§ñ Bruno ‚Üî Contracts - Security queries
#    ‚Ä¢ ü§ñ Bruno ‚Üî AlertManager - System alerts
#    ‚Ä¢ ü§ñ Bruno ‚Üî Tools - K8s operations
#    ‚Ä¢ ü§ñ Bruno ‚Üî Medical - Patient queries (RBAC)
#
#  Scenarios:
#    1. Basic Chat - Simple Q&A conversations
#    2. Security Queries - Triggers contract scanning
#    3. Status Queries - Retrieves system alerts
#    4. Multi-turn Conversations - Complex dialogues
#    5. Concurrent Sessions - Load testing
#
# ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
---
apiVersion: k6.io/v1alpha1
kind: TestRun
metadata:
  name: bruno-cross-agent
  namespace: agent-bruno
  labels:
    app.kubernetes.io/name: agent-bruno
    app.kubernetes.io/component: testing
    test-type: cross-agent
spec:
  parallelism: 2
  arguments: -o experimental-prometheus-rw
  script:
    configMap:
      name: bruno-cross-agent-script
      file: cross-agent.js
  runner:
    image: localhost:5001/k6:0.47.0
    env:
      - name: BRUNO_URL
        value: "http://agent-bruno.agent-bruno.svc.cluster.local"
      - name: CONTRACTS_URL
        value: "http://contract-fetcher.agent-contracts.svc.cluster.local"
      - name: TOOLS_URL
        value: "http://agent-tools.agent-tools.svc.cluster.local"
      - name: K6_PROMETHEUS_RW_SERVER_URL
        value: "http://kube-prometheus-stack-prometheus.prometheus.svc.cluster.local:9090/api/v1/write"
      - name: K6_PROMETHEUS_RW_TREND_AS_NATIVE_HISTOGRAM
        value: "true"
    resources:
      limits:
        memory: 512Mi
        cpu: 500m
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: bruno-cross-agent-script
  namespace: agent-bruno
  labels:
    app.kubernetes.io/name: agent-bruno
    app.kubernetes.io/component: testing
data:
  cross-agent.js: |
    import http from 'k6/http';
    import { check, group, sleep, fail } from 'k6';
    import { Rate, Counter, Trend, Gauge } from 'k6/metrics';

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // CUSTOM METRICS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    // Chat Metrics
    const messagesTotal = new Counter('bruno_messages_total');
    const messagesSuccess = new Rate('bruno_messages_success');
    const conversationsTotal = new Counter('bruno_conversations_total');
    const activeConversations = new Gauge('bruno_active_conversations');

    // Cross-Agent Metrics
    const crossAgentQueries = new Counter('bruno_cross_agent_queries');
    const securityQueriesCounter = new Counter('bruno_security_queries');
    const statusQueriesCounter = new Counter('bruno_status_queries');
    const toolsQueries = new Counter('bruno_tools_queries');

    // Performance Metrics
    const chatResponseTime = new Trend('bruno_chat_response_ms');
    const llmLatency = new Trend('bruno_llm_latency_ms');
    const crossAgentLatency = new Trend('bruno_cross_agent_latency_ms');

    // Quality Metrics
    const intentDetectionRate = new Rate('bruno_intent_detection');
    const relevantResponseRate = new Rate('bruno_relevant_response');
    const conversationCompletionRate = new Rate('bruno_conversation_completion');

    // Token Metrics
    const tokensUsed = new Counter('bruno_tokens_used');

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // CONFIGURATION
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    const BRUNO_URL = __ENV.BRUNO_URL || 'http://agent-bruno.agent-bruno.svc.cluster.local';
    const CONTRACTS_URL = __ENV.CONTRACTS_URL || 'http://contract-fetcher.agent-contracts.svc.cluster.local';
    const TOOLS_URL = __ENV.TOOLS_URL || 'http://agent-tools.agent-tools.svc.cluster.local';

    // Chat Templates
    const CHAT_TEMPLATES = {
      greeting: [
        'Hello!',
        'Hi there!',
        'Hey Bruno!',
        'Good morning!',
      ],
      general_questions: [
        'What can you help me with?',
        'Tell me about this homelab',
        'What services are running?',
        'How does the infrastructure work?',
      ],
      security_questions: [
        'Are there any security vulnerabilities?',
        'What is the security status?',
        'Check the smart contracts for vulnerabilities',
        'Run a security scan',
        'Any critical security issues?',
      ],
      status_questions: [
        'What is the system status?',
        'Are there any active alerts?',
        'Show me the cluster health',
        'Any pods failing?',
        'What is the CPU usage?',
      ],
      tools_questions: [
        'List all namespaces',
        'Show me the pods in default namespace',
        'What deployments are running?',
        'Check the node status',
      ],
      multi_turn: {
        security_deep_dive: [
          'Tell me about security',
          'What vulnerabilities have been found recently?',
          'Can you explain the reentrancy vulnerability?',
          'How was it fixed?',
        ],
        infrastructure_tour: [
          'What runs in this homelab?',
          'Tell me more about the AI agents',
          'How do they communicate?',
          'What is Knative Lambda Operator?',
        ],
      },
    };

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // TEST OPTIONS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    export const options = {
      scenarios: {
        // Scenario 1: Basic chat
        basic_chat: {
          executor: 'per-vu-iterations',
          vus: 2,
          iterations: 5,
          maxDuration: '10m',
          tags: { chat_type: 'basic' },
          exec: 'basicChat',
        },
        // Scenario 2: Security queries (cross-agent)
        security_queries_scenario: {
          executor: 'per-vu-iterations',
          vus: 2,
          iterations: 3,
          maxDuration: '10m',
          startTime: '2m',
          tags: { chat_type: 'security' },
          exec: 'securityQueries',
        },
        // Scenario 3: Status queries
        status_queries_scenario: {
          executor: 'per-vu-iterations',
          vus: 2,
          iterations: 4,
          maxDuration: '8m',
          startTime: '5m',
          tags: { chat_type: 'status' },
          exec: 'statusQueries',
        },
        // Scenario 4: Multi-turn conversations
        multi_turn: {
          executor: 'per-vu-iterations',
          vus: 1,
          iterations: 2,
          maxDuration: '15m',
          startTime: '8m',
          tags: { chat_type: 'multi_turn' },
          exec: 'multiTurnConversation',
        },
        // Scenario 5: Concurrent chat load
        concurrent_load: {
          executor: 'ramping-vus',
          startVUs: 0,
          stages: [
            { duration: '30s', target: 5 },
            { duration: '2m', target: 15 },
            { duration: '3m', target: 25 },
            { duration: '2m', target: 10 },
            { duration: '30s', target: 0 },
          ],
          startTime: '15m',
          tags: { chat_type: 'load' },
          exec: 'concurrentLoad',
        },
      },
      thresholds: {
        'bruno_messages_success': ['rate>0.70'],
        'bruno_chat_response_ms': ['p(95)<120000'], // LLM can be slow
        'bruno_conversation_completion': ['rate>0.60'],
        'http_req_failed': ['rate<0.35'], // Increased from 0.30 to account for transient failures
      },
    };

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // HELPER FUNCTIONS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    function createCloudEvent(type, data, source) {
      return {
        specversion: '1.0',
        id: `k6-bruno-${Date.now()}-${Math.random().toString(36).substring(7)}`,
        type: type,
        source: source || '/k6-bruno-test',
        time: new Date().toISOString(),
        datacontenttype: 'application/json',
        data: data,
      };
    }

    function sendChat(message, conversationId) {
      const payload = {
        message: message,
        conversation_id: conversationId || `conv-${Date.now()}`,
      };

      return http.post(`${BRUNO_URL}/chat`, JSON.stringify(payload), {
        headers: { 'Content-Type': 'application/json' },
        timeout: '120s',
      });
    }

    function sendCloudEvent(url, event, timeout = '120s') {
      return http.post(url, JSON.stringify(event), {
        headers: {
          'Content-Type': 'application/cloudevents+json',
          'Ce-Type': event.type,
          'Ce-Source': event.source,
          'Ce-Id': event.id,
          'Ce-Specversion': '1.0',
        },
        timeout: timeout,
      });
    }

    function randomItem(array) {
      return array[Math.floor(Math.random() * array.length)];
    }

    function generateConversationId() {
      return `conv-${Date.now()}-${Math.random().toString(36).substring(7)}`;
    }

    class ChatSession {
      constructor(type) {
        this.conversationId = generateConversationId();
        this.type = type;
        this.messages = [];
        this.startTime = Date.now();
        this.tokensUsed = 0;
        this.completed = false;
      }

      addMessage(role, content, tokens = 0) {
        this.messages.push({
          role: role,
          content: content,
          tokens: tokens,
          timestamp: Date.now(),
        });
        this.tokensUsed += tokens;
      }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // SCENARIO 1: BASIC CHAT
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    export function basicChat() {
      const session = new ChatSession('basic');
      let conversationSuccess = true;

      console.log(`\nüí¨ Basic Chat Session: ${session.conversationId}`);
      conversationsTotal.add(1);
      activeConversations.add(1);

      // Greeting
      group('Greeting', () => {
        const greeting = randomItem(CHAT_TEMPLATES.greeting);
        session.addMessage('user', greeting);

        const start = Date.now();
        const res = sendChat(greeting, session.conversationId);
        const duration = Date.now() - start;

        chatResponseTime.add(duration);
        messagesTotal.add(1);

        const success = check(res, {
          'greeting response received': (r) => r.status >= 200 && r.status < 300,
          'response has content': (r) => {
            try {
              const body = JSON.parse(r.body);
              return body.response && body.response.length > 0;
            } catch (e) {
              return false;
            }
          },
        });

        messagesSuccess.add(success);

        if (success) {
          try {
            const body = JSON.parse(res.body);
            session.addMessage('assistant', body.response, body.tokens_used || 0);
            tokensUsed.add(body.tokens_used || 0);
            console.log(`  ‚úì Greeting (${duration}ms): ${body.response.substring(0, 50)}...`);
          } catch (e) {}
        } else {
          conversationSuccess = false;
        }
      });

      sleep(2);

      // General question
      group('General Question', () => {
        const question = randomItem(CHAT_TEMPLATES.general_questions);
        session.addMessage('user', question);

        const start = Date.now();
        const res = sendChat(question, session.conversationId);
        const duration = Date.now() - start;

        chatResponseTime.add(duration);
        messagesTotal.add(1);

        const success = check(res, {
          'question response received': (r) => r.status >= 200 && r.status < 300,
        });

        messagesSuccess.add(success);

        if (success) {
          try {
            const body = JSON.parse(res.body);
            session.addMessage('assistant', body.response, body.tokens_used || 0);
            tokensUsed.add(body.tokens_used || 0);
            llmLatency.add(body.duration_ms || duration);
            console.log(`  ‚úì Question (${duration}ms)`);
          } catch (e) {}
        } else {
          conversationSuccess = false;
        }
      });

      session.completed = conversationSuccess;
      conversationCompletionRate.add(session.completed);
      activeConversations.add(-1);

      console.log(`${session.completed ? '‚úÖ' : '‚ùå'} Session completed (${session.tokensUsed} tokens)\n`);

      sleep(3);
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // SCENARIO 2: SECURITY QUERIES (CROSS-AGENT)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    export function securityQueries() {
      const session = new ChatSession('security');
      let conversationSuccess = true;

      console.log(`\nüîê Security Query Session: ${session.conversationId}`);
      conversationsTotal.add(1);
      activeConversations.add(1);

      // Security question (should trigger cross-agent communication)
      group('Security Query', () => {
        const question = randomItem(CHAT_TEMPLATES.security_questions);
        session.addMessage('user', question);

        console.log(`  ‚Üí Asking: "${question}"`);

        const start = Date.now();
        const res = sendChat(question, session.conversationId);
        const duration = Date.now() - start;

        chatResponseTime.add(duration);
        crossAgentLatency.add(duration);
        messagesTotal.add(1);
        securityQueriesCounter.add(1);
        crossAgentQueries.add(1);

        const success = check(res, {
          'security response received': (r) => r.status >= 200 && r.status < 300,
          'response mentions security': (r) => {
            try {
              const body = JSON.parse(r.body);
              const response = body.response.toLowerCase();
              return response.includes('security') ||
                     response.includes('vulnerability') ||
                     response.includes('scan') ||
                     response.includes('contract');
            } catch (e) {
              return false;
            }
          },
        });

        messagesSuccess.add(success);
        intentDetectionRate.add(success);

        if (success) {
          try {
            const body = JSON.parse(res.body);
            session.addMessage('assistant', body.response, body.tokens_used || 0);
            tokensUsed.add(body.tokens_used || 0);
            console.log(`  ‚úì Security response (${duration}ms)`);
            console.log(`    Response preview: ${body.response.substring(0, 100)}...`);
          } catch (e) {}
        } else {
          conversationSuccess = false;
          console.log(`  ‚úó Security query failed: ${res.status}`);
        }
      });

      sleep(2);

      // Follow-up security question
      group('Security Follow-up', () => {
        const followUp = 'Can you provide more details about the vulnerabilities found?';
        session.addMessage('user', followUp);

        const start = Date.now();
        const res = sendChat(followUp, session.conversationId);
        const duration = Date.now() - start;

        chatResponseTime.add(duration);
        messagesTotal.add(1);

        const success = check(res, {
          'follow-up response received': (r) => r.status >= 200 && r.status < 300,
        });

        messagesSuccess.add(success);
        relevantResponseRate.add(success);

        if (success) {
          try {
            const body = JSON.parse(res.body);
            session.addMessage('assistant', body.response, body.tokens_used || 0);
            tokensUsed.add(body.tokens_used || 0);
            console.log(`  ‚úì Follow-up (${duration}ms)`);
          } catch (e) {}
        }
      });

      session.completed = conversationSuccess;
      conversationCompletionRate.add(session.completed);
      activeConversations.add(-1);

      console.log(`${session.completed ? '‚úÖ' : '‚ùå'} Security session completed\n`);

      sleep(3);
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // SCENARIO 3: STATUS QUERIES
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    export function statusQueries() {
      const session = new ChatSession('status');

      console.log(`\nüìä Status Query Session: ${session.conversationId}`);
      conversationsTotal.add(1);
      activeConversations.add(1);

      group('System Status Query', () => {
        const question = randomItem(CHAT_TEMPLATES.status_questions);
        session.addMessage('user', question);

        console.log(`  ‚Üí Asking: "${question}"`);

        const start = Date.now();
        const res = sendChat(question, session.conversationId);
        const duration = Date.now() - start;

        chatResponseTime.add(duration);
        messagesTotal.add(1);
        statusQueriesCounter.add(1);
        crossAgentQueries.add(1);

        const success = check(res, {
          'status response received': (r) => r.status >= 200 && r.status < 300,
        });

        messagesSuccess.add(success);

        if (success) {
          try {
            const body = JSON.parse(res.body);
            session.addMessage('assistant', body.response, body.tokens_used || 0);
            tokensUsed.add(body.tokens_used || 0);
            console.log(`  ‚úì Status response (${duration}ms)`);

            // Check for status-related content
            const response = body.response.toLowerCase();
            const hasStatusContent = response.includes('status') ||
                                    response.includes('running') ||
                                    response.includes('healthy') ||
                                    response.includes('alert') ||
                                    response.includes('pod') ||
                                    response.includes('service');
            intentDetectionRate.add(hasStatusContent);
          } catch (e) {}
        }
      });

      activeConversations.add(-1);
      conversationCompletionRate.add(true);

      sleep(2);
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // SCENARIO 4: MULTI-TURN CONVERSATION
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    export function multiTurnConversation() {
      const conversationType = Math.random() > 0.5 ? 'security_deep_dive' : 'infrastructure_tour';
      const turns = CHAT_TEMPLATES.multi_turn[conversationType];
      const session = new ChatSession('multi_turn');
      let allSuccessful = true;

      console.log(`\nüîÑ Multi-Turn Conversation: ${conversationType}`);
      console.log('‚îÄ'.repeat(50));
      conversationsTotal.add(1);
      activeConversations.add(1);

      for (let i = 0; i < turns.length; i++) {
        const turn = turns[i];

        group(`Turn ${i + 1}: ${turn.substring(0, 30)}...`, () => {
          session.addMessage('user', turn);

          console.log(`  [Turn ${i + 1}] User: "${turn}"`);

          const start = Date.now();
          const res = sendChat(turn, session.conversationId);
          const duration = Date.now() - start;

          chatResponseTime.add(duration);
          messagesTotal.add(1);

          const success = check(res, {
            [`turn ${i + 1} response`]: (r) => r.status >= 200 && r.status < 300,
          });

          messagesSuccess.add(success);

          if (success) {
            try {
              const body = JSON.parse(res.body);
              session.addMessage('assistant', body.response, body.tokens_used || 0);
              tokensUsed.add(body.tokens_used || 0);
              console.log(`  [Turn ${i + 1}] Bruno: "${body.response.substring(0, 80)}..." (${duration}ms)`);
            } catch (e) {}
          } else {
            allSuccessful = false;
            console.log(`  [Turn ${i + 1}] ‚ùå Failed: ${res.status}`);
          }
        });

        // Natural pause between turns
        sleep(3);
      }

      session.completed = allSuccessful;
      conversationCompletionRate.add(session.completed);
      activeConversations.add(-1);

      console.log('‚îÄ'.repeat(50));
      console.log(`${session.completed ? '‚úÖ' : '‚ùå'} Multi-turn completed (${session.messages.length} messages, ${session.tokensUsed} tokens)\n`);

      sleep(5);
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // SCENARIO 5: CONCURRENT LOAD
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    export function concurrentLoad() {
      const allQuestions = [
        ...CHAT_TEMPLATES.greeting,
        ...CHAT_TEMPLATES.general_questions,
        ...CHAT_TEMPLATES.security_questions,
        ...CHAT_TEMPLATES.status_questions,
      ];

      const question = randomItem(allQuestions);
      const conversationId = generateConversationId();

      activeConversations.add(1);

      group('Concurrent Chat', () => {
        const start = Date.now();
        const res = sendChat(question, conversationId);
        const duration = Date.now() - start;

        chatResponseTime.add(duration);
        messagesTotal.add(1);

        const success = check(res, {
          'concurrent response': (r) => r.status >= 200 && r.status < 300,
        });

        messagesSuccess.add(success);

        if (success) {
          try {
            const body = JSON.parse(res.body);
            tokensUsed.add(body.tokens_used || 0);
            llmLatency.add(body.duration_ms || duration);
          } catch (e) {}
        }
      });

      activeConversations.add(-1);

      sleep(randomInt(1, 3));
    }

    function randomInt(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // SUMMARY
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    export function handleSummary(data) {
      const messages = data.metrics['bruno_messages_total'];
      const msgSuccess = data.metrics['bruno_messages_success'];
      const conversations = data.metrics['bruno_conversations_total'];
      const convCompletion = data.metrics['bruno_conversation_completion'];
      const crossAgent = data.metrics['bruno_cross_agent_queries'];
      const security = data.metrics['bruno_security_queries'];
      const status = data.metrics['bruno_status_queries'];
      const tokens = data.metrics['bruno_tokens_used'];
      const chatTime = data.metrics['bruno_chat_response_ms'];
      const llmTime = data.metrics['bruno_llm_latency_ms'];
      const intentRate = data.metrics['bruno_intent_detection'];

      const messagesCount = messages && messages.values ? messages.values.count : 0;
      const msgSuccessRate = msgSuccess && msgSuccess.values ? msgSuccess.values.rate : 0;
      const convCount = conversations && conversations.values ? conversations.values.count : 0;
      const convCompletionRate = convCompletion && convCompletion.values ? convCompletion.values.rate : 0;
      const crossAgentCount = crossAgent && crossAgent.values ? crossAgent.values.count : 0;
      const securityCount = security && security.values ? security.values.count : 0;
      const statusCount = status && status.values ? status.values.count : 0;
      const tokensCount = tokens && tokens.values ? tokens.values.count : 0;
      const chatP95 = chatTime && chatTime.values ? chatTime.values['p(95)'] : 0;
      const chatAvg = chatTime && chatTime.values ? chatTime.values.avg : 0;
      const intentDetection = intentRate && intentRate.values ? intentRate.values.rate : 0;

      const passed = msgSuccessRate >= 0.70 && convCompletionRate >= 0.60;

      console.log('\n' + '‚ïê'.repeat(70));
      console.log('üí¨ AGENT-BRUNO CROSS-AGENT COMMUNICATION RESULTS');
      console.log('‚ïê'.repeat(70));
      console.log('Status: ' + (passed ? '‚úÖ PASSED' : '‚ùå FAILED'));
      console.log('‚îÄ'.repeat(70));
      console.log('üìä CONVERSATION METRICS');
      console.log('   Total Conversations:     ' + convCount);
      console.log('   Total Messages:          ' + messagesCount);
      console.log('   Message Success Rate:    ' + (msgSuccessRate * 100).toFixed(1) + '%');
      console.log('   Conversation Completion: ' + (convCompletionRate * 100).toFixed(1) + '%');
      console.log('‚îÄ'.repeat(70));
      console.log('üîó CROSS-AGENT QUERIES');
      console.log('   Total Cross-Agent:       ' + crossAgentCount);
      console.log('   Security Queries:        ' + securityCount);
      console.log('   Status Queries:          ' + statusCount);
      console.log('‚îÄ'.repeat(70));
      console.log('ü§ñ LLM METRICS');
      console.log('   Total Tokens Used:       ' + tokensCount);
      console.log('   Intent Detection Rate:   ' + (intentDetection * 100).toFixed(1) + '%');
      console.log('‚îÄ'.repeat(70));
      console.log('‚è±Ô∏è RESPONSE TIMES');
      console.log('   Chat Response (avg):     ' + (chatAvg || 0).toFixed(0) + 'ms');
      console.log('   Chat Response (P95):     ' + (chatP95 || 0).toFixed(0) + 'ms');
      console.log('‚ïê'.repeat(70) + '\n');

      return {};
    }
