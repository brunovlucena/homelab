---
apiVersion: k6.io/v1alpha1
kind: TestRun
metadata:
  name: agentchat-messaging-load
  namespace: agent-chat
  labels:
    test-suite: agent-chat
    test-type: load
spec:
  parallelism: 2
  script:
    configMap:
      name: agentchat-k6-scripts
      file: messaging-load.js
  arguments: ""
  runner:
    image: grafana/k6:0.47.0
    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        cpu: 500m
        memory: 512Mi
    env:
      - name: MESSAGING_HUB_URL
        value: "http://messaging-hub.agent-chat.svc.cluster.local"
      - name: K6_PROMETHEUS_RW_SERVER_URL
        value: "http://prometheus-prometheus-pushgateway.prometheus.svc.cluster.local:9091/metrics/job/k6"
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: agentchat-k6-scripts
  namespace: agent-chat
data:
  messaging-load.js: |
    import http from 'k6/http';
    import { check, sleep } from 'k6';
    import { Rate, Trend, Counter } from 'k6/metrics';
    import { randomString, randomIntBetween } from 'https://jslib.k6.io/k6-utils/1.4.0/index.js';

    // Custom metrics
    const messageSentRate = new Rate('agentchat_message_sent_success');
    const messageLatency = new Trend('agentchat_message_latency_ms');
    const messagesProcessed = new Counter('agentchat_messages_processed');
    const voiceCloneRequests = new Counter('agentchat_voice_clone_requests');
    const locationUpdates = new Counter('agentchat_location_updates');

    // Test configuration
    export const options = {
      scenarios: {
        // Ramp up messaging load
        messaging: {
          executor: 'ramping-vus',
          startVUs: 0,
          stages: [
            { duration: '30s', target: 10 },
            { duration: '1m', target: 50 },
            { duration: '2m', target: 100 },
            { duration: '1m', target: 50 },
            { duration: '30s', target: 0 },
          ],
          gracefulRampDown: '10s',
        },
      },
      thresholds: {
        http_req_duration: ['p(95)<500', 'p(99)<1000'],
        agentchat_message_sent_success: ['rate>0.95'],
        agentchat_message_latency_ms: ['p(95)<300'],
      },
    };

    const MESSAGING_HUB_URL = __ENV.MESSAGING_HUB_URL || 'http://localhost:8080';

    // CloudEvent helper
    function createCloudEvent(type, data, source = 'k6-load-test') {
      return {
        specversion: '1.0',
        id: `k6-${randomString(16)}`,
        type: type,
        source: source,
        time: new Date().toISOString(),
        datacontenttype: 'application/json',
        data: data,
      };
    }

    // Simulate different user actions
    function sendMessage(userId, chatId) {
      const event = createCloudEvent('io.agentchat.message.text', {
        userId: userId,
        chatId: chatId,
        content: `Test message from k6: ${randomString(50)}`,
        timestamp: Date.now(),
      });

      const start = Date.now();
      const res = http.post(`${MESSAGING_HUB_URL}/`, JSON.stringify(event), {
        headers: {
          'Content-Type': 'application/cloudevents+json',
          'Ce-Type': event.type,
          'Ce-Source': event.source,
          'Ce-Id': event.id,
          'Ce-Specversion': '1.0',
        },
      });
      const duration = Date.now() - start;

      const success = check(res, {
        'message sent': (r) => r.status === 200 || r.status === 202,
      });

      messageSentRate.add(success);
      messageLatency.add(duration);
      messagesProcessed.add(1);

      return success;
    }

    function requestVoiceClone(userId) {
      const event = createCloudEvent('io.agentchat.voice.request', {
        userId: userId,
        text: `Hello, this is a voice clone test for user ${userId}`,
        voiceId: `voice-${userId}`,
      });

      const res = http.post(`${MESSAGING_HUB_URL}/`, JSON.stringify(event), {
        headers: {
          'Content-Type': 'application/cloudevents+json',
          'Ce-Type': event.type,
          'Ce-Source': event.source,
          'Ce-Id': event.id,
          'Ce-Specversion': '1.0',
        },
      });

      voiceCloneRequests.add(1);
      return res.status === 200 || res.status === 202;
    }

    function sendLocationUpdate(userId) {
      const event = createCloudEvent('io.agentchat.location.update', {
        userId: userId,
        latitude: 37.7749 + (Math.random() - 0.5) * 0.1,
        longitude: -122.4194 + (Math.random() - 0.5) * 0.1,
        accuracy: randomIntBetween(5, 50),
        timestamp: Date.now(),
      });

      const res = http.post(`${MESSAGING_HUB_URL}/`, JSON.stringify(event), {
        headers: {
          'Content-Type': 'application/cloudevents+json',
          'Ce-Type': event.type,
          'Ce-Source': event.source,
          'Ce-Id': event.id,
          'Ce-Specversion': '1.0',
        },
      });

      locationUpdates.add(1);
      return res.status === 200 || res.status === 202;
    }

    export default function () {
      const userId = `user-${__VU}`;
      const chatId = `chat-${randomIntBetween(1, 10)}`;

      // 70% text messages, 15% location updates, 15% voice requests
      const action = Math.random();

      if (action < 0.70) {
        sendMessage(userId, chatId);
      } else if (action < 0.85) {
        sendLocationUpdate(userId);
      } else {
        requestVoiceClone(userId);
      }

      sleep(randomIntBetween(1, 3));
    }

    export function handleSummary(data) {
      var msgMetrics = data.metrics.agentchat_messages_processed || {};
      var voiceMetrics = data.metrics.agentchat_voice_clone_requests || {};
      var locMetrics = data.metrics.agentchat_location_updates || {};
      var successMetrics = data.metrics.agentchat_message_sent_success || {};
      var latencyMetrics = data.metrics.agentchat_message_latency_ms || {};

      return {
        stdout: JSON.stringify({
          test: 'agentchat-messaging-load',
          metrics: {
            messages_processed: (msgMetrics.values && msgMetrics.values.count) || 0,
            voice_clone_requests: (voiceMetrics.values && voiceMetrics.values.count) || 0,
            location_updates: (locMetrics.values && locMetrics.values.count) || 0,
            success_rate: (successMetrics.values && successMetrics.values.rate) || 0,
            avg_latency_ms: (latencyMetrics.values && latencyMetrics.values.avg) || 0,
            p95_latency_ms: (latencyMetrics.values && latencyMetrics.values['p(95)']) || 0,
          },
          thresholds: data.metrics,
        }, null, 2),
      };
    }
