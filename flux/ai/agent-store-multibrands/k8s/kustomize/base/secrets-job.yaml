---
# Job to create whatsapp-credentials and ai-credentials secrets
# These secrets are required by whatsapp-gateway and AI seller agents
apiVersion: batch/v1
kind: Job
metadata:
  name: store-secrets-init
  namespace: ai
  labels:
    app: agent-store-multibrands
    component: secret-init
  annotations:
    kustomize.toolkit.fluxcd.io/prune: disabled
spec:
  backoffLimit: 3
  ttlSecondsAfterFinished: 86400
  template:
    metadata:
      labels:
        app: agent-store-multibrands
        component: secret-init
    spec:
      serviceAccountName: store-secret-init
      restartPolicy: Never
      containers:
      - name: init
        image: localhost:5001/kubectl:v1.34.0
        imagePullPolicy: IfNotPresent
        command:
        - /bin/bash
        - -c
        - |
          set -euo pipefail

          echo "üîê Creating store secrets..."

          # Create whatsapp-credentials secret with placeholder values
          # These can be updated later with real WhatsApp Business API credentials
          kubectl create secret generic whatsapp-credentials \
            --from-literal=WHATSAPP_PHONE_NUMBER_ID="" \
            --from-literal=WHATSAPP_ACCESS_TOKEN="" \
            --from-literal=WHATSAPP_VERIFY_TOKEN="homelab-store-verify" \
            --from-literal=WHATSAPP_APP_SECRET="" \
            --namespace=agent-store-multibrands \
            --dry-run=client -o yaml | kubectl apply -f -
          echo "‚úÖ Created whatsapp-credentials secret (with placeholder values)"

          # Create ai-credentials secret with empty values (optional)
          # These can be updated later if using OpenAI or Anthropic APIs
          kubectl create secret generic ai-credentials \
            --from-literal=OPENAI_API_KEY="" \
            --from-literal=ANTHROPIC_API_KEY="" \
            --namespace=agent-store-multibrands \
            --dry-run=client -o yaml | kubectl apply -f -
          echo "‚úÖ Created ai-credentials secret (with empty values)"

          echo "‚úÖ All store secrets created successfully"
          echo "‚ö†Ô∏è  Note: Update whatsapp-credentials with real values for WhatsApp integration to work"
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: store-secret-init
  namespace: ai
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: store-secret-init
rules:
- apiGroups: [""]
  resources: ["secrets"]
  verbs: ["get", "list", "create", "update", "patch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: store-secret-init
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: store-secret-init
subjects:
- kind: ServiceAccount
  name: store-secret-init
  namespace: ai
