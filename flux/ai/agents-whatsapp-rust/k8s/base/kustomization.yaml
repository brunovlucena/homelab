apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: homelab-services

resources:
  # Note: namespace is managed by homelab-services/shared-infra
  # - namespace.yaml  # Removed to avoid conflict with homelab-services namespace
  - broker.yaml
  - messaging-service.yaml
  - messaging-service-loadbalancer.yaml
  # Optional: Use Ingress for SSL/TLS termination (adds Layer 7 overhead)
  # - messaging-service-ingress.yaml
  - user-service.yaml
  - agent-gateway.yaml
  - message-storage-service.yaml
  - broker-trigger.yaml
  - rbac.yaml
  - secrets-job.yaml
  - lambdaagent-message-processor.yaml

images:
  - name: localhost:5001/agents-whatsapp-rust-messaging
    newTag: v1.0.4
  - name: localhost:5001/agents-whatsapp-rust-user
    newTag: v1.0.4
  - name: localhost:5001/agents-whatsapp-rust-agent-gateway
    newTag: v1.0.4
  - name: localhost:5001/agents-whatsapp-rust-message-storage
    newTag: v1.0.4

# Note: LambdaAgent CRD uses spec.image.repository + tag (not container image),
# so we use patches instead of kustomize images: section
patches:
  - target:
      kind: LambdaAgent
      name: message-processor
    patch: |-
      - op: replace
        path: /spec/image/tag
        value: "v1.0.4"

labels:
  - pairs:
      app.kubernetes.io/name: agents-whatsapp-rust
      app.kubernetes.io/part-of: agents-whatsapp-rust
    includeSelectors: false  # Knative Services don't support selectors
