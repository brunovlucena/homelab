---
apiVersion: batch/v1
kind: Job
metadata:
  name: agents-whatsapp-rust-secret-sync
  namespace: homelab-services
  labels:
    app: agents-whatsapp-rust
    component: secret-sync
spec:
  backoffLimit: 3
  ttlSecondsAfterFinished: 86400
  template:
    metadata:
      labels:
        app: agents-whatsapp-rust
        component: secret-sync
    spec:
      serviceAccountName: agents-whatsapp-rust-secret-sync
      restartPolicy: Never
      containers:
        - name: sync
          image: localhost:5001/kubectl:v1.34.0
          imagePullPolicy: IfNotPresent
          env:
            - name: SOURCE_NAMESPACE
              value: flux-system
            - name: TARGET_NAMESPACE
              value: homelab-services
            - name: SECRET_NAMES
              value: "github-token"
          command:
            - /bin/bash
            - -c
            - |
              set -euo pipefail

              echo "Creating ghcr-secret from github-token"
              # Get token from password, token, or value key
              for key in password token value; do
                GITHUB_TOKEN=$(kubectl get secret github-token -n "${SOURCE_NAMESPACE}" -o jsonpath="{.data.${key}}" 2>/dev/null | base64 -d)
                [ -n "${GITHUB_TOKEN}" ] && break
              done
              
              if [ -z "${GITHUB_TOKEN}" ]; then
                echo "Error: Could not extract token from github-token secret"
                exit 1
              fi
              
              # Get username if available, otherwise use token as username
              GITHUB_USERNAME=$(kubectl get secret github-token -n "${SOURCE_NAMESPACE}" -o jsonpath="{.data.username}" 2>/dev/null | base64 -d)
              GITHUB_USERNAME="${GITHUB_USERNAME:-${GITHUB_TOKEN}}"
              
              kubectl create secret docker-registry ghcr-secret \
                --docker-server=ghcr.io \
                --docker-username="${GITHUB_USERNAME}" \
                --docker-password="${GITHUB_TOKEN}" \
                --namespace="${TARGET_NAMESPACE}" \
                --dry-run=client -o yaml | kubectl apply -f -
              echo "✅ Created ghcr-secret"
              
              echo "Creating jwt-secret from homelab-services-secrets"
              # Get JWT secret from homelab-services-secrets
              JWT_SECRET=$(kubectl get secret homelab-services-secrets -n "${TARGET_NAMESPACE}" -o jsonpath="{.data.jwt-secret}" 2>/dev/null | base64 -d)
              
              if [ -z "${JWT_SECRET}" ]; then
                echo "Error: Could not extract jwt-secret from homelab-services-secrets"
                exit 1
              fi
              
              # Create jwt-secret with key 'secret' as expected by the deployment
              kubectl create secret generic jwt-secret \
                --from-literal=secret="${JWT_SECRET}" \
                --namespace="${TARGET_NAMESPACE}" \
                --dry-run=client -o yaml | kubectl apply -f -
              echo "✅ Created jwt-secret"
              
              echo "Forcing rollout of all Knative services in ${TARGET_NAMESPACE}"
              for service in $(kubectl get ksvc -n "${TARGET_NAMESPACE}" -l app.kubernetes.io/part-of=agents-whatsapp-rust -o jsonpath='{.items[*].metadata.name}'); do
                echo "Rolling out Knative service ${service}"
                kubectl patch ksvc "${service}" -n "${TARGET_NAMESPACE}" --type=merge -p '{"spec":{"template":{"metadata":{"annotations":{"kubectl.kubernetes.io/restartedAt":"'$(date +%s)'"}}}}}'
              done
              
              echo "✅ Secret sync and rollout complete"
