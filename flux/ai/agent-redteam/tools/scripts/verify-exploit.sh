#!/bin/bash
# Verify Red Team Exploit Results
# âš ï¸ AUTHORIZED TESTING ONLY

set -e

NAMESPACE="${1:-redteam-test}"
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘           ğŸ” Red Team Exploit Verification                   â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# Check for exploit resources
echo -e "${YELLOW}[*] Checking for exploit LambdaFunctions...${NC}"
kubectl get lambdafunctions -n "$NAMESPACE" -l redteam=true 2>/dev/null || echo "No exploit functions found"
echo ""

# Check for escalation artifacts
echo -e "${YELLOW}[*] Checking for privilege escalation artifacts...${NC}"
if kubectl get clusterrole attacker-admin 2>/dev/null; then
    echo -e "${RED}[!] VULN-004 EXPLOITED: attacker-admin ClusterRole exists!${NC}"
fi
if kubectl get clusterrolebinding attacker-admin-binding 2>/dev/null; then
    echo -e "${RED}[!] VULN-004 EXPLOITED: attacker-admin-binding exists!${NC}"
fi
if kubectl get sa attacker-sa -n default 2>/dev/null; then
    echo -e "${RED}[!] VULN-004 EXPLOITED: attacker-sa ServiceAccount exists!${NC}"
fi
echo ""

# Check for persistence mechanisms
echo -e "${YELLOW}[*] Checking for persistence mechanisms...${NC}"
if kubectl get cronjob system-health-check -n default 2>/dev/null; then
    echo -e "${RED}[!] VULN-003 EXPLOITED: Backdoor CronJob exists!${NC}"
fi
if kubectl get daemonset node-monitor -n kube-system 2>/dev/null; then
    echo -e "${RED}[!] VULN-003 EXPLOITED: Backdoor DaemonSet exists!${NC}"
fi
echo ""

# Check build job status
echo -e "${YELLOW}[*] Checking build job status...${NC}"
kubectl get jobs -n "$NAMESPACE" -l lambda.knative.io/build=true 2>/dev/null || echo "No build jobs found"
echo ""

# Check for suspicious pods
echo -e "${YELLOW}[*] Checking for Lambda function pods...${NC}"
kubectl get pods -n "$NAMESPACE" -l serving.knative.dev/service 2>/dev/null || echo "No Lambda pods found"
echo ""

# Check events for errors
echo -e "${YELLOW}[*] Recent events (errors)...${NC}"
kubectl get events -n "$NAMESPACE" --field-selector type=Warning --sort-by='.lastTimestamp' 2>/dev/null | tail -10 || echo "No warning events"
echo ""

# Check exfiltration logs
REPORT_DIR="$(dirname "$0")/../reports"
if [ -d "$REPORT_DIR" ]; then
    echo -e "${YELLOW}[*] Exfiltration logs...${NC}"
    latest_log=$(ls -t "$REPORT_DIR"/exfil_*.json 2>/dev/null | head -1)
    if [ -n "$latest_log" ]; then
        echo -e "${GREEN}[+] Found exfil log: $latest_log${NC}"
        echo "Last 5 entries:"
        tail -5 "$latest_log" | jq -r '.timestamp + " - " + .endpoint' 2>/dev/null || cat "$latest_log" | tail -5
    else
        echo "No exfiltration logs found"
    fi
fi

echo ""
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘                   Verification Complete                      â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
