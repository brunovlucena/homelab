"""
Unit tests for the exploit runner handler.
"""
import pytest
from unittest.mock import AsyncMock, patch

from shared.types import (
    ExploitDefinition,
    ExploitResult,
    ExploitStatus,
    ExploitSeverity,
    ExploitCategory,
    TargetComponent,
    ExploitCatalog,
    TestRun,
)


class TestExploitDefinition:
    """Tests for ExploitDefinition dataclass."""
    
    def test_create_exploit_definition(self):
        """Test creating an exploit definition."""
        exploit = ExploitDefinition(
            id="test-001",
            name="Test Exploit",
            description="A test exploit",
            severity=ExploitSeverity.HIGH,
            category=ExploitCategory.COMMAND_INJECTION,
            target_component=TargetComponent.GIT_CLONE,
            manifest_path="exploits/test/",
            expected_outcome="Test outcome",
        )
        
        assert exploit.id == "test-001"
        assert exploit.name == "Test Exploit"
        assert exploit.severity == ExploitSeverity.HIGH
        assert exploit.category == ExploitCategory.COMMAND_INJECTION
    
    def test_exploit_to_dict(self):
        """Test converting exploit to dictionary."""
        exploit = ExploitDefinition(
            id="test-001",
            name="Test Exploit",
            description="A test exploit",
            severity=ExploitSeverity.CRITICAL,
            category=ExploitCategory.SSRF,
            target_component=TargetComponent.LAMBDA_OPERATOR,
            manifest_path="exploits/test/",
            expected_outcome="Test outcome",
            tags=["test", "ssrf"],
        )
        
        result = exploit.to_dict()
        
        assert result["id"] == "test-001"
        assert result["severity"] == "critical"
        assert result["category"] == "ssrf"
        assert result["tags"] == ["test", "ssrf"]


class TestExploitResult:
    """Tests for ExploitResult dataclass."""
    
    def test_create_exploit_result(self):
        """Test creating an exploit result."""
        result = ExploitResult(
            exploit_id="vuln-001",
            status=ExploitStatus.SUCCESS,
        )
        
        assert result.exploit_id == "vuln-001"
        assert result.status == ExploitStatus.SUCCESS
        assert result.started_at != ""  # Auto-generated
    
    def test_exploit_result_to_dict(self):
        """Test converting result to dictionary."""
        result = ExploitResult(
            exploit_id="vuln-001",
            status=ExploitStatus.BLOCKED,
            mitigated_by="admission_webhook",
            duration_seconds=5.5,
        )
        
        d = result.to_dict()
        
        assert d["exploit_id"] == "vuln-001"
        assert d["status"] == "blocked"
        assert d["mitigated_by"] == "admission_webhook"
        assert d["duration_seconds"] == 5.5


class TestExploitCatalog:
    """Tests for ExploitCatalog."""
    
    def test_catalog_get_by_id(self):
        """Test getting exploit by ID."""
        exploits = [
            ExploitDefinition(
                id="vuln-001",
                name="Exploit 1",
                description="Test",
                severity=ExploitSeverity.HIGH,
                category=ExploitCategory.COMMAND_INJECTION,
                target_component=TargetComponent.GIT_CLONE,
                manifest_path="test/",
                expected_outcome="Test",
            ),
            ExploitDefinition(
                id="vuln-002",
                name="Exploit 2",
                description="Test",
                severity=ExploitSeverity.CRITICAL,
                category=ExploitCategory.SSRF,
                target_component=TargetComponent.GIT_CLONE,
                manifest_path="test/",
                expected_outcome="Test",
            ),
        ]
        
        catalog = ExploitCatalog(exploits=exploits)
        
        assert catalog.get_by_id("vuln-001").name == "Exploit 1"
        assert catalog.get_by_id("vuln-002").name == "Exploit 2"
        assert catalog.get_by_id("nonexistent") is None
    
    def test_catalog_get_by_severity(self):
        """Test filtering by severity."""
        exploits = [
            ExploitDefinition(
                id="vuln-001",
                name="Exploit 1",
                description="Test",
                severity=ExploitSeverity.HIGH,
                category=ExploitCategory.COMMAND_INJECTION,
                target_component=TargetComponent.GIT_CLONE,
                manifest_path="test/",
                expected_outcome="Test",
            ),
            ExploitDefinition(
                id="vuln-002",
                name="Exploit 2",
                description="Test",
                severity=ExploitSeverity.CRITICAL,
                category=ExploitCategory.SSRF,
                target_component=TargetComponent.GIT_CLONE,
                manifest_path="test/",
                expected_outcome="Test",
            ),
            ExploitDefinition(
                id="vuln-003",
                name="Exploit 3",
                description="Test",
                severity=ExploitSeverity.CRITICAL,
                category=ExploitCategory.CODE_INJECTION,
                target_component=TargetComponent.LAMBDA_OPERATOR,
                manifest_path="test/",
                expected_outcome="Test",
            ),
        ]
        
        catalog = ExploitCatalog(exploits=exploits)
        
        critical = catalog.get_by_severity(ExploitSeverity.CRITICAL)
        assert len(critical) == 2
        
        high = catalog.get_by_severity(ExploitSeverity.HIGH)
        assert len(high) == 1


class TestTestRun:
    """Tests for TestRun dataclass."""
    
    def test_test_run_properties(self, sample_test_run):
        """Test TestRun computed properties."""
        assert sample_test_run.total_exploits == 2
        assert sample_test_run.successful_exploits == 1
        assert sample_test_run.blocked_exploits == 1
        assert sample_test_run.failed_exploits == 0
    
    def test_test_run_to_dict(self, sample_test_run):
        """Test converting TestRun to dictionary."""
        d = sample_test_run.to_dict()
        
        assert d["id"] == "test-123"
        assert d["name"] == "test-run"
        assert d["total_exploits"] == 2
        assert d["successful_exploits"] == 1
        assert len(d["results"]) == 2


class TestExploitRunner:
    """Tests for ExploitRunner class."""
    
    def test_catalog_initialization(self, exploit_runner):
        """Test that catalog is initialized with built-in exploits."""
        catalog = exploit_runner.get_catalog()
        
        assert len(catalog.exploits) > 0
        assert catalog.get_by_id("vuln-001") is not None
        assert catalog.get_by_id("blue-001") is not None
    
    @pytest.mark.asyncio
    async def test_run_exploit_dry_run(self, exploit_runner):
        """Test running exploit in dry-run mode."""
        result = await exploit_runner.run_exploit("vuln-001")
        
        assert result.status == ExploitStatus.SUCCESS
        assert "DRY RUN" in result.output
        assert result.exploit_id == "vuln-001"
    
    @pytest.mark.asyncio
    async def test_run_exploit_not_found(self, exploit_runner):
        """Test running non-existent exploit."""
        result = await exploit_runner.run_exploit("nonexistent-exploit")
        
        assert result.status == ExploitStatus.ERROR
        assert "not found" in result.error
    
    @pytest.mark.asyncio
    async def test_run_test_suite(self, exploit_runner):
        """Test running a test suite."""
        test_run = await exploit_runner.run_test(
            name="test-suite",
            exploit_ids=["vuln-001", "vuln-002"],
        )
        
        assert test_run.name == "test-suite"
        assert test_run.status == "completed"
        assert len(test_run.results) == 2
    
    @pytest.mark.asyncio
    async def test_run_test_by_category(self, exploit_runner):
        """Test running exploits filtered by category."""
        test_run = await exploit_runner.run_test(
            name="ssrf-test",
            categories=[ExploitCategory.SSRF],
        )
        
        assert test_run.name == "ssrf-test"
        assert test_run.status == "completed"
        # Should only include SSRF exploits
        for result in test_run.results:
            exploit = exploit_runner.catalog.get_by_id(result.exploit_id)
            assert exploit.category == ExploitCategory.SSRF
    
    @pytest.mark.asyncio
    async def test_cleanup(self, exploit_runner):
        """Test cleanup functionality."""
        result = await exploit_runner.cleanup()
        
        assert "namespace" in result
        assert result["success"] is True


class TestExploitStatus:
    """Tests for ExploitStatus enum."""
    
    def test_status_values(self):
        """Test all status values are defined."""
        assert ExploitStatus.PENDING.value == "pending"
        assert ExploitStatus.RUNNING.value == "running"
        assert ExploitStatus.SUCCESS.value == "success"
        assert ExploitStatus.FAILED.value == "failed"
        assert ExploitStatus.BLOCKED.value == "blocked"
        assert ExploitStatus.TIMEOUT.value == "timeout"
        assert ExploitStatus.ERROR.value == "error"


class TestSeverityAndCategory:
    """Tests for severity and category enums."""
    
    def test_severity_values(self):
        """Test all severity levels."""
        assert ExploitSeverity.CRITICAL.value == "critical"
        assert ExploitSeverity.HIGH.value == "high"
        assert ExploitSeverity.MEDIUM.value == "medium"
        assert ExploitSeverity.LOW.value == "low"
        assert ExploitSeverity.INFO.value == "info"
    
    def test_category_values(self):
        """Test exploit categories."""
        assert ExploitCategory.SSRF.value == "ssrf"
        assert ExploitCategory.COMMAND_INJECTION.value == "command_injection"
        assert ExploitCategory.RBAC_ESCALATION.value == "rbac_escalation"
