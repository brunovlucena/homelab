# ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
#
#  üçΩÔ∏è K6 LOAD TEST - AGENT-RESTAURANT
#
#  Purpose: Stress test restaurant agents under concurrent load
#
#  Scenario: Simulate a busy dinner service with multiple tables
#  - Concurrent guest arrivals
#  - Multiple simultaneous orders
#  - Wine pairing requests
#  - Kitchen coordination
#
# ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
---
apiVersion: k6.io/v1alpha1
kind: TestRun
metadata:
  name: agent-restaurant-load
  namespace: agent-restaurant
  labels:
    app.kubernetes.io/name: agent-restaurant
    app.kubernetes.io/component: testing
    test-type: load
spec:
  parallelism: 3
  arguments: -o experimental-prometheus-rw
  script:
    configMap:
      name: agent-restaurant-load-test
      file: load-test.js
  runner:
    image: localhost:5001/k6:0.47.0
    env:
      - name: NAMESPACE
        value: "agent-restaurant"
      - name: HOST_URL
        value: "http://host-maximilian.agent-restaurant.svc.cluster.local"
      - name: WAITER_URL
        value: "http://waiter-pierre.agent-restaurant.svc.cluster.local"
      - name: SOMMELIER_URL
        value: "http://sommelier-isabella.agent-restaurant.svc.cluster.local"
      - name: CHEF_URL
        value: "http://chef-marco.agent-restaurant.svc.cluster.local"
      - name: K6_PROMETHEUS_RW_SERVER_URL
        value: "http://kube-prometheus-stack-prometheus.prometheus.svc.cluster.local:9090/api/v1/write"
      - name: K6_PROMETHEUS_RW_TREND_AS_NATIVE_HISTOGRAM
        value: "true"
    resources:
      limits:
        memory: 512Mi
        cpu: 500m
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: agent-restaurant-load-test
  namespace: agent-restaurant
  labels:
    app.kubernetes.io/name: agent-restaurant
    app.kubernetes.io/component: testing
    test-type: load
data:
  load-test.js: |
    import http from 'k6/http';
    import { check, group, sleep } from 'k6';
    import { Rate, Counter, Trend, Gauge } from 'k6/metrics';
    import { randomIntBetween } from 'https://jslib.k6.io/k6-utils/1.4.0/index.js';
    
    // Custom Metrics
    const guestArrivals = new Counter('restaurant_guest_arrivals');
    const ordersPlaced = new Counter('restaurant_orders_placed');
    const winePairings = new Counter('restaurant_wine_pairings');
    const dishesCooked = new Counter('restaurant_dishes_cooked');
    const successRate = new Rate('restaurant_success_rate');
    const responseTime = new Trend('restaurant_response_time_ms');
    const activeTables = new Gauge('restaurant_active_tables');
    
    // Error tracking
    const hostErrors = new Counter('restaurant_host_errors');
    const waiterErrors = new Counter('restaurant_waiter_errors');
    const sommelierErrors = new Counter('restaurant_sommelier_errors');
    const chefErrors = new Counter('restaurant_chef_errors');
    
    // Configuration
    const HOST_URL = __ENV.HOST_URL || 'http://host-maximilian.agent-restaurant.svc.cluster.local';
    const WAITER_URL = __ENV.WAITER_URL || 'http://waiter-pierre.agent-restaurant.svc.cluster.local';
    const SOMMELIER_URL = __ENV.SOMMELIER_URL || 'http://sommelier-isabella.agent-restaurant.svc.cluster.local';
    const CHEF_URL = __ENV.CHEF_URL || 'http://chef-marco.agent-restaurant.svc.cluster.local';
    
    // Menu items for realistic testing
    const MENU_ITEMS = [
      { dish: 'Risotto ai Porcini', price: 28, type: 'main' },
      { dish: 'Grilled Salmon', price: 32, type: 'main' },
      { dish: 'Beef Tenderloin', price: 45, type: 'main' },
      { dish: 'Truffle Pasta', price: 38, type: 'main' },
      { dish: 'Caprese Salad', price: 16, type: 'starter' },
      { dish: 'Burrata', price: 18, type: 'starter' },
      { dish: 'Tiramisu', price: 14, type: 'dessert' },
      { dish: 'Panna Cotta', price: 12, type: 'dessert' },
    ];
    
    export const options = {
      scenarios: {
        // Dinner rush simulation
        dinner_rush: {
          executor: 'ramping-vus',
          startVUs: 0,
          stages: [
            { duration: '30s', target: 5 },   // Early diners arrive
            { duration: '1m', target: 15 },   // Peak reservation time
            { duration: '2m', target: 25 },   // Full house
            { duration: '1m', target: 15 },   // Post-rush cooldown
            { duration: '30s', target: 0 },   // Restaurant closing
          ],
          gracefulRampDown: '10s',
        },
      },
      thresholds: {
        // Success rate should be at least 70% under load
        'restaurant_success_rate': ['rate>0.70'],
        // Response time P95 under 60s (LLM agents are slow)
        'restaurant_response_time_ms': ['p(95)<60000'],
        // Track error rates
        'restaurant_host_errors': ['count<50'],
        'restaurant_waiter_errors': ['count<50'],
        'http_req_failed': ['rate<0.30'],
      },
    };
    
    // CloudEvent helper
    function createCloudEvent(type, data, source = 'k6-load-test') {
      return {
        specversion: '1.0',
        id: `k6-${Date.now()}-${Math.random().toString(36).substring(7)}`,
        type: type,
        source: source,
        time: new Date().toISOString(),
        datacontenttype: 'application/json',
        data: data,
      };
    }
    
    function sendCloudEvent(url, event) {
      return http.post(url, JSON.stringify(event), {
        headers: {
          'Content-Type': 'application/cloudevents+json',
          'Ce-Type': event.type,
          'Ce-Source': event.source,
          'Ce-Id': event.id,
          'Ce-Specversion': '1.0',
        },
        timeout: '90s',
      });
    }
    
    function getRandomItems(count) {
      const items = [];
      for (let i = 0; i < count; i++) {
        const item = MENU_ITEMS[randomIntBetween(0, MENU_ITEMS.length - 1)];
        items.push({ dish: item.dish, price: item.price, type: item.type, quantity: 1, notes: '' });
      }
      return items;
    }
    
    export default function() {
      const tableId = `table-${__VU}`;
      const guestId = `guest-${Date.now()}-${__VU}`;
      const partySize = randomIntBetween(2, 6);
      
      activeTables.add(__VU);
      
      // 1. Guest Arrival - Host Agent
      group('üé© Guest Arrival', () => {
        const event = createCloudEvent('restaurant.guest.arriving', {
          guestId: guestId,
          partySize: partySize,
          reservationId: `res-${Date.now()}`,
          name: `K6 Guest ${__VU}`,
          preferences: ['quiet table'],
          isVip: Math.random() < 0.1, // 10% VIP chance
        }, '/k6-load/host');
        
        const res = sendCloudEvent(HOST_URL, event);
        responseTime.add(res.timings.duration, { agent: 'host', action: 'arrival' });
        guestArrivals.add(1);
        
        const success = check(res, {
          'host accepts guest': (r) => r.status >= 200 && r.status < 300,
        });
        
        successRate.add(success);
        if (!success) {
          hostErrors.add(1);
        }
      });
      
      sleep(randomIntBetween(1, 3));
      
      // 2. Menu Presentation - Waiter Agent
      group('üëî Menu Presentation', () => {
        const event = createCloudEvent('restaurant.guest.seated', {
          tableId: tableId,
          guestId: guestId,
          partySize: partySize,
          request: 'Please present the menu',
        }, '/k6-load/waiter');
        
        const res = sendCloudEvent(WAITER_URL, event);
        responseTime.add(res.timings.duration, { agent: 'waiter', action: 'menu' });
        
        const success = check(res, {
          'waiter presents menu': (r) => r.status >= 200 && r.status < 300,
        });
        
        successRate.add(success);
        if (!success) {
          waiterErrors.add(1);
        }
      });
      
      sleep(randomIntBetween(2, 4));
      
      // 3. Order with Wine Pairing - Sommelier Agent
      const orderItems = getRandomItems(partySize);
      const orderId = `order-${Date.now()}-${__VU}`;
      
      group('üç∑ Wine Pairing', () => {
        const event = createCloudEvent('restaurant.order.created', {
          tableId: tableId,
          orderId: orderId,
          items: orderItems,
          request: 'Suggest wine pairings for our order',
          budget: randomIntBetween(50, 200),
        }, '/k6-load/sommelier');
        
        const res = sendCloudEvent(SOMMELIER_URL, event);
        responseTime.add(res.timings.duration, { agent: 'sommelier', action: 'pairing' });
        winePairings.add(1);
        
        const success = check(res, {
          'sommelier suggests wine': (r) => r.status >= 200 && r.status < 300,
        });
        
        successRate.add(success);
        if (!success) {
          sommelierErrors.add(1);
        }
      });
      
      sleep(randomIntBetween(1, 2));
      
      // 4. Kitchen Order - Chef Agent
      group('üë®‚Äçüç≥ Kitchen Order', () => {
        const event = createCloudEvent('restaurant.order.created', {
          tableId: tableId,
          ticketId: `ticket-${Date.now()}`,
          items: orderItems,
          priority: Math.random() < 0.2 ? 'rush' : 'normal',
          specialInstructions: 'No allergies',
        }, '/k6-load/chef');
        
        const res = sendCloudEvent(CHEF_URL, event);
        responseTime.add(res.timings.duration, { agent: 'chef', action: 'cook' });
        ordersPlaced.add(1);
        dishesCooked.add(orderItems.length);
        
        const success = check(res, {
          'chef accepts order': (r) => r.status >= 200 && r.status < 300,
        });
        
        successRate.add(success);
        if (!success) {
          chefErrors.add(1);
        }
      });
      
      sleep(randomIntBetween(3, 6));
      
      activeTables.add(-1);
    }
    
    export function handleSummary(data) {
      const arrivals = data.metrics['restaurant_guest_arrivals'];
      const orders = data.metrics['restaurant_orders_placed'];
      const pairings = data.metrics['restaurant_wine_pairings'];
      const dishes = data.metrics['restaurant_dishes_cooked'];
      const success = data.metrics['restaurant_success_rate'];
      const response = data.metrics['restaurant_response_time_ms'];
      
      const arrivalsCount = arrivals && arrivals.values ? arrivals.values.count : 0;
      const ordersCount = orders && orders.values ? orders.values.count : 0;
      const pairingsCount = pairings && pairings.values ? pairings.values.count : 0;
      const dishesCount = dishes && dishes.values ? dishes.values.count : 0;
      const successRateVal = success && success.values ? success.values.rate : 0;
      const p95Response = response && response.values ? response.values['p(95)'] : 0;
      const avgResponse = response && response.values ? response.values.avg : 0;
      
      const passed = successRateVal >= 0.70;
      
      console.log('\n' + '‚ïê'.repeat(65));
      console.log('üçΩÔ∏è AGENT-RESTAURANT LOAD TEST RESULTS');
      console.log('‚ïê'.repeat(65));
      console.log('Status: ' + (passed ? '‚úÖ PASSED' : '‚ùå FAILED'));
      console.log('‚îÄ'.repeat(65));
      console.log('üìä SERVICE METRICS');
      console.log('   Guest Arrivals:     ' + arrivalsCount);
      console.log('   Orders Placed:      ' + ordersCount);
      console.log('   Wine Pairings:      ' + pairingsCount);
      console.log('   Dishes Prepared:    ' + dishesCount);
      console.log('‚îÄ'.repeat(65));
      console.log('‚ö° PERFORMANCE');
      console.log('   Success Rate:       ' + (successRateVal * 100).toFixed(1) + '%');
      console.log('   Avg Response Time:  ' + (avgResponse || 0).toFixed(0) + 'ms');
      console.log('   P95 Response Time:  ' + (p95Response || 0).toFixed(0) + 'ms');
      console.log('‚ïê'.repeat(65) + '\n');
      
      return {};
    }
