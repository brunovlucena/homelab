---
# Job to create restaurant-redis and restaurant-postgres secrets
# These secrets are required by waiter-pierre and other restaurant agents
apiVersion: batch/v1
kind: Job
metadata:
  name: restaurant-secrets-init
  namespace: ai
  labels:
    app: agent-restaurant
    component: secret-init
  annotations:
    kustomize.toolkit.fluxcd.io/prune: disabled
spec:
  backoffLimit: 3
  ttlSecondsAfterFinished: 86400
  template:
    metadata:
      labels:
        app: agent-restaurant
        component: secret-init
    spec:
      serviceAccountName: restaurant-secret-init
      restartPolicy: Never
      containers:
      - name: init
        image: localhost:5001/kubectl:v1.34.0
        imagePullPolicy: IfNotPresent
        command:
        - /bin/bash
        - -c
        - |
          set -euo pipefail

          echo "ğŸ” Creating restaurant secrets..."

          # Create restaurant-redis secret
          # Secret must be in 'ai' namespace where restaurant LambdaAgents run
          REDIS_URL="redis://redis.redis.svc.cluster.local:6379"
          kubectl create secret generic restaurant-redis \
            --from-literal=url="${REDIS_URL}" \
            --namespace=ai \
            --dry-run=client -o yaml | kubectl apply -f -
          echo "âœ… Created restaurant-redis secret"

          # Create restaurant-postgres secret
          # Use homepage postgres connection (or create dedicated DB later)
          # Secret must be in 'ai' namespace where restaurant LambdaAgents run
          POSTGRES_URL="postgresql://postgres:$(kubectl get secret homepage -n flux-system -o jsonpath='{.data.homepage-postgres-password}' | base64 -d)@postgres.postgres.svc.cluster.local:5432/homepage?sslmode=disable"
          kubectl create secret generic restaurant-postgres \
            --from-literal=url="${POSTGRES_URL}" \
            --namespace=ai \
            --dry-run=client -o yaml | kubectl apply -f -
          echo "âœ… Created restaurant-postgres secret"

          echo "âœ… All restaurant secrets created successfully"
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: restaurant-secret-init
  namespace: ai
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: restaurant-secret-init
rules:
- apiGroups: [""]
  resources: ["secrets"]
  verbs: ["get", "list", "create", "update", "patch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: restaurant-secret-init
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: restaurant-secret-init
subjects:
- kind: ServiceAccount
  name: restaurant-secret-init
  namespace: ai
