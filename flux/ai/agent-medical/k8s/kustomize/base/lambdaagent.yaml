# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
#
#  ğŸ¥ Medical Records Agent - HIPAA-Compliant AI Agent
#
#  Handles medical record queries with RBAC, audit logging, and patient data isolation
#
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
---
apiVersion: lambda.knative.io/v1alpha1
kind: LambdaAgent
metadata:
  name: agent-medical
  namespace: ai
  labels:
    app.kubernetes.io/name: agent-medical
    app.kubernetes.io/component: service
    app.kubernetes.io/part-of: homelab
    medical.agent.type: records
  annotations:
    description: "HIPAA-compliant AI agent for medical records management"
spec:
  serviceAccountName: agent-medical-sa

  image:
    repository: ghcr.io/brunovlucena/medical-agent
    tag: "1.1.1"
    port: 8080

  ai:
    provider: ollama
    endpoint: "http://ollama-native.ollama.svc.cluster.local:11434"
    model: "llama3.2:3b"
    maxTokens: 2048
    temperature: "0.7"

  # Operation mode: agentic (autonomous) or supervised (requires approval)
  operationMode: agentic  # Default: autonomous execution

  behavior:
    maxContextMessages: 20
    emitEvents: true
    systemPrompt: |
      You are a medical records assistant with access to patient records.
      
      Your responsibilities:
      - Answer questions about patient medical records
      - Provide lab results, prescriptions, and medical history
      - Check for drug interactions
      - Analyze medical data
      - Maintain patient privacy and confidentiality
      
      Important guidelines:
      - Always verify patient access before providing information
      - Use medical terminology accurately
      - Be concise but thorough
      - Flag any concerning patterns or anomalies
      - Never share patient information without proper authorization
      
      You have access to:
      - Patient medical records
      - Lab results
      - Prescriptions
      - Medical history
      - Drug interaction database
      
      Respond in a professional, empathetic manner while maintaining accuracy.

  scaling:
    minReplicas: 0
    maxReplicas: 10
    targetConcurrency: 5
    scaleToZeroGracePeriod: 300s

  resources:
    requests:
      cpu: "250m"
      memory: "512Mi"
    limits:
      cpu: "1000m"
      memory: "2Gi"

  env:
    - name: AGENT_NAME
      value: "agent-medical"
    - name: HIPAA_MODE
      value: "true"
    - name: EVENT_SOURCE
      value: "/agent-medical/records"
    - name: MONGODB_URL
      valueFrom:
        secretKeyRef:
          name: medical-db-credentials
          key: url
    - name: MONGODB_DATABASE
      value: "medical_db"
    - name: VAULT_ADDR
      value: "http://vault.vault.svc.cluster.local:8200"
    - name: VLLM_URL
      value: "http://vllm.ml-inference.svc.forge.remote:8000"

  eventing:
    enabled: true
    eventSource: "/agent-medical/records"
    
    intents:
      - medical.query
      - medical.lab.request
      - medical.prescription.request
      - medical.history.request
      - medical.analyze.request
    
    subscriptions:
      - eventType: io.homelab.medical.query
        description: "Medical record query"
      - eventType: io.homelab.medical.lab.request
        description: "Lab results request"
      - eventType: io.homelab.medical.prescription.request
        description: "Prescription request"
      - eventType: io.homelab.medical.history.request
        description: "Medical history request"
      - eventType: io.homelab.medical.analyze.request
        description: "Medical analysis request"

    dlq:
      enabled: true
      retryMaxAttempts: 3

    rabbitmq:
      clusterName: rabbitmq-cluster-knative-lambda
      namespace: knative-lambda

  observability:
    tracing:
      enabled: true
      endpoint: alloy.observability.svc:4317
    metrics:
      enabled: true
    logging:
      level: info
      format: json

  permissions:
    disableBrokerCreation: true
    disableTriggerCreation: true
    disableFunctionCreation: true
