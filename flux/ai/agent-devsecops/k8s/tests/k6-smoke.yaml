# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
#
#  ğŸ” K6 SMOKE TEST - AGENT-DEVSECOPS
#
#  Purpose: Quick validation that DevSecOps agent is healthy and responding
#
#  Tests:
#    âœ“ Health endpoint
#    âœ“ Ready endpoint  
#    âœ“ Metrics endpoint
#    âœ“ Security status query
#    âœ“ Vulnerability summary query
#    âœ“ Compliance status query
#
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
---
apiVersion: k6.io/v1alpha1
kind: TestRun
metadata:
  name: agent-devsecops-smoke
  namespace: agent-devsecops
  labels:
    app.kubernetes.io/name: agent-devsecops
    app.kubernetes.io/component: testing
    test-type: smoke
spec:
  parallelism: 1
  arguments: -o experimental-prometheus-rw
  script:
    configMap:
      name: agent-devsecops-smoke-test
      file: smoke-test.js
  runner:
    image: localhost:5001/k6:0.47.0
    env:
      - name: DEVSECOPS_URL
        value: "http://agent-devsecops.agent-devsecops.svc.cluster.local"
      - name: NAMESPACE
        value: "agent-devsecops"
      - name: K6_PROMETHEUS_RW_SERVER_URL
        value: "http://kube-prometheus-stack-prometheus.prometheus.svc.cluster.local:9090/api/v1/write"
      - name: K6_PROMETHEUS_RW_TREND_AS_NATIVE_HISTOGRAM
        value: "true"
    resources:
      limits:
        memory: 256Mi
        cpu: 200m
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: agent-devsecops-smoke-test
  namespace: agent-devsecops
  labels:
    app.kubernetes.io/name: agent-devsecops
    app.kubernetes.io/component: testing
    test-type: smoke
data:
  smoke-test.js: |
    import http from 'k6/http';
    import { check, group, sleep } from 'k6';
    import { Rate, Counter, Trend } from 'k6/metrics';
    
    // Custom Metrics
    const healthSuccess = new Rate('devsecops_health_success');
    const querySuccess = new Rate('devsecops_query_success');
    const responseTime = new Trend('devsecops_response_time_ms');
    const agentErrors = new Counter('devsecops_errors');
    
    // Configuration
    const DEVSECOPS_URL = __ENV.DEVSECOPS_URL || 'http://agent-devsecops.agent-devsecops.svc.cluster.local';
    
    export const options = {
      scenarios: {
        smoke: {
          executor: 'constant-vus',
          vus: 1,
          duration: '60s',
        },
      },
      thresholds: {
        'devsecops_health_success': ['rate>0.95'],
        'devsecops_query_success': ['rate>0.80'],
        'devsecops_response_time_ms': ['p(95)<5000'],
        'http_req_failed': ['rate<0.1'],
      },
    };
    
    // CloudEvent helper
    function createCloudEvent(type, data, source = 'k6-smoke-test') {
      return {
        specversion: '1.0',
        id: `k6-${Date.now()}-${Math.random().toString(36).substring(7)}`,
        type: type,
        source: source,
        time: new Date().toISOString(),
        datacontenttype: 'application/json',
        data: data,
      };
    }
    
    function sendCloudEvent(url, event) {
      return http.post(url, JSON.stringify(event), {
        headers: {
          'Content-Type': 'application/cloudevents+json',
          'Ce-Type': event.type,
          'Ce-Source': event.source,
          'Ce-Id': event.id,
          'Ce-Specversion': '1.0',
        },
        timeout: '30s',
      });
    }
    
    export default function() {
      // Test 1: Health Endpoint
      group('ğŸ¥ Health Check', () => {
        const res = http.get(`${DEVSECOPS_URL}/health`);
        responseTime.add(res.timings.duration, { endpoint: 'health' });
        
        const success = check(res, {
          'health returns 2xx': (r) => r.status >= 200 && r.status < 300,
          'health returns healthy': (r) => {
            try {
              const body = JSON.parse(r.body);
              return body.status === 'healthy' || body.healthy === true;
            } catch (e) {
              return r.status === 200;
            }
          },
        });
        
        healthSuccess.add(success);
        if (!success) agentErrors.add(1, { type: 'health' });
      });
      
      sleep(1);
      
      // Test 2: Ready Endpoint
      group('âœ… Readiness Check', () => {
        const res = http.get(`${DEVSECOPS_URL}/ready`);
        responseTime.add(res.timings.duration, { endpoint: 'ready' });
        
        const success = check(res, {
          'ready returns 2xx': (r) => r.status >= 200 && r.status < 300,
        });
        
        healthSuccess.add(success);
        if (!success) agentErrors.add(1, { type: 'ready' });
      });
      
      sleep(1);
      
      // Test 3: Metrics Endpoint
      group('ğŸ“Š Metrics Endpoint', () => {
        const res = http.get(`${DEVSECOPS_URL}/metrics`);
        responseTime.add(res.timings.duration, { endpoint: 'metrics' });
        
        const success = check(res, {
          'metrics returns 2xx': (r) => r.status >= 200 && r.status < 300,
          'metrics has prometheus format': (r) => r.body && (r.body.includes('# HELP') || r.body.includes('# TYPE') || r.body.includes('# No metrics')),
        });
        
        // Metrics endpoint is now implemented in v0.2.0+
        if (!success) agentErrors.add(1, { type: 'metrics' });
      });
      
      sleep(1);
      
      // Test 4: Security Status Query
      group('ğŸ”’ Security Status Query', () => {
        const event = createCloudEvent('io.homelab.agent.security.query', {
          query_type: 'status',
        }, '/k6-test/devsecops');
        
        const res = sendCloudEvent(DEVSECOPS_URL, event);
        responseTime.add(res.timings.duration, { endpoint: 'security-status' });
        
        const success = check(res, {
          'security status returns 2xx': (r) => r.status >= 200 && r.status < 300,
          'security status has data': (r) => {
            try {
              const body = JSON.parse(r.body);
              return body.status !== undefined || body.rbac_level !== undefined;
            } catch (e) {
              return r.status === 200;
            }
          },
        });
        
        querySuccess.add(success);
        if (!success) {
          agentErrors.add(1, { type: 'security-status' });
          console.error(`Security status failed: ${res.status} - ${res.body}`);
        }
      });
      
      sleep(1);
      
      // Test 5: Vulnerability Summary Query
      group('ğŸ›¡ï¸ Vulnerability Summary', () => {
        const event = createCloudEvent('io.homelab.agent.security.query', {
          query_type: 'vulnerabilities',
        }, '/k6-test/devsecops');
        
        const res = sendCloudEvent(DEVSECOPS_URL, event);
        responseTime.add(res.timings.duration, { endpoint: 'vulnerabilities' });
        
        const success = check(res, {
          'vulnerability summary returns 2xx': (r) => r.status >= 200 && r.status < 300,
        });
        
        querySuccess.add(success);
        if (!success) {
          agentErrors.add(1, { type: 'vulnerabilities' });
          console.error(`Vulnerability summary failed: ${res.status} - ${res.body}`);
        }
      });
      
      sleep(1);
      
      // Test 6: Compliance Status Query
      group('ğŸ“‹ Compliance Status', () => {
        const event = createCloudEvent('io.homelab.agent.security.query', {
          query_type: 'compliance',
        }, '/k6-test/devsecops');
        
        const res = sendCloudEvent(DEVSECOPS_URL, event);
        responseTime.add(res.timings.duration, { endpoint: 'compliance' });
        
        const success = check(res, {
          'compliance status returns 2xx': (r) => r.status >= 200 && r.status < 300,
        });
        
        querySuccess.add(success);
        if (!success) {
          agentErrors.add(1, { type: 'compliance' });
          console.error(`Compliance status failed: ${res.status} - ${res.body}`);
        }
      });
      
      sleep(2);
    }
    
    export function handleSummary(data) {
      const healthMetric = data.metrics['devsecops_health_success'];
      const queryMetric = data.metrics['devsecops_query_success'];
      const responseMetric = data.metrics['devsecops_response_time_ms'];
      
      const healthRate = healthMetric && healthMetric.values ? healthMetric.values.rate : 0;
      const queryRate = queryMetric && queryMetric.values ? queryMetric.values.rate : 0;
      const p95Response = responseMetric && responseMetric.values ? responseMetric.values['p(95)'] : 0;
      
      const passed = healthRate >= 0.95 && queryRate >= 0.80;
      
      console.log('\n' + 'â•'.repeat(60));
      console.log('ğŸ” AGENT-DEVSECOPS SMOKE TEST RESULTS');
      console.log('â•'.repeat(60));
      console.log('Status: ' + (passed ? 'âœ… PASSED' : 'âŒ FAILED'));
      console.log('â”€'.repeat(60));
      console.log('ğŸ¥ Health Checks:      ' + (healthRate * 100).toFixed(1) + '%');
      console.log('ğŸ”’ Security Queries:   ' + (queryRate * 100).toFixed(1) + '%');
      console.log('â”€'.repeat(60));
      console.log('P95 Response Time: ' + (p95Response || 0).toFixed(0) + 'ms');
      console.log('â•'.repeat(60) + '\n');
      
      return {};
    }
