---
# Job to create medical-service-secrets
# This secret is required by medical-service-platform for MongoDB, Redis, and JWT
apiVersion: batch/v1
kind: Job
metadata:
  name: medical-service-secrets-init
  namespace: medical-service-platform
  labels:
    app: medical-service
    component: secret-init
  annotations:
    kustomize.toolkit.fluxcd.io/prune: disabled
spec:
  backoffLimit: 3
  ttlSecondsAfterFinished: 86400
  template:
    metadata:
      labels:
        app: medical-service
        component: secret-init
    spec:
      serviceAccountName: medical-service-secret-init
      restartPolicy: Never
      containers:
      - name: init
        image: localhost:5001/kubectl:v1.34.0
        imagePullPolicy: IfNotPresent
        command:
        - /bin/bash
        - -c
        - |
          set -euo pipefail

          echo "ðŸ” Creating medical-service secrets..."

          # Try to get MongoDB credentials from homelab-services-secrets
          # If not available, use default connection without auth
          MONGODB_USERNAME=$(kubectl get secret homelab-services-secrets -n homelab-services -o jsonpath="{.data.mongodb-username}" 2>/dev/null | base64 -d || echo "")
          MONGODB_PASSWORD=$(kubectl get secret homelab-services-secrets -n homelab-services -o jsonpath="{.data.mongodb-password}" 2>/dev/null | base64 -d || echo "")
          
          if [ -n "${MONGODB_USERNAME}" ] && [ -n "${MONGODB_PASSWORD}" ]; then
            MONGODB_URI="mongodb://${MONGODB_USERNAME}:${MONGODB_PASSWORD}@mongodb.homelab-services.svc.cluster.local:27017/medical_service"
          else
            MONGODB_URI="mongodb://mongodb.homelab-services.svc.cluster.local:27017/medical_service"
          fi

          # Try to get JWT secret from homelab-services-secrets, otherwise generate one
          JWT_SECRET=$(kubectl get secret homelab-services-secrets -n homelab-services -o jsonpath="{.data.jwt-secret}" 2>/dev/null | base64 -d || openssl rand -hex 32)

          # Create medical-service-secrets secret
          kubectl create secret generic medical-service-secrets \
            --from-literal=mongodb-uri="${MONGODB_URI}" \
            --from-literal=redis-uri="redis://redis.homelab-services.svc.cluster.local:6379" \
            --from-literal=jwt-secret="${JWT_SECRET}" \
            --namespace=medical-service-platform \
            --dry-run=client -o yaml | kubectl apply -f -
          echo "âœ… Created medical-service-secrets secret"

          echo "âœ… All medical-service secrets created successfully"
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: medical-service-secret-init
  namespace: medical-service-platform
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: medical-service-secret-init
rules:
- apiGroups: [""]
  resources: ["secrets"]
  verbs: ["get", "list", "create", "update", "patch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: medical-service-secret-init
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: medical-service-secret-init
subjects:
- kind: ServiceAccount
  name: medical-service-secret-init
  namespace: medical-service-platform
