apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: bruno-site-rules
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "homepage.labels" . | nindent 4 }}
    app.kubernetes.io/component: monitoring
    prometheus: kube-prometheus
    role: alert-rules
spec:
  groups:
  # =============================================================================
  # 🚨 CRITICAL ALERTS - IMMEDIATE ATTENTION REQUIRED
  # =============================================================================
  - name: homepage.critical
    rules:
    - alert: BrunoSiteAPIDown
      expr: up{job="bruno-site-api"} == 0
      for: 1m
      labels:
        severity: critical
        service: api
        component: bruno-site
      annotations:
        summary: "Bruno Site API is down"
        description: "Bruno Site API has been down for more than 1 minute. This affects all site functionality."
        runbook_url: "https://github.com/brunovlucena/bruno-site/docs/runbooks/api-down.md"
        
    - alert: BrunoSiteDatabaseDown
      expr: up{job="bruno-site-postgres"} == 0
      for: 1m
      labels:
        severity: critical
        service: database
        component: bruno-site
      annotations:
        summary: "Bruno Site Database is down"
        description: "PostgreSQL database has been down for more than 1 minute. All data operations are failing."
        runbook_url: "https://github.com/brunovlucena/bruno-site/docs/runbooks/database-down.md"
        
    - alert: BrunoSiteRedisDown
      expr: up{job="bruno-site-redis"} == 0
      for: 2m
      labels:
        severity: critical
        service: redis
        component: bruno-site
      annotations:
        summary: "Bruno Site Redis is down"
        description: "Redis cache has been down for more than 2 minutes. Session management and caching are affected."
        runbook_url: "https://github.com/brunovlucena/bruno-site/docs/runbooks/redis-down.md"

    - alert: BrunoSiteHighErrorRate
      expr: rate(http_requests_total{job="bruno-site-api",code=~"5.."}[5m]) / rate(http_requests_total{job="bruno-site-api"}[5m]) > 0.05
      for: 2m
      labels:
        severity: critical
        service: api
        component: bruno-site
      annotations:
        summary: "Bruno Site API high error rate"
        description: "Bruno Site API error rate is {{`{{ $value }}`}} for the last 5 minutes."
        runbook_url: "https://github.com/brunovlucena/bruno-site/docs/runbooks/high-error-rate.md"

    - alert: BrunoSiteDatabaseConnectionFailure
      expr: increase(pg_stat_database_deadlocks{job="bruno-site-postgres"}[5m]) > 10
      for: 1m
      labels:
        severity: critical
        service: database
        component: bruno-site
      annotations:
        summary: "Bruno Site Database connection issues"
        description: "PostgreSQL database has {{`{{ $value }}`}} deadlocks in the last 5 minutes."
        runbook_url: "https://github.com/brunovlucena/bruno-site/docs/runbooks/database-connection-issues.md"

    - alert: BrunoSiteExperienceDataLoadFailure
      expr: rate(bruno_site_experience_load_errors_total{error_type="database_query_error"}[5m]) > 0.1
      for: 2m
      labels:
        severity: critical
        service: api
        component: bruno-site
        data_type: experience
      annotations:
        summary: "Bruno Site experience data loading is failing"
        description: "Experience data API is failing with {{`{{ $value }}`}} errors per second for the last 5 minutes. Users cannot view resume/experience page."
        runbook_url: "https://github.com/brunovlucena/bruno-site/docs/runbooks/experience-data-load-failure.md"

    - alert: BrunoSiteExperienceDataHighErrorRate
      expr: |
        (rate(bruno_site_experience_load_errors_total[5m]) / 
        (rate(bruno_site_experience_load_errors_total[5m]) + rate(bruno_site_experience_load_success_total[5m]))) > 0.5
      for: 3m
      labels:
        severity: critical
        service: api
        component: bruno-site
        data_type: experience
      annotations:
        summary: "Bruno Site experience data has high error rate"
        description: "Experience data error rate is {{`{{ $value | humanizePercentage }}`}} for the last 5 minutes. This affects the resume page display."
        runbook_url: "https://github.com/brunovlucena/bruno-site/docs/runbooks/experience-data-high-error-rate.md"

  # =============================================================================
  # ⚠️ WARNING ALERTS - ATTENTION NEEDED SOON
  # =============================================================================
  - name: homepage.warning
    rules:
    - alert: BrunoSiteHighResponseTime
      expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket{job="bruno-site-api"}[5m])) > 1
      for: 5m
      labels:
        severity: warning
        service: api
        component: bruno-site
      annotations:
        summary: "Bruno Site API high response time"
        description: "Bruno Site API 95th percentile response time is {{`{{ $value }}`}}s for the last 5 minutes."
        runbook_url: "https://github.com/brunovlucena/bruno-site/docs/runbooks/high-response-time.md"

    - alert: BrunoSiteHighCPUUsage
      expr: rate(container_cpu_usage_seconds_total{pod=~"bruno-site-api-.*"}[5m]) > 0.8
      for: 5m
      labels:
        severity: warning
        service: api
        component: bruno-site
      annotations:
        summary: "Bruno Site API high CPU usage"
        description: "Bruno Site API CPU usage is {{`{{ $value }}`}} for the last 5 minutes."
        runbook_url: "https://github.com/brunovlucena/bruno-site/docs/runbooks/high-cpu-usage.md"

    - alert: BrunoSiteHighMemoryUsage
      expr: container_memory_usage_bytes{pod=~"bruno-site-api-.*"} / container_spec_memory_limit_bytes{pod=~"bruno-site-api-.*"} > 0.9
      for: 5m
      labels:
        severity: warning
        service: api
        component: bruno-site
      annotations:
        summary: "Bruno Site API high memory usage"
        description: "Bruno Site API memory usage is {{`{{ $value }}`}} of limit for the last 5 minutes."
        runbook_url: "https://github.com/brunovlucena/bruno-site/docs/runbooks/high-memory-usage.md"

    - alert: BrunoSiteDatabaseSlowQueries
      expr: rate(pg_stat_database_tup_returned{job="bruno-site-postgres"}[5m]) / rate(pg_stat_database_tup_fetched{job="bruno-site-postgres"}[5m]) < 0.1
      for: 10m
      labels:
        severity: warning
        service: database
        component: bruno-site
      annotations:
        summary: "Bruno Site Database slow queries detected"
        description: "PostgreSQL database shows inefficient query patterns with low tuple return ratio."
        runbook_url: "https://github.com/brunovlucena/bruno-site/docs/runbooks/database-slow-queries.md"

    - alert: BrunoSiteRedisHighMemoryUsage
      expr: redis_memory_used_bytes{job="bruno-site-redis"} / redis_config_maxmemory_bytes{job="bruno-site-redis"} > 0.8
      for: 5m
      labels:
        severity: warning
        service: redis
        component: bruno-site
      annotations:
        summary: "Bruno Site Redis high memory usage"
        description: "Redis memory usage is {{`{{ $value }}`}} of max memory for the last 5 minutes."
        runbook_url: "https://github.com/brunovlucena/bruno-site/docs/runbooks/redis-high-memory.md"

    - alert: BrunoSiteExperienceDataSlowLoad
      expr: histogram_quantile(0.95, rate(bruno_site_experience_load_duration_seconds_bucket[5m])) > 0.5
      for: 5m
      labels:
        severity: warning
        service: api
        component: bruno-site
        data_type: experience
      annotations:
        summary: "Bruno Site experience data loading is slow"
        description: "Experience data 95th percentile load time is {{`{{ $value }}`}}s for the last 5 minutes. Expected < 0.5s."
        runbook_url: "https://github.com/brunovlucena/bruno-site/docs/runbooks/experience-data-slow-load.md"

    - alert: BrunoSiteExperienceDatabaseUnavailable
      expr: increase(bruno_site_experience_load_errors_total{error_type="database_unavailable"}[5m]) > 5
      for: 1m
      labels:
        severity: warning
        service: database
        component: bruno-site
        data_type: experience
      annotations:
        summary: "Bruno Site database unavailable for experience data"
        description: "Database is unavailable for experience data loading with {{`{{ $value }}`}} errors in the last 5 minutes."
        runbook_url: "https://github.com/brunovlucena/bruno-site/docs/runbooks/experience-database-unavailable.md"

    - alert: BrunoSiteLLMServiceDown
      expr: up{job="bruno-site-ollama"} == 0
      for: 5m
      labels:
        severity: warning
        service: llm
        component: bruno-site
      annotations:
        summary: "Bruno Site LLM service is down"
        description: "Ollama LLM service has been down for more than 5 minutes. AI chat functionality is affected."
        runbook_url: "https://github.com/brunovlucena/bruno-site/docs/runbooks/llm-service-down.md"

  # =============================================================================
  # 📊 BUSINESS LOGIC ALERTS - APPLICATION SPECIFIC
  # =============================================================================
  - name: homepage.business
    rules:
    - alert: BrunoSiteProjectsLoadFailed
      expr: rate(bruno_site_projects_load_errors_total[5m]) > 0.01
      for: 2m
      labels:
        severity: critical
        service: api
        component: bruno-site
        feature: projects
      annotations:
        summary: "Bruno Site failed to load projects"
        description: "Failed to load projects from database with {{`{{ $value | printf \"%.2f\" }}`}} errors per second for the last 5 minutes. Error type: {{`{{ $labels.error_type }}`}}"
        impact: "Critical - Homepage cannot display projects, affecting user experience"
        runbook_url: "https://github.com/brunovlucena/bruno-site/docs/runbooks/projects-load-failed.md"
        action: "1. Check database connectivity\n2. Verify database schema\n3. Review application logs\n4. Check for database locks or deadlocks"

    - alert: BrunoSiteProjectsLoadSlowQueries
      expr: histogram_quantile(0.95, rate(bruno_site_projects_load_duration_seconds_bucket[5m])) > 1.0
      for: 5m
      labels:
        severity: warning
        service: api
        component: bruno-site
        feature: projects
      annotations:
        summary: "Bruno Site projects loading slowly"
        description: "Projects load time 95th percentile is {{`{{ $value | printf \"%.2f\" }}`}}s, which is above 1s threshold."
        impact: "Medium - Slow page load times affecting user experience"
        runbook_url: "https://github.com/brunovlucena/bruno-site/docs/runbooks/projects-slow-load.md"
        action: "1. Check database performance\n2. Review query execution plans\n3. Consider adding indexes\n4. Check for N+1 query issues"

    - alert: BrunoSiteHighProjectViewErrors
      expr: rate(http_requests_total{job="bruno-site-api",handler="/api/projects",code=~"4..|5.."}[10m]) > 0.1
      for: 5m
      labels:
        severity: warning
        service: api
        component: bruno-site
        feature: projects
      annotations:
        summary: "Bruno Site high project view errors"
        description: "Project viewing functionality has {{`{{ $value }}`}} errors per second for the last 10 minutes."
        runbook_url: "https://github.com/brunovlucena/bruno-site/docs/runbooks/project-errors.md"

    - alert: BrunoSiteChatAPIErrors
      expr: rate(http_requests_total{job="bruno-site-api",handler="/api/chat",code=~"4..|5.."}[10m]) > 0.05
      for: 5m
      labels:
        severity: warning
        service: api
        component: bruno-site
        feature: chat
      annotations:
        summary: "Bruno Site chat API errors"
        description: "AI chat functionality has {{`{{ $value }}`}} errors per second for the last 10 minutes."
        runbook_url: "https://github.com/brunovlucena/bruno-site/docs/runbooks/chat-errors.md"

    - alert: BrunoSiteHighAnalyticsLoad
      expr: rate(http_requests_total{job="bruno-site-api",handler="/api/analytics/track"}[5m]) > 10
      for: 10m
      labels:
        severity: info
        service: api
        component: bruno-site
        feature: analytics
      annotations:
        summary: "Bruno Site high analytics load"
        description: "Analytics tracking is receiving {{`{{ $value }}`}} requests per second for the last 5 minutes."
        runbook_url: "https://github.com/brunovlucena/bruno-site/docs/runbooks/high-analytics-load.md"

  # =============================================================================
  # 🔧 INFRASTRUCTURE ALERTS - KUBERNETES & RESOURCES
  # =============================================================================
  - name: homepage.infrastructure
    rules:
    - alert: BrunoSitePodCrashLooping
      expr: rate(kube_pod_container_status_restarts_total{pod=~"bruno-site-.*"}[15m]) > 0
      for: 5m
      labels:
        severity: critical
        service: kubernetes
        component: bruno-site
      annotations:
        summary: "Bruno Site pod is crash looping"
        description: "Pod {{`{{ $labels.pod }}`}} in namespace {{`{{ $labels.namespace }}`}} is crash looping with {{`{{ $value }}`}} restarts in the last 15 minutes."
        runbook_url: "https://github.com/brunovlucena/bruno-site/docs/runbooks/pod-crash-loop.md"

    - alert: BrunoSitePodNotReady
      expr: kube_pod_status_phase{pod=~"bruno-site-.*",phase!="Running"} == 1
      for: 5m
      labels:
        severity: warning
        service: kubernetes
        component: bruno-site
      annotations:
        summary: "Bruno Site pod is not ready"
        description: "Pod {{`{{ $labels.pod }}`}} in namespace {{`{{ $labels.namespace }}`}} is in {{`{{ $labels.phase }}`}} state for more than 5 minutes."
        runbook_url: "https://github.com/brunovlucena/bruno-site/docs/runbooks/pod-not-ready.md"

    - alert: BrunoSiteHPAHighReplicas
      expr: kube_horizontalpodautoscaler_status_current_replicas{horizontalpodautoscaler=~"bruno-site-.*"} > 8
      for: 10m
      labels:
        severity: warning
        service: kubernetes
        component: bruno-site
      annotations:
        summary: "Bruno Site HPA scaling to high replica count"
        description: "HPA {{`{{ $labels.horizontalpodautoscaler }}`}} has scaled to {{`{{ $value }}`}} replicas for more than 10 minutes."
        runbook_url: "https://github.com/brunovlucena/bruno-site/docs/runbooks/hpa-high-replicas.md"

    - alert: BrunoSiteStorageSpaceLow
      expr: (kubelet_volume_stats_available_bytes{pod=~"bruno-site-.*"} / kubelet_volume_stats_capacity_bytes{pod=~"bruno-site-.*"}) < 0.1
      for: 5m
      labels:
        severity: warning
        service: storage
        component: bruno-site
      annotations:
        summary: "Bruno Site storage space is low"
        description: "Pod {{`{{ $labels.pod }}`}} has only {{`{{ $value }}`}} storage space remaining."
        runbook_url: "https://github.com/brunovlucena/bruno-site/docs/runbooks/storage-space-low.md"

  # =============================================================================
  # 🔒 SECURITY ALERTS - SECURITY MONITORING
  # =============================================================================
  - name: homepage.security
    rules:
    - alert: BrunoSiteHighRateLimitHits
      expr: rate(http_requests_total{job="bruno-site-api",code="429"}[5m]) > 0.1
      for: 5m
      labels:
        severity: warning
        service: api
        component: bruno-site
        security: rate-limiting
      annotations:
        summary: "Bruno Site high rate limit hits"
        description: "Bruno Site API is hitting rate limits with {{`{{ $value }}`}} requests per second for the last 5 minutes."
        runbook_url: "https://github.com/brunovlucena/bruno-site/docs/runbooks/rate-limit-hits.md"

    - alert: BrunoSiteSuspiciousActivity
      expr: rate(http_requests_total{job="bruno-site-api",code=~"4.."}[5m]) > 5
      for: 10m
      labels:
        severity: warning
        service: api
        component: bruno-site
        security: suspicious-activity
      annotations:
        summary: "Bruno Site suspicious activity detected"
        description: "Bruno Site API is receiving {{`{{ $value }}`}} 4xx errors per second for the last 5 minutes, indicating potential suspicious activity."
        runbook_url: "https://github.com/brunovlucena/bruno-site/docs/runbooks/suspicious-activity.md"

    - alert: BrunoSiteSQLInjectionAttempts
      expr: increase(http_requests_total{job="bruno-site-api",handler="/api",code="400"}[10m]) > 20
      for: 5m
      labels:
        severity: warning
        service: api
        component: bruno-site
        security: sql-injection
      annotations:
        summary: "Bruno Site potential SQL injection attempts"
        description: "Bruno Site API has received {{`{{ $value }}`}} 400 errors in the last 10 minutes, potentially indicating SQL injection attempts."
        runbook_url: "https://github.com/brunovlucena/bruno-site/docs/runbooks/sql-injection-attempts.md"

  # =============================================================================
  # 👥 VISITOR TRACKING ALERTS - TRAFFIC MONITORING & ABUSE DETECTION
  # =============================================================================
  - name: homepage.visitors
    rules:
    # ==================== CRITICAL: ABUSE DETECTION ====================
    
    - alert: BrunoSiteAbuseHighRequestRate
      expr: |
        sum by (namespace, service) (
          rate(http_requests_total{
            namespace="bruno",
            path!="/metrics",
            path!="/health"
          }[1m])
        ) > 10
      for: 2m
      labels:
        severity: critical
        service: api
        component: bruno-site
        security: abuse
        type: rate-abuse
      annotations:
        summary: "🚨 ABUSE DETECTED: Extremely high request rate"
        description: "Bruno Site is receiving {{`{{ $value | printf \"%.2f\" }}`}} requests per second from visitors. This may indicate a DDoS attack, scraping bot, or abuse."
        impact: "High - May degrade service performance or increase costs"
        runbook_url: "https://github.com/brunovlucena/bruno-site/docs/runbooks/abuse-high-rate.md"
        action: "1. Check logs for source IPs\n2. Review CloudFlare firewall rules\n3. Consider rate limiting or blocking suspicious IPs"

    - alert: BrunoSiteAbuseRepeatedErrors
      expr: |
        sum by (namespace, status_code) (
          rate(http_requests_total{
            namespace="bruno",
            status_code=~"4..",
            path!="/metrics",
            path!="/health"
          }[5m])
        ) > 2
      for: 5m
      labels:
        severity: critical
        service: api
        component: bruno-site
        security: abuse
        type: error-abuse
      annotations:
        summary: "🚨 ABUSE DETECTED: High rate of 4xx errors"
        description: "Bruno Site is receiving {{`{{ $value | printf \"%.2f\" }}`}} 4xx errors per second. This may indicate scanning, brute force attempts, or malicious probing."
        impact: "High - Potential security threat or resource exhaustion"
        runbook_url: "https://github.com/brunovlucena/bruno-site/docs/runbooks/abuse-repeated-errors.md"
        action: "1. Identify attacking IPs in logs\n2. Enable CloudFlare challenge mode\n3. Block malicious sources"

    - alert: BrunoSiteAbuseSuspiciousPattern
      expr: |
        (
          sum(rate(http_requests_total{namespace="bruno", path=~"/api/.*", path!="/metrics", path!="/health"}[1m]))
          /
          sum(rate(http_requests_total{namespace="bruno", path="/", path!="/metrics", path!="/health"}[1m]))
        ) > 50
      for: 5m
      labels:
        severity: critical
        service: api
        component: bruno-site
        security: abuse
        type: api-scraping
      annotations:
        summary: "🚨 ABUSE DETECTED: API scraping pattern detected"
        description: "Ratio of API requests to homepage views is {{`{{ $value | printf \"%.2f\" }}`}}:1. This suggests automated scraping rather than normal user behavior."
        impact: "Medium - Database and API load, potential data extraction"
        runbook_url: "https://github.com/brunovlucena/bruno-site/docs/runbooks/abuse-api-scraping.md"
        action: "1. Review API access patterns\n2. Implement API authentication\n3. Add rate limiting per endpoint"

    - alert: BrunoSiteAbuseExcessiveBandwidth
      expr: |
        sum by (namespace) (
          rate(http_request_size_bytes_sum{
            namespace="bruno",
            path!="/metrics",
            path!="/health"
          }[5m])
        ) > 10485760
      for: 5m
      labels:
        severity: critical
        service: api
        component: bruno-site
        security: abuse
        type: bandwidth-abuse
      annotations:
        summary: "🚨 ABUSE DETECTED: Excessive bandwidth consumption"
        description: "Bruno Site is serving {{`{{ $value | humanize1024 }}`}}B/s of traffic. This may indicate asset downloading/scraping."
        impact: "High - Increased bandwidth costs and potential service degradation"
        runbook_url: "https://github.com/brunovlucena/bruno-site/docs/runbooks/abuse-bandwidth.md"
        action: "1. Check which assets are being requested\n2. Enable CloudFlare caching\n3. Block abusive sources"

    # ==================== WARNING: VISITOR THRESHOLDS ====================
    
    - alert: BrunoSiteVisitorsModerateTraffic
      expr: |
        sum(increase(http_requests_total{
          namespace="bruno",
          container="bruno-site-frontend",
          path="/",
          status_code="200"
        }[24h])) >= 10 and
        sum(increase(http_requests_total{
          namespace="bruno",
          container="bruno-site-frontend",
          path="/",
          status_code="200"
        }[24h])) < 100
      for: 30m
      labels:
        severity: warning
        service: frontend
        component: bruno-site
        feature: visitor-tracking
        threshold: moderate
      annotations:
        summary: "👥 Moderate visitor traffic: 10-100 visitors today"
        description: "Bruno Site has received {{`{{ $value | printf \"%.0f\" }}`}} unique page views in the last 24 hours. Traffic is moderate."
        impact: "None - Normal traffic levels"
        dashboard_url: "https://grafana.lucena.cloud/d/bruno-visitors"
        action: "Monitor traffic patterns for optimization opportunities"

    - alert: BrunoSiteVisitorsHighTraffic
      expr: |
        sum(increase(http_requests_total{
          namespace="bruno",
          container="bruno-site-frontend",
          path="/",
          status_code="200"
        }[24h])) >= 100
      for: 30m
      labels:
        severity: warning
        service: frontend
        component: bruno-site
        feature: visitor-tracking
        threshold: high
      annotations:
        summary: "🎉 High visitor traffic: 100+ visitors today!"
        description: "Bruno Site has received {{`{{ $value | printf \"%.0f\" }}`}} unique page views in the last 24 hours. This is excellent traffic!"
        impact: "Positive - High engagement, monitor for scaling needs"
        dashboard_url: "https://grafana.lucena.cloud/d/bruno-visitors"
        action: "1. Celebrate! 🎉\n2. Check HPA is scaling appropriately\n3. Review analytics for traffic sources\n4. Consider caching strategies"

    - alert: BrunoSiteVisitorsLowTraffic
      expr: |
        sum(increase(http_requests_total{
          namespace="bruno",
          container="bruno-site-frontend",
          path="/",
          status_code="200"
        }[24h])) < 10
      for: 12h
      labels:
        severity: info
        service: frontend
        component: bruno-site
        feature: visitor-tracking
        threshold: low
      annotations:
        summary: "📉 Low visitor traffic: Less than 10 visitors today"
        description: "Bruno Site has received only {{`{{ $value | printf \"%.0f\" }}`}} page views in the last 24 hours."
        impact: "None - Informational only"
        dashboard_url: "https://grafana.lucena.cloud/d/bruno-visitors"
        action: "Consider SEO optimization or marketing activities"

    # ==================== VISITOR ENGAGEMENT METRICS ====================
    
    - alert: BrunoSiteHighBounceRate
      expr: |
        (
          sum(increase(http_requests_total{namespace="bruno", path="/", status_code="200"}[1h]))
          -
          sum(increase(http_requests_total{namespace="bruno", path=~"/api/.*|/resume|/projects", status_code="200"}[1h]))
        )
        /
        sum(increase(http_requests_total{namespace="bruno", path="/", status_code="200"}[1h]))
        > 0.7
      for: 1h
      labels:
        severity: info
        service: frontend
        component: bruno-site
        feature: visitor-engagement
      annotations:
        summary: "📊 High bounce rate detected"
        description: "{{`{{ $value | printf \"%.0f\" }}`}}% of visitors are leaving without viewing additional pages in the last hour."
        impact: "Low - May indicate UX issues or irrelevant traffic"
        dashboard_url: "https://grafana.lucena.cloud/d/bruno-visitors"
        action: "1. Review landing page content\n2. Check page load times\n3. Analyze traffic sources"

    - alert: BrunoSiteResumePagePopular
      expr: |
        sum(increase(http_requests_total{
          namespace="bruno",
          path="/resume",
          status_code="200"
        }[1h])) > 5
      for: 30m
      labels:
        severity: info
        service: frontend
        component: bruno-site
        feature: visitor-engagement
      annotations:
        summary: "📄 Resume page is popular"
        description: "The resume page has received {{`{{ $value | printf \"%.0f\" }}`}} views in the last hour. Job recruiters may be viewing your profile!"
        impact: "Positive - Potential job opportunities"
        dashboard_url: "https://grafana.lucena.cloud/d/bruno-visitors"
        action: "Ensure resume content is up-to-date"

    # ==================== VISITOR SOURCE ANALYSIS ====================
    
    - alert: BrunoSiteBotTrafficDetected
      expr: |
        sum(rate(http_requests_total{
          namespace="bruno",
          path="/robots.txt",
          status_code="200"
        }[5m])) > 0.1
      for: 10m
      labels:
        severity: info
        service: frontend
        component: bruno-site
        feature: bot-detection
      annotations:
        summary: "🤖 Bot/Crawler traffic detected"
        description: "Search engine bots or crawlers are accessing your site at {{`{{ $value | printf \"%.2f\" }}`}} requests per second."
        impact: "Positive - SEO indexing activity"
        dashboard_url: "https://grafana.lucena.cloud/d/bruno-visitors"
        action: "Monitor for legitimate vs malicious bots"

  # =============================================================================
  # 📈 PERFORMANCE ALERTS - PERFORMANCE MONITORING
  # =============================================================================
  - name: homepage.performance
    rules:
    - alert: BrunoSiteSlowDatabaseQueries
      expr: histogram_quantile(0.95, rate(pg_stat_database_tup_fetched{job="bruno-site-postgres"}[5m])) > 1000
      for: 10m
      labels:
        severity: warning
        service: database
        component: bruno-site
        performance: slow-queries
      annotations:
        summary: "Bruno Site slow database queries"
        description: "PostgreSQL database 95th percentile query performance is {{`{{ $value }}`}} tuples fetched per second for the last 5 minutes."
        runbook_url: "https://github.com/brunovlucena/bruno-site/docs/runbooks/slow-database-queries.md"

    - alert: BrunoSiteHighConnectionPoolUsage
      expr: pg_stat_database_numbackends{job="bruno-site-postgres"} / pg_settings_max_connections{job="bruno-site-postgres"} > 0.8
      for: 5m
      labels:
        severity: warning
        service: database
        component: bruno-site
        performance: connection-pool
      annotations:
        summary: "Bruno Site high database connection pool usage"
        description: "PostgreSQL connection pool usage is {{`{{ $value }}`}} for the last 5 minutes."
        runbook_url: "https://github.com/brunovlucena/bruno-site/docs/runbooks/high-connection-pool-usage.md"

    - alert: BrunoSiteRedisSlowOperations
      expr: rate(redis_commands_duration_seconds_total{job="bruno-site-redis"}[5m]) > 0.1
      for: 5m
      labels:
        severity: warning
        service: redis
        component: bruno-site
        performance: slow-operations
      annotations:
        summary: "Bruno Site Redis slow operations"
        description: "Redis operations are taking {{`{{ $value }}`}} seconds on average for the last 5 minutes."
        runbook_url: "https://github.com/brunovlucena/bruno-site/docs/runbooks/redis-slow-operations.md"

  # =============================================================================
  # 🎯 AVAILABILITY ALERTS - UPTIME MONITORING
  # =============================================================================
  - name: homepage.availability
    rules:
    - alert: BrunoSiteLowAvailability
      expr: (rate(http_requests_total{job="bruno-site-api",code=~"2.."}[1h]) / rate(http_requests_total{job="bruno-site-api"}[1h])) < 0.99
      for: 15m
      labels:
        severity: critical
        service: api
        component: bruno-site
        availability: uptime
      annotations:
        summary: "Bruno Site low availability"
        description: "Bruno Site API availability is {{`{{ $value }}`}} for the last hour, below 99% threshold."
        runbook_url: "https://github.com/brunovlucena/bruno-site/docs/runbooks/low-availability.md"

    - alert: BrunoSiteHealthCheckFailures
      expr: rate(http_requests_total{job="bruno-site-api",handler="/health",code!="200"}[5m]) > 0
      for: 2m
      labels:
        severity: critical
        service: api
        component: bruno-site
        availability: health-checks
      annotations:
        summary: "Bruno Site health check failures"
        description: "Bruno Site API health checks are failing with {{`{{ $value }}`}} failures per second for the last 5 minutes."
        runbook_url: "https://github.com/brunovlucena/bruno-site/docs/runbooks/health-check-failures.md"
