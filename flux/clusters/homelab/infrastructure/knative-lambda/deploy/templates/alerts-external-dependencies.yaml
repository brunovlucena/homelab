apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: knative-lambda-external-dependencies-alerts
  namespace: knative-lambda-{{ .Values.environment }}
  labels:
    release: "prometheus"
    app: "knative-lambda"
    component: "alerts"
    environment: {{ .Values.environment }}
spec:
  groups:
  - name: knative-lambda.external-dependencies
    rules:
    - alert: KnativeLambdaECRErrors
      expr: |
        rate(knative_lambda_ecr_operations_total{status="error"}[5m]) > 0.1
      for: 5m
      labels:
        severity: warning
        service: knative-lambda-builder
        component: external-dependencies
        team: platform
        environment: {{ .Values.environment }}
      annotations:
        summary: "Knative Lambda ECR operation errors"
        description: "Knative Lambda ECR operation error rate is {{ `{{ $value | printf \"%.2f\" }}` }} errors/sec over the last 5 minutes."
        runbook_url: "https://runbooks.notifi.network/knative/lambda/ecr-errors"
        dashboard_url: "https://grafana.notifi.network/d/knative-lambda-builder-{{ .Values.environment }}/knative-lambda-builder-dashboard-{{ .Values.environment }}"

    - alert: KnativeLambdaS3Errors
      expr: |
        rate(knative_lambda_s3_operations_total{status="error"}[5m]) > 0.1
      for: 5m
      labels:
        severity: warning
        service: knative-lambda-builder
        component: external-dependencies
        team: platform
        environment: {{ .Values.environment }}
      annotations:
        summary: "Knative Lambda S3 operation errors"
        description: "Knative Lambda S3 operation error rate is {{ `{{ $value | printf \"%.2f\" }}` }} errors/sec over the last 5 minutes."
        runbook_url: "https://runbooks.notifi.network/knative/lambda/s3-errors"
        dashboard_url: "https://grafana.notifi.network/d/knative-lambda-builder-{{ .Values.environment }}/knative-lambda-builder-dashboard-{{ .Values.environment }}"

    - alert: KnativeLambdaK8sErrors
      expr: |
        rate(knative_lambda_k8s_operations_total{status="error"}[5m]) > 0.1
      for: 5m
      labels:
        severity: warning
        service: knative-lambda-builder
        component: external-dependencies
        team: platform
        environment: {{ .Values.environment }}
      annotations:
        summary: "Knative Lambda Kubernetes operation errors"
        description: "Knative Lambda Kubernetes operation error rate is {{ `{{ $value | printf \"%.2f\" }}` }} errors/sec over the last 5 minutes."
        runbook_url: "https://runbooks.notifi.network/knative/lambda/k8s-errors"
        dashboard_url: "https://grafana.notifi.network/d/knative-lambda-builder-{{ .Values.environment }}/knative-lambda-builder-dashboard-{{ .Values.environment }}" 