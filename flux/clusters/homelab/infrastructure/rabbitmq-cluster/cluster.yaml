apiVersion: rabbitmq.com/v1beta1
kind: RabbitmqCluster
metadata:
  name: rabbitmq-cluster
  namespace: rabbitmq-cluster
  labels:
    app: rabbitmq
    app.kubernetes.io/name: rabbitmq-cluster
  annotations:
    rabbitmq.com/topology-allowed-namespaces: "knative-lambda,knative-eventing,rabbitmq-cluster"
spec:
  # 🔢 Cluster Configuration
  replicas: 1
  
  # 🐳 RabbitMQ Image
  image: rabbitmq:3.12-management-alpine
  
  # 🎯 Tolerations for knative nodes
  tolerations:
    - key: "knative"
      operator: Equal
      value: "true"
      effect: NoSchedule
  
  # 💾 Persistence Configuration
  persistence:
    storageClassName: "standard"
    storage: 1Gi
  
  # 🔧 Resource Configuration
  resources:
    requests:
      cpu: "100m"
      memory: "512Mi"
    limits:
      cpu: "500m"
      memory: "512Mi"
  
  # ⚙️ RabbitMQ Configuration
  rabbitmq:
    additionalPlugins:
      - rabbitmq_management
    additionalConfig: |
      # Absolute memory limit for containers (per RabbitMQ docs)
      vm_memory_high_watermark.absolute = 256MiB
      total_memory_available_override_value = 536870912
      
      # Container-optimized settings with reduced disk requirements
      disk_free_limit.absolute = 200MB
      heartbeat = 60
      collect_statistics = none
      
      # Erlang VM optimizations for containers
      vm_memory_calculation_strategy = allocated

