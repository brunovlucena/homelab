apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: postgres
  namespace: postgres
spec:
  interval: 5m
  timeout: 10m
  chart:
    spec:
      chart: postgresql
      version: "16.4.4"
      sourceRef:
        kind: HelmRepository
        name: postgres
        namespace: flux-system
  values:
    # üêò PostgreSQL Configuration
    architecture: standalone
    
    auth:
      enabled: false  # Internal service, no auth needed
      # For production, enable auth and use secrets:
      # enabled: true
      # username: postgres
      # database: postgres
      # existingSecret: postgres-secret
    
    primary:
      persistence:
        enabled: true
        storageClass: standard
        size: 20Gi
      resources:
        requests:
          cpu: 200m
          memory: 512Mi
        limits:
          cpu: 1000m
          memory: 2Gi
      # üîß PostgreSQL Configuration
      extendedConfiguration: |-
        # Connection settings
        max_connections = 200
        shared_buffers = 256MB
        
        # Write-Ahead Log
        wal_level = replica
        max_wal_size = 1GB
        min_wal_size = 80MB
        
        # Query tuning
        effective_cache_size = 1GB
        random_page_cost = 1.1
        
        # Performance
        work_mem = 4MB
        maintenance_work_mem = 64MB
        
        # Logging
        log_min_duration_statement = 1000
        log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '
        log_timezone = 'UTC'
      # üì° Service Configuration
      service:
        type: ClusterIP
        ports:
          postgresql: 5432
    
    # üìä Metrics for Prometheus
    metrics:
      enabled: true
      serviceMonitor:
        enabled: true
        namespace: postgres
      resources:
        requests:
          cpu: 50m
          memory: 64Mi
        limits:
          cpu: 100m
          memory: 128Mi
