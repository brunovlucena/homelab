---
apiVersion: batch/v1
kind: Job
metadata:
  name: loki-minio-bucket-init
  namespace: loki
  annotations:
    # This job creates the required MinIO buckets for Loki
    helm.toolkit.fluxcd.io/driftDetection: disabled
spec:
  ttlSecondsAfterFinished: 300
  template:
    spec:
      restartPolicy: OnFailure
      initContainers:
        # Wait for MinIO to be ready
        - name: wait-for-minio
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              echo "Waiting for MinIO to be ready..."
              until wget -q -O- http://loki-minio:9000/minio/health/ready; do
                echo "MinIO not ready yet, waiting..."
                sleep 5
              done
              echo "MinIO is ready!"
      containers:
        - name: create-buckets
          image: minio/mc:RELEASE.2024-10-08T09-37-26Z
          env:
            - name: MINIO_ENDPOINT
              value: "http://loki-minio:9000"
            - name: MINIO_ACCESS_KEY
              value: "root-user"
            - name: MINIO_SECRET_KEY
              value: "supersecretpassword"
          command:
            - sh
            - -c
            - |
              set -e
              
              echo "📦 Configuring MinIO client..."
              mc alias set minio ${MINIO_ENDPOINT} ${MINIO_ACCESS_KEY} ${MINIO_SECRET_KEY}
              
              echo "🔍 Checking existing buckets..."
              mc ls minio || true
              
              # Create chunks bucket if it doesn't exist
              if mc ls minio/chunks > /dev/null 2>&1; then
                echo "✅ Bucket 'chunks' already exists"
              else
                echo "📦 Creating bucket 'chunks'..."
                mc mb minio/chunks
                echo "✅ Bucket 'chunks' created successfully"
              fi
              
              # Create ruler bucket if it doesn't exist
              if mc ls minio/ruler > /dev/null 2>&1; then
                echo "✅ Bucket 'ruler' already exists"
              else
                echo "📦 Creating bucket 'ruler'..."
                mc mb minio/ruler
                echo "✅ Bucket 'ruler' created successfully"
              fi
              
              # Create loki bucket if it doesn't exist (legacy, might not be needed)
              if mc ls minio/loki > /dev/null 2>&1; then
                echo "✅ Bucket 'loki' already exists"
              else
                echo "📦 Creating bucket 'loki'..."
                mc mb minio/loki
                echo "✅ Bucket 'loki' created successfully"
              fi
              
              echo "🎉 All required buckets are ready!"
              mc ls minio

