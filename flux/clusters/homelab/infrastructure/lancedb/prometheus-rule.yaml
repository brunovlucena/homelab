---
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: lancedb-alerts
  namespace: lancedb
  labels:
    app: lancedb
    prometheus: kube-prometheus
spec:
  groups:
  - name: lancedb
    interval: 30s
    rules:
    # ðŸ”´ LanceDB is down
    - alert: LanceDBDown
      expr: up{job="lancedb"} == 0
      for: 5m
      labels:
        severity: critical
        component: lancedb
      annotations:
        summary: "LanceDB is down"
        description: "LanceDB has been down for more than 5 minutes"
        runbook_url: "https://github.com/brunolucena/homelab/blob/main/runbooks/lancedb/lancedb-down.md"
    
    # ðŸŸ  LanceDB high memory usage
    - alert: LanceDBHighMemoryUsage
      expr: |
        (container_memory_working_set_bytes{namespace="lancedb",pod=~"lancedb-.*"}
        / container_spec_memory_limit_bytes{namespace="lancedb",pod=~"lancedb-.*"}) > 0.85
      for: 10m
      labels:
        severity: warning
        component: lancedb
      annotations:
        summary: "LanceDB high memory usage"
        description: "LanceDB memory usage is above 85% for more than 10 minutes"
        runbook_url: "https://github.com/brunolucena/homelab/blob/main/runbooks/lancedb/high-memory-usage.md"
    
    # ðŸŸ  LanceDB high CPU usage
    - alert: LanceDBHighCPUUsage
      expr: |
        (rate(container_cpu_usage_seconds_total{namespace="lancedb",pod=~"lancedb-.*"}[5m])
        / container_spec_cpu_quota{namespace="lancedb",pod=~"lancedb-.*"} * 100000) > 85
      for: 10m
      labels:
        severity: warning
        component: lancedb
      annotations:
        summary: "LanceDB high CPU usage"
        description: "LanceDB CPU usage is above 85% for more than 10 minutes"
        runbook_url: "https://github.com/brunolucena/homelab/blob/main/runbooks/lancedb/high-cpu-usage.md"
    
    # ðŸ”´ LanceDB pod crash looping
    - alert: LanceDBPodCrashLooping
      expr: |
        rate(kube_pod_container_status_restarts_total{namespace="lancedb",pod=~"lancedb-.*"}[15m]) > 0
      for: 5m
      labels:
        severity: critical
        component: lancedb
      annotations:
        summary: "LanceDB pod is crash looping"
        description: "LanceDB pod has restarted multiple times in the last 15 minutes"
        runbook_url: "https://github.com/brunolucena/homelab/blob/main/runbooks/lancedb/pod-crash-loop.md"
    
    # ðŸŸ¡ LanceDB PVC almost full
    - alert: LanceDBPVCAlmostFull
      expr: |
        (kubelet_volume_stats_used_bytes{namespace="lancedb",persistentvolumeclaim="lancedb-pvc"}
        / kubelet_volume_stats_capacity_bytes{namespace="lancedb",persistentvolumeclaim="lancedb-pvc"}) > 0.85
      for: 10m
      labels:
        severity: warning
        component: lancedb
      annotations:
        summary: "LanceDB PVC is almost full"
        description: "LanceDB persistent volume is more than 85% full"
        runbook_url: "https://github.com/brunolucena/homelab/blob/main/runbooks/lancedb/pvc-almost-full.md"

