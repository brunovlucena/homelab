---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: scylladb
  namespace: scylladb
spec:
  interval: 5m
  timeout: 15m
  chart:
    spec:
      chart: scylladb
      version: 5.0.5
      sourceRef:
        kind: HelmRepository
        name: bitnami
        namespace: flux-system
  values:
    # 🌟 Global configuration
    global:
      storageClass: "standard"
    
    # 📊 Cluster configuration
    cluster:
      # Start with 1 node for homelab, can scale up to 3
      replicaCount: 1
      datacenter: "homelab-dc1"
      rack: "rack1"
    
    # 🚀 ScyllaDB configuration
    scylladb:
      # Developer mode - reduces resource requirements
      developerMode: true
      
      # 🔌 Alternator (DynamoDB API) - This is the key feature!
      alternator:
        enabled: true
        port: 8000
        writeIsolation: "only_rmw_uses_lwt"
        # Alternator settings for DynamoDB compatibility
        options: ""
      
      # CQL (Cassandra API)
      cqlPort: 9042
      
      # JMX for monitoring
      jmxPort: 7199
      
      # Additional ScyllaDB configuration
      extraFlags:
        - "--smp 1"
        - "--memory 2G"
        - "--overprovisioned"
    
    # 💾 Persistence
    persistence:
      enabled: true
      storageClass: "standard"
      size: 20Gi
      accessModes:
        - ReadWriteOnce
    
    # 🎯 Resources - Optimized for homelab
    resources:
      requests:
        memory: "2Gi"
        cpu: "500m"
      limits:
        memory: "4Gi"
        cpu: "2000m"
    
    # 🔍 Service configuration
    service:
      type: ClusterIP
      ports:
        # CQL port (Cassandra protocol)
        cql: 9042
        # Alternator port (DynamoDB protocol)
        alternator: 8000
    
    # 📈 Metrics and monitoring
    # ServiceMonitor disabled due to duplicate label bug in chart
    metrics:
      enabled: true
      serviceMonitor:
        enabled: false
    
    # 🏥 Health checks
    livenessProbe:
      enabled: true
      initialDelaySeconds: 60
      periodSeconds: 10
      timeoutSeconds: 5
      failureThreshold: 5
    
    readinessProbe:
      enabled: true
      initialDelaySeconds: 30
      periodSeconds: 10
      timeoutSeconds: 5
      failureThreshold: 3
    
    # 🔐 Security context
    securityContext:
      enabled: false
      fsGroup: 1001
      runAsUser: 1001
    
    # 🎛️ Pod Management Policy
    podManagementPolicy: "Parallel"

