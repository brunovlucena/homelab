---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: localstack
  namespace: localstack
spec:
  interval: 5m
  timeout: 10m
  chart:
    spec:
      chart: localstack
      version: 0.6.14
      sourceRef:
        kind: HelmRepository
        name: localstack
        namespace: flux-system
  values:
    # Enable debug mode for more verbose logging
    debug: true
    
    # Configure services
    # Leave empty to enable all services (community edition)
    # Or specify: SERVICES: "s3,dynamodb,sns,sqs,lambda"
    extraEnvVars:
      - name: SERVICES
        value: "dynamodb,s3,sns,sqs,lambda,kinesis,cloudwatch,logs,events"
      - name: DEBUG
        value: "1"
      - name: PERSISTENCE
        value: "1"
      - name: DATA_DIR
        value: "/tmp/localstack/data"
      # DynamoDB specific settings
      - name: DYNAMODB_SHARE_DB
        value: "1"
      - name: DYNAMODB_IN_MEMORY
        value: "0"
    
    # Service configuration
    service:
      type: ClusterIP
      annotations:
        prometheus.io/scrape: "false"
    
    # Enable persistence for data
    persistence:
      enabled: true
      storageClass: "standard"
      accessModes:
        - ReadWriteOnce
      size: 10Gi
      mountPath: /tmp/localstack
    
    # Resource limits
    resources:
      requests:
        memory: "512Mi"
        cpu: "250m"
      limits:
        memory: "2Gi"
        cpu: "1000m"
    
    # Liveness and readiness probes
    livenessProbe:
      enabled: true
      initialDelaySeconds: 30
      periodSeconds: 10
      timeoutSeconds: 5
      failureThreshold: 3
    
    readinessProbe:
      enabled: true
      initialDelaySeconds: 10
      periodSeconds: 5
      timeoutSeconds: 3
      failureThreshold: 3
    
    # Single replica (LocalStack doesn't support horizontal scaling in community edition)
    replicaCount: 1
    
    # Pod annotations
    podAnnotations:
      prometheus.io/scrape: "false"

