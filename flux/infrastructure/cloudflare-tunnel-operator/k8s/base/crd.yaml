---
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# CloudflareTunnelIngress CRD
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# Defines a service to expose via Cloudflare Tunnel
# The operator watches these CRs and updates the tunnel configuration
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: cloudflaretunnelingresses.tunnel.cloudflare.io
  labels:
    app: cloudflare-tunnel-operator
spec:
  group: tunnel.cloudflare.io
  names:
    kind: CloudflareTunnelIngress
    listKind: CloudflareTunnelIngressList
    plural: cloudflaretunnelingresses
    singular: cloudflaretunnelingress
    shortNames:
      - cfti
      - cftunnel
  scope: Namespaced
  versions:
    - name: v1alpha1
      served: true
      storage: true
      schema:
        openAPIV3Schema:
          type: object
          description: CloudflareTunnelIngress exposes a Kubernetes service via Cloudflare Tunnel
          properties:
            apiVersion:
              type: string
            kind:
              type: string
            metadata:
              type: object
            spec:
              type: object
              required:
                - hostname
                - service
              properties:
                hostname:
                  type: string
                  description: The hostname to expose (e.g., grafana.lucena.cloud)
                service:
                  type: object
                  required:
                    - name
                  properties:
                    name:
                      type: string
                      description: Name of the Kubernetes service to expose
                    namespace:
                      type: string
                      description: Namespace of the service (defaults to CR namespace)
                    port:
                      type: integer
                      description: Port of the service (defaults to first port)
                      minimum: 1
                      maximum: 65535
                    protocol:
                      type: string
                      description: Protocol to use (http or https)
                      enum:
                        - http
                        - https
                      default: http
                syncInterval:
                  type: string
                  description: Interval to check and sync the tunnel configuration
                  default: "5m"
                  pattern: ^[0-9]+(s|m|h)$
                enabled:
                  type: boolean
                  description: Whether this ingress is enabled
                  default: true
            status:
              type: object
              properties:
                phase:
                  type: string
                  description: Current phase of the ingress
                  enum:
                    - Pending
                    - Syncing
                    - Ready
                    - Failed
                lastSyncTime:
                  type: string
                  format: date-time
                  description: Last time the tunnel was synced
                currentEndpoint:
                  type: string
                  description: Current service endpoint in the tunnel
                message:
                  type: string
                  description: Human-readable status message
                observedGeneration:
                  type: integer
                  format: int64
                  description: The most recent generation observed
                conditions:
                  type: array
                  items:
                    type: object
                    properties:
                      type:
                        type: string
                      status:
                        type: string
                        enum:
                          - "True"
                          - "False"
                          - Unknown
                      lastTransitionTime:
                        type: string
                        format: date-time
                      reason:
                        type: string
                      message:
                        type: string
                      observedGeneration:
                        type: integer
                        format: int64
                        description: The generation observed by the condition controller
      subresources:
        status: {}
      additionalPrinterColumns:
        - name: Hostname
          type: string
          jsonPath: .spec.hostname
          description: Exposed hostname
        - name: Service
          type: string
          jsonPath: .spec.service.name
          description: Backend service name
        - name: Phase
          type: string
          jsonPath: .status.phase
          description: Current phase
        - name: Endpoint
          type: string
          jsonPath: .status.currentEndpoint
          description: Current tunnel endpoint
        - name: Age
          type: date
          jsonPath: .metadata.creationTimestamp
