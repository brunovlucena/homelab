# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
#
#  ğŸ” GHCR SECRET INIT JOB
#
#  Purpose: Creates ghcr-secret docker-registry secret from github-token
#           in flux-system namespace for pulling images from ghcr.io
#  This job ensures the imagePullSecret exists for ghcr.io private images
#
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
---
apiVersion: batch/v1
kind: Job
metadata:
  name: ghcr-secret-init
  namespace: knative-lambda
  labels:
    app.kubernetes.io/name: ghcr-secret-init
    app.kubernetes.io/component: bootstrap
    app.kubernetes.io/managed-by: knative-lambda-operator
  annotations:
    fluxcd.io/automation: "true"
spec:
  ttlSecondsAfterFinished: 300
  backoffLimit: 3
  template:
    metadata:
      labels:
        app.kubernetes.io/name: ghcr-secret-init
    spec:
      restartPolicy: OnFailure
      serviceAccountName: knative-lambda-operator
      containers:
        - name: create-secret
          image: localhost:5001/kubectl:v1.34.0
          command:
            - sh
            - -c
            - |
              set -e
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo "ğŸ” GHCR Secret Bootstrap"
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo ""
              
              SOURCE_NAMESPACE="flux-system"
              TARGET_NAMESPACE="knative-lambda"
              
              # Wait for flux-system namespace and github-token secret
              echo "â³ Waiting for github-token secret in ${SOURCE_NAMESPACE}..."
              until kubectl get secret github-token -n "${SOURCE_NAMESPACE}" &>/dev/null; do
                echo "   Secret not found, waiting..."
                sleep 2
              done
              echo "âœ… github-token secret found"
              
              echo ""
              echo "ğŸ“‹ Extracting GitHub token..."
              # Get token from password, token, or value key
              GITHUB_TOKEN=""
              for key in password token value; do
                GITHUB_TOKEN=$(kubectl get secret github-token -n "${SOURCE_NAMESPACE}" -o jsonpath="{.data.${key}}" 2>/dev/null | base64 -d)
                [ -n "${GITHUB_TOKEN}" ] && break
              done
              
              if [ -z "${GITHUB_TOKEN}" ]; then
                echo "âŒ Error: Could not extract token from github-token secret"
                exit 1
              fi
              echo "âœ… Token extracted"
              
              # Get username if available, otherwise use token as username
              GITHUB_USERNAME=$(kubectl get secret github-token -n "${SOURCE_NAMESPACE}" -o jsonpath="{.data.username}" 2>/dev/null | base64 -d)
              GITHUB_USERNAME="${GITHUB_USERNAME:-${GITHUB_TOKEN}}"
              
              echo ""
              echo "ğŸ“¤ Creating ghcr-secret in ${TARGET_NAMESPACE}..."
              kubectl create secret docker-registry ghcr-secret \
                --docker-server=ghcr.io \
                --docker-username="${GITHUB_USERNAME}" \
                --docker-password="${GITHUB_TOKEN}" \
                --namespace="${TARGET_NAMESPACE}" \
                --dry-run=client -o yaml | kubectl apply -f -
              
              echo ""
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo "âœ… ghcr-secret created successfully!"
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
