# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
#
#  ğŸ” MINIO SECRET INIT JOB
#
#  Purpose: Automatically copies minio-credentials secret from minio namespace
#           to knative-lambda namespace during bootstrapping
#  This job ensures the secret exists before any lambda builds start
#
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
---
apiVersion: batch/v1
kind: Job
metadata:
  name: minio-secret-init
  namespace: knative-lambda
  labels:
    app.kubernetes.io/name: minio-secret-init
    app.kubernetes.io/component: bootstrap
    app.kubernetes.io/managed-by: knative-lambda-operator
  annotations:
    # Ensure this job runs on every deployment
    fluxcd.io/automation: "true"
spec:
  ttlSecondsAfterFinished: 300
  backoffLimit: 3
  template:
    metadata:
      labels:
        app.kubernetes.io/name: minio-secret-init
    spec:
      restartPolicy: OnFailure
      serviceAccountName: knative-lambda-operator
      containers:
        - name: copy-secret
          image: localhost:5001/kubectl:v1.34.0
          command:
            - sh
            - -c
            - |
              set -e
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo "ğŸ” MinIO Secret Bootstrap"
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo ""
              
              # Wait for minio namespace and secret to exist
              echo "â³ Waiting for minio namespace..."
              until kubectl get namespace minio &>/dev/null; do
                echo "   MinIO namespace not found, waiting..."
                sleep 2
              done
              echo "âœ… MinIO namespace found"
              
              echo ""
              echo "â³ Waiting for minio-credentials secret in minio namespace..."
              until kubectl get secret minio-credentials -n minio &>/dev/null; do
                echo "   Secret not found, waiting..."
                sleep 2
              done
              echo "âœ… Secret found in minio namespace"
              
              echo ""
              echo "ğŸ“‹ Checking if secret exists in knative-lambda namespace..."
              if kubectl get secret minio-credentials -n knative-lambda &>/dev/null; then
                echo "âœ… Secret already exists in knative-lambda namespace"
                echo "   Verifying it's up to date..."
                
                # Check if we need to update (compare resourceVersion or just re-apply)
                kubectl get secret minio-credentials -n minio -o yaml | \
                  sed 's/namespace: minio/namespace: knative-lambda/' | \
                  sed '/^  uid:/d' | \
                  sed '/^  resourceVersion:/d' | \
                  sed '/^  creationTimestamp:/d' | \
                  kubectl apply -f -
                echo "âœ… Secret updated/verified"
              else
                echo "ğŸ“¤ Copying secret from minio namespace..."
                kubectl get secret minio-credentials -n minio -o yaml | \
                  sed 's/namespace: minio/namespace: knative-lambda/' | \
                  sed '/^  uid:/d' | \
                  sed '/^  resourceVersion:/d' | \
                  sed '/^  creationTimestamp:/d' | \
                  kubectl apply -f -
                echo "âœ… Secret copied successfully"
              fi
              
              echo ""
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo "âœ… MinIO secret bootstrap complete!"
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
