---
# ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
# Secret Sync Job - Copies Cloudflare credentials to controller namespace
# ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
# This job syncs the cloudflare secret from cloudflare-tunnel namespace
# to cloudflare-tunnel-ingress-controller namespace in the format expected
# by STRRL controller
apiVersion: batch/v1
kind: Job
metadata:
  name: cloudflare-secret-sync
  namespace: cloudflare-tunnel-ingress-controller
spec:
  template:
    spec:
      restartPolicy: OnFailure
      serviceAccountName: cloudflare-secret-sync
      containers:
      - name: sync
        image: bitnami/kubectl:latest
        command:
        - /bin/sh
        - -c
        - |
          set -e
          echo "üîÑ Syncing Cloudflare secret from cloudflare-tunnel namespace..."
          
          # Use cloudflare-api-token (API Token for STRRL) if available, otherwise fallback to cloudflare-api-key
          if kubectl get secret cloudflare -n cloudflare-tunnel -o jsonpath='{.data.cloudflare-api-token}' >/dev/null 2>&1; then
            API_TOKEN=$(kubectl get secret cloudflare -n cloudflare-tunnel -o jsonpath='{.data.cloudflare-api-token}' | base64 -d)
            echo "‚úÖ Using cloudflare-api-token"
          else
            API_TOKEN=$(kubectl get secret cloudflare -n cloudflare-tunnel -o jsonpath='{.data.cloudflare-api-key}' | base64 -d)
            echo "‚ö†Ô∏è  Using cloudflare-api-key (fallback - should use cloudflare-api-token)"
          fi
          
          # Account ID and tunnel name are known
          ACCOUNT_ID="a2862058e1cc276aa01de068d23f6e1f"
          TUNNEL_NAME="studio"
          
          # Create secret in the format expected by STRRL controller
          # STRRL uses api-token (which can be an API Key or API Token)
          kubectl create secret generic cloudflare-api \
            --from-literal=api-token="${API_TOKEN}" \
            --from-literal=account-id="${ACCOUNT_ID}" \
            --from-literal=tunnel-name="${TUNNEL_NAME}" \
            --dry-run=client -o yaml | kubectl apply -f -
          
          echo "‚úÖ Secret synced successfully using same credentials as cloudflare-tunnel-operator!"
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
              - ALL
          readOnlyRootFilesystem: true
          runAsNonRoot: true
          seccompProfile:
            type: RuntimeDefault
---
# ServiceAccount for secret sync job
apiVersion: v1
kind: ServiceAccount
metadata:
  name: cloudflare-secret-sync
  namespace: cloudflare-tunnel-ingress-controller
---
# RBAC for secret sync job
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: cloudflare-secret-sync
  namespace: cloudflare-tunnel-ingress-controller
rules:
- apiGroups: [""]
  resources: ["secrets"]
  verbs: ["get", "create", "update", "patch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: cloudflare-secret-sync-read
  namespace: cloudflare-tunnel
rules:
- apiGroups: [""]
  resources: ["secrets"]
  verbs: ["get"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: cloudflare-secret-sync
  namespace: cloudflare-tunnel-ingress-controller
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: cloudflare-secret-sync
subjects:
- kind: ServiceAccount
  name: cloudflare-secret-sync
  namespace: cloudflare-tunnel-ingress-controller
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: cloudflare-secret-sync-read
  namespace: cloudflare-tunnel
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: cloudflare-secret-sync-read
subjects:
- kind: ServiceAccount
  name: cloudflare-secret-sync
  namespace: cloudflare-tunnel-ingress-controller
