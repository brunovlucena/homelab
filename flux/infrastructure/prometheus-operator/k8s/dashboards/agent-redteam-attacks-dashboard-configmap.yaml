---
# Grafana Dashboard ConfigMap for Agent RedTeam Attack Monitoring
# This dashboard is automatically discovered by Grafana via the sidecar
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboard-agent-redteam-attacks
  namespace: prometheus
  labels:
    grafana_dashboard: "1"
    app.kubernetes.io/name: agent-redteam
    app.kubernetes.io/component: dashboard
    dashboard-type: security
  annotations:
    k8s-sidecar-target-directory: "Agents"
data:
  agent-redteam-attacks-dashboard.json: |-
    {
      "title": "Agent RedTeam - Attack Monitoring (v1) [s39]",
      "tags": ["agent-redteam", "security", "pentesting", "attacks", "exploits", "knative", "lambda"],
      "timezone": "browser",
      "schemaVersion": 39,
      "version": 1,
      "refresh": "10s",
      "uid": "agent-redteam-attacks",
      "editable": true,
      "graphTooltip": 1,
      "links": [
        {
          "asDropdown": true,
          "icon": "external link",
          "includeVars": true,
          "keepTime": true,
          "tags": ["knative", "lambda", "security"],
          "targetBlank": true,
          "title": "Related Dashboards",
          "type": "dashboards"
        },
        {
          "asDropdown": false,
          "icon": "dashboard",
          "includeVars": true,
          "keepTime": true,
          "targetBlank": true,
          "title": "RedTeam Health",
          "type": "link",
          "url": "/d/agent-redteam-health"
        }
      ],
      "liveNow": true,
      "templating": {
        "list": [
          {
            "name": "severity",
            "type": "query",
            "datasource": { "type": "prometheus", "uid": "prometheus" },
            "query": { "query": "label_values(agent_redteam_attacks_by_severity_total, severity)", "refId": "StandardVariableQuery" },
            "current": { "selected": true, "text": "All", "value": "$__all" },
            "includeAll": true,
            "multi": true,
            "allValue": ".*",
            "label": "Severity"
          },
          {
            "name": "category",
            "type": "query",
            "datasource": { "type": "prometheus", "uid": "prometheus" },
            "query": { "query": "label_values(agent_redteam_attacks_by_category_total, category)", "refId": "StandardVariableQuery" },
            "current": { "selected": true, "text": "All", "value": "$__all" },
            "includeAll": true,
            "multi": true,
            "allValue": ".*",
            "label": "Category"
          }
        ]
      },
      "annotations": {
        "list": [
          {
            "builtIn": 1,
            "datasource": { "type": "grafana", "uid": "-- Grafana --" },
            "enable": true,
            "hide": true,
            "iconColor": "rgba(0, 211, 255, 1)",
            "name": "Annotations & Alerts",
            "type": "dashboard"
          }
        ]
      },
      "panels": [
        {
          "type": "row",
          "title": "üéØ Attack Overview",
          "gridPos": { "h": 1, "w": 24, "x": 0, "y": 0 },
          "id": 1,
          "collapsed": false
        },
        {
          "type": "stat",
          "title": "Total Attacks (24h)",
          "gridPos": { "h": 4, "w": 4, "x": 0, "y": 1 },
          "id": 2,
          "datasource": { "type": "prometheus", "uid": "prometheus" },
          "fieldConfig": {
            "defaults": {
              "color": { "mode": "thresholds" },
              "thresholds": { "mode": "absolute", "steps": [{ "color": "blue", "value": null }] },
              "unit": "short"
            }
          },
          "options": { "colorMode": "value", "graphMode": "area", "reduceOptions": { "calcs": ["lastNotNull"] } },
          "targets": [{ "expr": "sum(increase(agent_redteam_exploits_executed_total{severity=~\"$severity\", category=~\"$category\"}[24h])) or vector(0)", "refId": "A" }]
        },
        {
          "type": "stat",
          "title": "üî¥ Successful Exploits",
          "gridPos": { "h": 4, "w": 4, "x": 4, "y": 1 },
          "id": 3,
          "datasource": { "type": "prometheus", "uid": "prometheus" },
          "fieldConfig": {
            "defaults": {
              "color": { "mode": "thresholds" },
              "thresholds": { "mode": "absolute", "steps": [{ "color": "green", "value": null }, { "color": "yellow", "value": 1 }, { "color": "red", "value": 5 }] },
              "unit": "short"
            }
          },
          "options": { "colorMode": "value", "graphMode": "area", "reduceOptions": { "calcs": ["lastNotNull"] } },
          "targets": [{ "expr": "sum(increase(agent_redteam_exploits_successful_total{severity=~\"$severity\", category=~\"$category\"}[24h])) or vector(0)", "refId": "A" }]
        },
        {
          "type": "stat",
          "title": "üü¢ Blocked Attacks",
          "gridPos": { "h": 4, "w": 4, "x": 8, "y": 1 },
          "id": 4,
          "datasource": { "type": "prometheus", "uid": "prometheus" },
          "fieldConfig": {
            "defaults": {
              "color": { "mode": "thresholds" },
              "thresholds": { "mode": "absolute", "steps": [{ "color": "orange", "value": null }, { "color": "green", "value": 10 }] },
              "unit": "short"
            }
          },
          "options": { "colorMode": "value", "graphMode": "area", "reduceOptions": { "calcs": ["lastNotNull"] } },
          "targets": [{ "expr": "sum(increase(agent_redteam_exploits_blocked_total{severity=~\"$severity\", category=~\"$category\"}[24h])) or vector(0)", "refId": "A" }]
        },
        {
          "type": "stat",
          "title": "Security Score",
          "gridPos": { "h": 4, "w": 4, "x": 12, "y": 1 },
          "id": 5,
          "datasource": { "type": "prometheus", "uid": "prometheus" },
          "fieldConfig": {
            "defaults": {
              "color": { "mode": "thresholds" },
              "thresholds": { "mode": "absolute", "steps": [{ "color": "red", "value": null }, { "color": "yellow", "value": 0.8 }, { "color": "green", "value": 0.95 }] },
              "unit": "percentunit",
              "decimals": 1
            }
          },
          "options": { "colorMode": "value", "graphMode": "area", "reduceOptions": { "calcs": ["lastNotNull"] } },
          "targets": [{ "expr": "sum(rate(agent_redteam_exploits_blocked_total[1h])) / (sum(rate(agent_redteam_exploits_executed_total[1h])) + 0.0001) or vector(1)", "refId": "A" }]
        },
        {
          "type": "stat",
          "title": "üî• Critical Vulns",
          "gridPos": { "h": 4, "w": 4, "x": 16, "y": 1 },
          "id": 6,
          "datasource": { "type": "prometheus", "uid": "prometheus" },
          "fieldConfig": {
            "defaults": {
              "color": { "mode": "thresholds" },
              "thresholds": { "mode": "absolute", "steps": [{ "color": "green", "value": null }, { "color": "orange", "value": 1 }, { "color": "red", "value": 3 }] },
              "unit": "short"
            }
          },
          "options": { "colorMode": "value", "graphMode": "none", "reduceOptions": { "calcs": ["lastNotNull"] } },
          "targets": [{ "expr": "sum(agent_redteam_critical_vulnerabilities_exposed) or sum(increase(agent_redteam_exploits_successful_total{severity=\"critical\"}[24h])) or vector(0)", "refId": "A" }]
        },
        {
          "type": "stat",
          "title": "Active Attacks",
          "gridPos": { "h": 4, "w": 4, "x": 20, "y": 1 },
          "id": 7,
          "datasource": { "type": "prometheus", "uid": "prometheus" },
          "fieldConfig": {
            "defaults": {
              "color": { "mode": "thresholds" },
              "thresholds": { "mode": "absolute", "steps": [{ "color": "green", "value": null }, { "color": "yellow", "value": 3 }, { "color": "red", "value": 10 }] },
              "unit": "short"
            }
          },
          "options": { "colorMode": "value", "graphMode": "area", "reduceOptions": { "calcs": ["lastNotNull"] } },
          "targets": [{ "expr": "sum(agent_redteam_active_exploits) or vector(0)", "refId": "A" }]
        },
        {
          "type": "row",
          "title": "‚öîÔ∏è Attack Patterns",
          "gridPos": { "h": 1, "w": 24, "x": 0, "y": 5 },
          "id": 10,
          "collapsed": false
        },
        {
          "type": "timeseries",
          "title": "Attack Rate by Status",
          "gridPos": { "h": 8, "w": 12, "x": 0, "y": 6 },
          "id": 11,
          "datasource": { "type": "prometheus", "uid": "prometheus" },
          "fieldConfig": {
            "defaults": {
              "color": { "mode": "palette-classic" },
              "custom": { "drawStyle": "line", "fillOpacity": 20, "lineWidth": 2, "showPoints": "never" },
              "unit": "ops"
            },
            "overrides": [
              { "matcher": { "id": "byName", "options": "success" }, "properties": [{ "id": "color", "value": { "fixedColor": "red", "mode": "fixed" } }] },
              { "matcher": { "id": "byName", "options": "blocked" }, "properties": [{ "id": "color", "value": { "fixedColor": "green", "mode": "fixed" } }] }
            ]
          },
          "options": { "legend": { "calcs": ["sum", "mean"], "displayMode": "table", "placement": "bottom" } },
          "targets": [{ "expr": "sum by (status) (rate(agent_redteam_exploits_executed_total{severity=~\"$severity\", category=~\"$category\"}[5m]))", "legendFormat": "{{status}}", "refId": "A" }]
        },
        {
          "type": "timeseries",
          "title": "Attacks by Severity",
          "gridPos": { "h": 8, "w": 12, "x": 12, "y": 6 },
          "id": 12,
          "datasource": { "type": "prometheus", "uid": "prometheus" },
          "fieldConfig": {
            "defaults": {
              "color": { "mode": "palette-classic" },
              "custom": { "drawStyle": "line", "fillOpacity": 30, "lineWidth": 2, "showPoints": "never", "stacking": { "mode": "normal" } },
              "unit": "short"
            },
            "overrides": [
              { "matcher": { "id": "byName", "options": "critical" }, "properties": [{ "id": "color", "value": { "fixedColor": "red", "mode": "fixed" } }] },
              { "matcher": { "id": "byName", "options": "high" }, "properties": [{ "id": "color", "value": { "fixedColor": "orange", "mode": "fixed" } }] }
            ]
          },
          "options": { "legend": { "calcs": ["sum"], "displayMode": "table", "placement": "bottom" } },
          "targets": [{ "expr": "sum by (severity) (increase(agent_redteam_attacks_by_severity_total[5m]))", "legendFormat": "{{severity}}", "refId": "A" }]
        },
        {
          "type": "row",
          "title": "üõ°Ô∏è Security Analysis",
          "gridPos": { "h": 1, "w": 24, "x": 0, "y": 14 },
          "id": 20,
          "collapsed": false
        },
        {
          "type": "piechart",
          "title": "Attacks by Category",
          "gridPos": { "h": 8, "w": 8, "x": 0, "y": 15 },
          "id": 21,
          "datasource": { "type": "prometheus", "uid": "prometheus" },
          "options": { "displayLabels": ["name", "percent"], "legend": { "displayMode": "table", "placement": "right" }, "pieType": "pie" },
          "targets": [{ "expr": "sum by (category) (increase(agent_redteam_attacks_by_category_total[24h]))", "legendFormat": "{{category}}", "refId": "A" }]
        },
        {
          "type": "piechart",
          "title": "Attack Outcomes",
          "gridPos": { "h": 8, "w": 8, "x": 8, "y": 15 },
          "id": 22,
          "datasource": { "type": "prometheus", "uid": "prometheus" },
          "fieldConfig": {
            "overrides": [
              { "matcher": { "id": "byName", "options": "blocked" }, "properties": [{ "id": "color", "value": { "fixedColor": "green", "mode": "fixed" } }] },
              { "matcher": { "id": "byName", "options": "success" }, "properties": [{ "id": "color", "value": { "fixedColor": "red", "mode": "fixed" } }] }
            ]
          },
          "options": { "displayLabels": ["name", "percent"], "legend": { "displayMode": "table", "placement": "right" }, "pieType": "donut" },
          "targets": [{ "expr": "sum by (status) (increase(agent_redteam_exploits_executed_total[24h]))", "legendFormat": "{{status}}", "refId": "A" }]
        },
        {
          "type": "piechart",
          "title": "Mitigations by Type",
          "gridPos": { "h": 8, "w": 8, "x": 16, "y": 15 },
          "id": 23,
          "datasource": { "type": "prometheus", "uid": "prometheus" },
          "options": { "displayLabels": ["name", "percent"], "legend": { "displayMode": "table", "placement": "right" }, "pieType": "pie" },
          "targets": [{ "expr": "sum by (mitigated_by) (increase(agent_redteam_exploits_blocked_total[24h]))", "legendFormat": "{{mitigated_by}}", "refId": "A" }]
        },
        {
          "type": "row",
          "title": "‚è±Ô∏è Attack Performance",
          "gridPos": { "h": 1, "w": 24, "x": 0, "y": 23 },
          "id": 30,
          "collapsed": false
        },
        {
          "type": "timeseries",
          "title": "Exploit Duration (P95)",
          "gridPos": { "h": 8, "w": 12, "x": 0, "y": 24 },
          "id": 31,
          "datasource": { "type": "prometheus", "uid": "prometheus" },
          "fieldConfig": {
            "defaults": {
              "color": { "mode": "palette-classic" },
              "custom": { "drawStyle": "line", "fillOpacity": 10, "lineWidth": 2 },
              "unit": "s",
              "thresholds": { "mode": "absolute", "steps": [{ "color": "green", "value": null }, { "color": "red", "value": 300 }] }
            }
          },
          "options": { "legend": { "calcs": ["mean", "max"], "displayMode": "table", "placement": "bottom" } },
          "targets": [{ "expr": "histogram_quantile(0.95, sum by (le, category) (rate(agent_redteam_exploit_duration_seconds_bucket[5m])))", "legendFormat": "{{category}}", "refId": "A" }]
        },
        {
          "type": "timeseries",
          "title": "Exploit Duration by Severity",
          "gridPos": { "h": 8, "w": 12, "x": 12, "y": 24 },
          "id": 32,
          "datasource": { "type": "prometheus", "uid": "prometheus" },
          "fieldConfig": {
            "defaults": {
              "color": { "mode": "palette-classic" },
              "custom": { "drawStyle": "line", "fillOpacity": 10, "lineWidth": 2 },
              "unit": "s"
            },
            "overrides": [
              { "matcher": { "id": "byName", "options": "critical" }, "properties": [{ "id": "color", "value": { "fixedColor": "red", "mode": "fixed" } }] }
            ]
          },
          "options": { "legend": { "calcs": ["mean", "max"], "displayMode": "table", "placement": "bottom" } },
          "targets": [{ "expr": "histogram_quantile(0.95, sum by (le, severity) (rate(agent_redteam_exploit_duration_by_severity_seconds_bucket[5m])))", "legendFormat": "{{severity}}", "refId": "A" }]
        },
        {
          "type": "row",
          "title": "üìä Exploit Details",
          "gridPos": { "h": 1, "w": 24, "x": 0, "y": 32 },
          "id": 40,
          "collapsed": false
        },
        {
          "type": "bargauge",
          "title": "Top Successful Exploits (24h)",
          "gridPos": { "h": 8, "w": 12, "x": 0, "y": 33 },
          "id": 41,
          "datasource": { "type": "prometheus", "uid": "prometheus" },
          "fieldConfig": {
            "defaults": {
              "color": { "mode": "thresholds" },
              "thresholds": { "mode": "absolute", "steps": [{ "color": "yellow", "value": null }, { "color": "red", "value": 5 }] },
              "unit": "short"
            }
          },
          "options": { "displayMode": "gradient", "orientation": "horizontal" },
          "targets": [{ "expr": "topk(10, sum by (exploit_id) (increase(agent_redteam_exploits_successful_total[24h])))", "legendFormat": "{{exploit_id}}", "refId": "A" }]
        },
        {
          "type": "bargauge",
          "title": "Top Blocked Exploits (24h)",
          "gridPos": { "h": 8, "w": 12, "x": 12, "y": 33 },
          "id": 42,
          "datasource": { "type": "prometheus", "uid": "prometheus" },
          "fieldConfig": {
            "defaults": {
              "color": { "mode": "thresholds" },
              "thresholds": { "mode": "absolute", "steps": [{ "color": "light-green", "value": null }, { "color": "dark-green", "value": 10 }] },
              "unit": "short"
            }
          },
          "options": { "displayMode": "gradient", "orientation": "horizontal" },
          "targets": [{ "expr": "topk(10, sum by (exploit_id) (increase(agent_redteam_exploits_blocked_total[24h])))", "legendFormat": "{{exploit_id}}", "refId": "A" }]
        },
        {
          "type": "row",
          "title": "üé≤ Chaos Testing",
          "gridPos": { "h": 1, "w": 24, "x": 0, "y": 41 },
          "id": 50,
          "collapsed": false
        },
        {
          "type": "stat",
          "title": "Random Exploits (24h)",
          "gridPos": { "h": 4, "w": 6, "x": 0, "y": 42 },
          "id": 51,
          "datasource": { "type": "prometheus", "uid": "prometheus" },
          "fieldConfig": { "defaults": { "color": { "mode": "thresholds" }, "thresholds": { "mode": "absolute", "steps": [{ "color": "purple", "value": null }] }, "unit": "short" } },
          "options": { "colorMode": "value", "graphMode": "area", "reduceOptions": { "calcs": ["lastNotNull"] } },
          "targets": [{ "expr": "sum(increase(agent_redteam_random_exploits_total[24h])) or vector(0)", "refId": "A" }]
        },
        {
          "type": "stat",
          "title": "K6 Tests Triggered",
          "gridPos": { "h": 4, "w": 6, "x": 6, "y": 42 },
          "id": 52,
          "datasource": { "type": "prometheus", "uid": "prometheus" },
          "fieldConfig": { "defaults": { "color": { "mode": "thresholds" }, "thresholds": { "mode": "absolute", "steps": [{ "color": "blue", "value": null }] }, "unit": "short" } },
          "options": { "colorMode": "value", "graphMode": "area", "reduceOptions": { "calcs": ["lastNotNull"] } },
          "targets": [{ "expr": "sum(increase(agent_redteam_k6_tests_triggered_total[24h])) or vector(0)", "refId": "A" }]
        },
        {
          "type": "stat",
          "title": "Test Runs",
          "gridPos": { "h": 4, "w": 6, "x": 12, "y": 42 },
          "id": 53,
          "datasource": { "type": "prometheus", "uid": "prometheus" },
          "fieldConfig": { "defaults": { "color": { "mode": "thresholds" }, "thresholds": { "mode": "absolute", "steps": [{ "color": "blue", "value": null }] }, "unit": "short" } },
          "options": { "colorMode": "value", "graphMode": "area", "reduceOptions": { "calcs": ["lastNotNull"] } },
          "targets": [{ "expr": "sum(increase(agent_redteam_test_runs_total[24h])) or vector(0)", "refId": "A" }]
        },
        {
          "type": "stat",
          "title": "Active Test Runs",
          "gridPos": { "h": 4, "w": 6, "x": 18, "y": 42 },
          "id": 54,
          "datasource": { "type": "prometheus", "uid": "prometheus" },
          "fieldConfig": { "defaults": { "color": { "mode": "thresholds" }, "thresholds": { "mode": "absolute", "steps": [{ "color": "green", "value": null }, { "color": "red", "value": 5 }] }, "unit": "short" } },
          "options": { "colorMode": "value", "graphMode": "area", "reduceOptions": { "calcs": ["lastNotNull"] } },
          "targets": [{ "expr": "sum(agent_redteam_test_runs_active) or vector(0)", "refId": "A" }]
        },
        {
          "type": "timeseries",
          "title": "Random Exploits by Trigger",
          "gridPos": { "h": 8, "w": 12, "x": 0, "y": 46 },
          "id": 55,
          "datasource": { "type": "prometheus", "uid": "prometheus" },
          "fieldConfig": { "defaults": { "custom": { "drawStyle": "bars", "fillOpacity": 80, "stacking": { "mode": "normal" } }, "unit": "short" } },
          "options": { "legend": { "calcs": ["sum"], "displayMode": "table", "placement": "bottom" } },
          "targets": [{ "expr": "sum by (trigger) (increase(agent_redteam_random_exploits_total[5m]))", "legendFormat": "{{trigger}}", "refId": "A" }]
        },
        {
          "type": "timeseries",
          "title": "K6 Tests by Type",
          "gridPos": { "h": 8, "w": 12, "x": 12, "y": 46 },
          "id": 56,
          "datasource": { "type": "prometheus", "uid": "prometheus" },
          "fieldConfig": { "defaults": { "custom": { "drawStyle": "bars", "fillOpacity": 80, "stacking": { "mode": "normal" } }, "unit": "short" } },
          "options": { "legend": { "calcs": ["sum"], "displayMode": "table", "placement": "bottom" } },
          "targets": [{ "expr": "sum by (test_type) (increase(agent_redteam_k6_tests_triggered_total[5m]))", "legendFormat": "{{test_type}}", "refId": "A" }]
        }
      ],
      "time": { "from": "now-1h", "to": "now" },
      "timepicker": { "refresh_intervals": ["5s", "10s", "30s", "1m", "5m"] }
    }
