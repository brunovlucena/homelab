# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
#
#  ðŸ” Grafana Service Account Alerts
#
#  Monitors Grafana service account sync job status.
#  Part of BVL-319: Automate Service Account Creation
#
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
---
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: grafana-service-accounts-alerts
  namespace: prometheus
  labels:
    app: grafana-service-accounts
    prometheus: kube-prometheus-stack
    gitops.homelab.io/managed-by: flux
spec:
  groups:
    - name: grafana-service-accounts
      interval: 60s
      rules:
        # Alert when Grafana service account sync job fails
        - alert: GrafanaServiceAccountSyncFailed
          annotations:
            description: "Grafana service account sync job has failed. Service accounts may not be created or tokens may be missing."
            summary: "Grafana service account sync failed"
            runbook_url: "https://github.com/brunovlucena/homelab/blob/main/flux/infrastructure/prometheus-operator/grafana-service-accounts/README.md#troubleshooting"
          expr: |
            kube_job_status_failed{job_name="grafana-service-accounts-sync",namespace="prometheus"} > 0
          for: 5m
          labels:
            severity: warning

        # Alert when job hasn't run recently (stale)
        - alert: GrafanaServiceAccountSyncStale
          annotations:
            description: "Grafana service account sync job hasn't completed successfully in over 24 hours."
            summary: "Grafana service account sync is stale"
          expr: |
            (time() - kube_job_status_completion_time{job_name=~"grafana-service-accounts-sync.*",namespace="prometheus"}) > 86400
          for: 1h
          labels:
            severity: info

        # Alert when service account secrets are missing
        - alert: GrafanaServiceAccountSecretMissing
          annotations:
            description: "Expected Grafana service account secret is missing. Token may not have been created."
            summary: "Grafana service account secret missing"
          expr: |
            absent(kube_secret_info{namespace="prometheus",secret=~"grafana-sa-.*-token"})
          for: 30m
          labels:
            severity: warning
