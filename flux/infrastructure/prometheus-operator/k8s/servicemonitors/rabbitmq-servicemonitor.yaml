# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
#
#  ğŸ° RABBITMQ SERVICEMONITOR
#
#  Purpose: Collect metrics from RabbitMQ clusters
#  Metrics: Queue depth, messages, connections, channels, memory, disk
#  Used by: Knative Lambda Eventing & DLQ Dashboard
#
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
---
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: rabbitmq-cluster
  namespace: prometheus
  labels:
    app.kubernetes.io/name: rabbitmq
    app.kubernetes.io/component: rabbitmq-cluster
    # Required for prometheus-operator to discover
    release: kube-prometheus-stack
spec:
  selector:
    matchLabels:
      app.kubernetes.io/component: rabbitmq
  namespaceSelector:
    matchNames:
      - knative-lambda
      - ai-agents
      - rabbitmq-system
  endpoints:
    # Aggregate metrics (connections, channels, etc.)
    - port: prometheus
      interval: 30s
      scrapeTimeout: 10s
      path: /metrics
      scheme: http
      relabelings:
        - sourceLabels: [__meta_kubernetes_pod_name]
          targetLabel: pod
        - sourceLabels: [__meta_kubernetes_namespace]
          targetLabel: namespace
        - sourceLabels: [__meta_kubernetes_service_name]
          targetLabel: rabbitmq_cluster
        - action: replace
          replacement: rabbitmq
          targetLabel: component
    # Detailed per-queue metrics (queue depth, messages, etc.)
    - port: prometheus
      interval: 30s
      scrapeTimeout: 15s
      path: /metrics/detailed
      params:
        family:
          - queue_coarse_metrics
          - queue_metrics
      scheme: http
      relabelings:
        - sourceLabels: [__meta_kubernetes_pod_name]
          targetLabel: pod
        - sourceLabels: [__meta_kubernetes_namespace]
          targetLabel: namespace
        - sourceLabels: [__meta_kubernetes_service_name]
          targetLabel: rabbitmq_cluster
        - action: replace
          replacement: rabbitmq
          targetLabel: component
      # Rename detailed metrics to match standard names
      metricRelabelings:
        - sourceLabels: [__name__]
          regex: 'rabbitmq_detailed_queue_messages_ready'
          targetLabel: __name__
          replacement: 'rabbitmq_queue_messages'
        - sourceLabels: [__name__]
          regex: 'rabbitmq_detailed_queue_messages_unacked'
          targetLabel: __name__
          replacement: 'rabbitmq_queue_messages_unacked'
        - sourceLabels: [__name__]
          regex: 'rabbitmq_detailed_queue_messages_published_total'
          targetLabel: __name__
          replacement: 'rabbitmq_queue_messages_published_total'
        - sourceLabels: [__name__]
          regex: 'rabbitmq_detailed_queue_messages_delivered_total'
          targetLabel: __name__
          replacement: 'rabbitmq_queue_messages_delivered_total'
        - sourceLabels: [__name__]
          regex: 'rabbitmq_detailed_queue_head_message_timestamp'
          targetLabel: __name__
          replacement: 'rabbitmq_queue_head_message_timestamp'
