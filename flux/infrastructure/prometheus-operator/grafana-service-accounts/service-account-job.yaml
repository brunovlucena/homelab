# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
#
#  ğŸ” Grafana Service Account Creation Job
#
#  This Job creates Grafana service accounts via the Grafana API and stores
#  the tokens in Kubernetes secrets.
#
#  Part of BVL-319: Automate Service Account Creation
#
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
---
apiVersion: batch/v1
kind: Job
metadata:
  name: grafana-service-accounts-sync
  namespace: prometheus
  labels:
    app: grafana-service-accounts
    component: sync-job
    gitops.homelab.io/managed-by: flux
  annotations:
    # Force Flux to delete and recreate the Job when spec changes
    # Required because Jobs are immutable - can't update spec.template
    kustomize.toolkit.fluxcd.io/force: "enabled"
spec:
  backoffLimit: 3
  ttlSecondsAfterFinished: 86400
  template:
    metadata:
      labels:
        app: grafana-service-accounts
        component: sync-job
    spec:
      serviceAccountName: grafana-sa-manager
      restartPolicy: Never
      containers:
        - name: sync
          image: localhost:5001/kubectl:v1.34.0
          imagePullPolicy: IfNotPresent
          env:
            - name: GRAFANA_URL
              value: "http://kube-prometheus-stack-grafana.prometheus.svc.cluster.local:3000"
            - name: NAMESPACE
              value: "prometheus"
          command:
            - /bin/bash
            - -c
            - |
              set -euo pipefail
              
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo "ğŸ” Grafana Service Account Sync"
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              
              # Get Grafana admin credentials
              GRAFANA_USER="admin"
              GRAFANA_PASSWORD=$(kubectl get secret prometheus -n ${NAMESPACE} -o jsonpath='{.data.grafana-password}' | base64 -d)
              
              if [ -z "${GRAFANA_PASSWORD}" ]; then
                echo "âŒ Failed to get Grafana admin password"
                exit 1
              fi
              
              echo "âœ… Retrieved Grafana admin credentials"
              
              # Read service account configuration
              CONFIG=$(kubectl get configmap grafana-service-accounts-config -n ${NAMESPACE} -o jsonpath='{.data.service-accounts\.yaml}')
              
              if [ -z "${CONFIG}" ]; then
                echo "âŒ Failed to read service accounts configuration"
                exit 1
              fi
              
              echo "âœ… Read service accounts configuration"
              
              # Function to create or update a service account
              create_service_account() {
                local SA_NAME="$1"
                local SA_ROLE="$2"
                local SA_DESC="$3"
                local SECRET_NAME="$4"
                
                echo ""
                echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                echo "Processing: ${SA_NAME}"
                echo "  Role: ${SA_ROLE}"
                echo "  Secret: ${SECRET_NAME}"
                echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                
                # Check if service account already exists
                SA_RESPONSE=$(curl -sf -u "${GRAFANA_USER}:${GRAFANA_PASSWORD}" \
                  "${GRAFANA_URL}/api/serviceaccounts/search?query=${SA_NAME}" 2>/dev/null || echo '{"serviceAccounts":[]}')
                
                SA_ID=$(echo "${SA_RESPONSE}" | jq -r ".serviceAccounts[] | select(.name == \"${SA_NAME}\") | .id" 2>/dev/null || echo "")
                
                if [ -n "${SA_ID}" ] && [ "${SA_ID}" != "null" ]; then
                  echo "  â„¹ï¸  Service account already exists (ID: ${SA_ID})"
                else
                  echo "  Creating service account..."
                  
                  # Map role name to Grafana role
                  case "${SA_ROLE}" in
                    Admin)  GRAFANA_ROLE="Admin" ;;
                    Editor) GRAFANA_ROLE="Editor" ;;
                    Viewer) GRAFANA_ROLE="Viewer" ;;
                    *)      GRAFANA_ROLE="Viewer" ;;
                  esac
                  
                  # Create service account - capture both stdout and stderr for error details
                  CREATE_RESPONSE=$(curl -s -w "\nHTTP_CODE:%{http_code}" -X POST \
                    -u "${GRAFANA_USER}:${GRAFANA_PASSWORD}" \
                    -H "Content-Type: application/json" \
                    -d "{\"name\": \"${SA_NAME}\", \"role\": \"${GRAFANA_ROLE}\"}" \
                    "${GRAFANA_URL}/api/serviceaccounts" 2>&1)
                  
                  HTTP_CODE=$(echo "${CREATE_RESPONSE}" | grep "HTTP_CODE:" | sed 's/.*HTTP_CODE://' || echo "")
                  RESPONSE_BODY=$(echo "${CREATE_RESPONSE}" | sed '/HTTP_CODE:/d' || echo "${CREATE_RESPONSE}")
                  
                  SA_ID=$(echo "${RESPONSE_BODY}" | jq -r '.id' 2>/dev/null || echo "")
                  
                  if [ -z "${SA_ID}" ] || [ "${SA_ID}" == "null" ]; then
                    echo "  âŒ Failed to create service account (HTTP ${HTTP_CODE:-unknown})"
                    echo "  Response: ${RESPONSE_BODY}"
                    echo "  Full curl output:"
                    echo "${CREATE_RESPONSE}" | head -30
                    return 1
                  fi
                  
                  echo "  âœ… Created service account (ID: ${SA_ID})"
                fi
                
                # Check if token secret already exists with a valid token
                EXISTING_TOKEN=$(kubectl get secret "${SECRET_NAME}" -n ${NAMESPACE} -o jsonpath='{.data.token}' 2>/dev/null | base64 -d || echo "")
                
                if [ -n "${EXISTING_TOKEN}" ]; then
                  # Verify token is still valid
                  TOKEN_CHECK=$(curl -sf -H "Authorization: Bearer ${EXISTING_TOKEN}" \
                    "${GRAFANA_URL}/api/user" 2>/dev/null || echo "")
                  
                  if [ -n "${TOKEN_CHECK}" ] && echo "${TOKEN_CHECK}" | jq -e '.login' > /dev/null 2>&1; then
                    echo "  â„¹ï¸  Token already exists and is valid, skipping"
                    return 0
                  fi
                  
                  echo "  âš ï¸  Existing token is invalid, creating new one..."
                fi
                
                # Delete existing tokens for this service account
                echo "  Cleaning up old tokens..."
                TOKENS_RESPONSE=$(curl -sf -u "${GRAFANA_USER}:${GRAFANA_PASSWORD}" \
                  "${GRAFANA_URL}/api/serviceaccounts/${SA_ID}/tokens" 2>/dev/null || echo '[]')
                
                echo "${TOKENS_RESPONSE}" | jq -r '.[].id' 2>/dev/null | while read TOKEN_ID; do
                  if [ -n "${TOKEN_ID}" ] && [ "${TOKEN_ID}" != "null" ]; then
                    curl -sf -X DELETE -u "${GRAFANA_USER}:${GRAFANA_PASSWORD}" \
                      "${GRAFANA_URL}/api/serviceaccounts/${SA_ID}/tokens/${TOKEN_ID}" > /dev/null 2>&1 || true
                  fi
                done
                
                # Create new token
                echo "  Creating new token..."
                TOKEN_NAME="gitops-managed-$(date +%Y%m%d%H%M%S)"
                TOKEN_RESPONSE=$(curl -s -w "\nHTTP_CODE:%{http_code}" -X POST \
                  -u "${GRAFANA_USER}:${GRAFANA_PASSWORD}" \
                  -H "Content-Type: application/json" \
                  -d "{\"name\": \"${TOKEN_NAME}\"}" \
                  "${GRAFANA_URL}/api/serviceaccounts/${SA_ID}/tokens" 2>&1)
                
                HTTP_CODE=$(echo "${TOKEN_RESPONSE}" | grep "HTTP_CODE:" | sed 's/.*HTTP_CODE://' || echo "")
                RESPONSE_BODY=$(echo "${TOKEN_RESPONSE}" | sed '/HTTP_CODE:/d' || echo "${TOKEN_RESPONSE}")
                
                NEW_TOKEN=$(echo "${RESPONSE_BODY}" | jq -r '.key' 2>/dev/null || echo "")
                
                if [ -z "${NEW_TOKEN}" ] || [ "${NEW_TOKEN}" == "null" ]; then
                  echo "  âŒ Failed to create token (HTTP ${HTTP_CODE:-unknown})"
                  echo "  Response: ${RESPONSE_BODY}"
                  return 1
                fi
                
                echo "  âœ… Created new token"
                
                # Store token in Kubernetes secret
                echo "  Storing token in secret: ${SECRET_NAME}"
                kubectl create secret generic "${SECRET_NAME}" \
                  --from-literal=token="${NEW_TOKEN}" \
                  --from-literal=service-account-name="${SA_NAME}" \
                  --from-literal=service-account-id="${SA_ID}" \
                  --from-literal=grafana-url="${GRAFANA_URL}" \
                  --namespace="${NAMESPACE}" \
                  --dry-run=client -o yaml | kubectl apply -f -
                
                # Add labels to the secret
                kubectl label secret "${SECRET_NAME}" -n ${NAMESPACE} \
                  app=grafana-service-accounts \
                  grafana-service-account="${SA_NAME}" \
                  gitops.homelab.io/managed-by=flux \
                  --overwrite
                
                echo "  âœ… Token stored in secret"
              }
              
              # Parse and process each service account
              echo ""
              echo "Processing service accounts..."
              
              # Extract service accounts from YAML config
              # Use awk to parse YAML and extract fields (POSIX-compliant)
              echo "${CONFIG}" | awk '
                BEGIN { name=""; role=""; desc=""; secret="" }
                /^[[:space:]]*-[[:space:]]*name:[[:space:]]/ { 
                  if (name != "" && secret != "") {
                    print name "|" role "|" desc "|" secret
                  }
                  name=""; role=""; desc=""; secret=""
                  sub(/^[[:space:]]*-[[:space:]]*name:[[:space:]]*/, "")
                  name=$0
                  next
                }
                /^[[:space:]]+role:[[:space:]]/ { 
                  sub(/^[[:space:]]+role:[[:space:]]*/, "")
                  role=$0
                  next
                }
                /^[[:space:]]+description:[[:space:]]/ { 
                  sub(/^[[:space:]]+description:[[:space:]]*"?/, "")
                  sub(/"?[[:space:]]*$/, "")
                  desc=$0
                  next
                }
                /^[[:space:]]+secret_name:[[:space:]]/ { 
                  sub(/^[[:space:]]+secret_name:[[:space:]]*/, "")
                  secret=$0
                  if (name != "" && secret != "") {
                    print name "|" role "|" desc "|" secret
                    name=""; role=""; desc=""; secret=""
                  }
                  next
                }
                END {
                  if (name != "" && secret != "") {
                    print name "|" role "|" desc "|" secret
                  }
                }
              ' | while IFS='|' read -r NAME ROLE DESC SECRET; do
                if [ -n "${NAME}" ] && [ "${NAME}" != "null" ] && [ -n "${SECRET}" ]; then
                  create_service_account "${NAME}" "${ROLE}" "${DESC}" "${SECRET}" || true
                fi
              done
              
              echo ""
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo "âœ… Grafana Service Account Sync Complete"
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              
              # List all created secrets
              echo ""
              echo "Created secrets:"
              kubectl get secrets -n ${NAMESPACE} -l app=grafana-service-accounts -o custom-columns=NAME:.metadata.name,SERVICE-ACCOUNT:.metadata.labels.grafana-service-account
