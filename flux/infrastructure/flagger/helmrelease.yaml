---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: flagger
  namespace: flagger-system
spec:
  interval: 5m
  # â±ï¸ Increased timeout for image pull delays
  timeout: 10m
  # ğŸ”„ Retry configuration for resilience
  install:
    remediation:
      retries: 3
  upgrade:
    remediation:
      retries: 3
  chart:
    spec:
      chart: flagger
      version: "1.39.x"
      sourceRef:
        kind: HelmRepository
        name: flagger
        namespace: flux-system
      interval: 1h
  values:
    # ğŸ–¼ï¸ Image - Use local registry
    image:
      repository: localhost:5001/flagger
      # Fallback: ghcr.io/fluxcd/flagger
      tag: 1.39.0
    
    # ğŸ”— Linkerd Integration
    meshProvider: linkerd
    
    # ğŸ“Š Metrics Provider - Prometheus (kube-prometheus-stack)
    metricsServer: http://kube-prometheus-stack-prometheus.prometheus.svc.cluster.local:9090
    
    # ğŸ¯ Enable Prometheus scraping
    prometheus:
      install: false  # We already have Prometheus
    
    # ğŸ” Logging
    logLevel: info
    
    # ğŸ›ï¸ Resources (homelab optimized)
    resources:
      limits:
        memory: 64Mi
        # cpu: 100m
      # requests:
      #   memory: 32Mi
      #   cpu: 50m
    
    # ğŸ¥ Pod Security
    podSecurityContext:
      runAsNonRoot: true
      runAsUser: 65534
    
    securityContext:
      readOnlyRootFilesystem: true
      runAsNonRoot: true
      runAsUser: 65534
      allowPrivilegeEscalation: false
      capabilities:
        drop:
          - ALL

