---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: telepresence
  namespace: ambassador
spec:
  interval: 30m
  chart:
    spec:
      chart: telepresence-oss
      version: "2.25.0"
      sourceRef:
        kind: HelmRepository
        name: telepresence
        namespace: flux-system
      interval: 12h
  install:
    createNamespace: true
    remediation:
      retries: 3
  upgrade:
    remediation:
      retries: 3
  values:
    logLevel: info

    # Pre-warm traffic agent image to avoid cold starts
    agent:
      image:
        registry: localhost:5001/datawire
        name: tel2
        tag: 2.25.0
      # Security context for traffic-agent to allow execution
      securityContext:
        allowPrivilegeEscalation: true
        readOnlyRootFilesystem: false
        runAsNonRoot: false
        runAsUser: 0
        capabilities:
          add:
            - NET_ADMIN
            - NET_RAW
            - SYS_ADMIN

    # Client RBAC for all authenticated users
    clientRbac:
      create: true
      subjects:
        - kind: Group
          name: system:authenticated
          apiGroup: rbac.authorization.k8s.io

