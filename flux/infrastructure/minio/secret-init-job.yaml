---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: minio-secret-init
  namespace: minio
  labels:
    app: minio
    component: secret-init
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: minio-secret-init
  labels:
    app: minio
    component: secret-init
rules:
- apiGroups: [""]
  resources: ["secrets", "namespaces"]
  verbs: ["get", "list", "create", "update", "patch"]
- apiGroups: ["apps"]
  resources: ["deployments"]
  verbs: ["get", "list", "patch", "watch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: minio-secret-init
  labels:
    app: minio
    component: secret-init
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: minio-secret-init
subjects:
- kind: ServiceAccount
  name: minio-secret-init
  namespace: minio
---
apiVersion: batch/v1
kind: Job
metadata:
  name: minio-secret-init
  namespace: minio
  labels:
    app: minio
    component: secret-init
  annotations:
    kustomize.toolkit.fluxcd.io/prune: disabled
spec:
  backoffLimit: 3
  ttlSecondsAfterFinished: 86400
  template:
    metadata:
      labels:
        app: minio
        component: secret-init
    spec:
      serviceAccountName: minio-secret-init
      restartPolicy: Never
      containers:
      - name: init
        image: localhost:5001/kubectl:v1.34.0
        imagePullPolicy: IfNotPresent
        env:
        - name: TARGET_NAMESPACE
          value: minio
        - name: SECRET_NAME
          value: minio-credentials
        command:
        - /bin/bash
        - -c
        - |
          set -euo pipefail

          # Namespaces that need minio-credentials
          COPY_NAMESPACES="knative-lambda demo-notifi"

          echo "Creating MinIO credentials secret in ${TARGET_NAMESPACE}"
          
          # Generate random credentials if secret doesn't exist
          if kubectl get secret "${SECRET_NAME}" -n "${TARGET_NAMESPACE}" &>/dev/null; then
            echo "Secret ${SECRET_NAME} already exists in ${TARGET_NAMESPACE}, skipping creation"
          else
            # Generate secure random credentials
            ROOT_USER="minioadmin"
            ROOT_PASSWORD=$(head -c 32 /dev/urandom | base64 | tr -dc 'a-zA-Z0-9' | head -c 24)

            kubectl create secret generic "${SECRET_NAME}" \
              --from-literal=root-user="${ROOT_USER}" \
              --from-literal=root-password="${ROOT_PASSWORD}" \
              --from-literal=access-key="${ROOT_USER}" \
              --from-literal=secret-key="${ROOT_PASSWORD}" \
              --namespace="${TARGET_NAMESPACE}" \
              --dry-run=client -o yaml | kubectl apply -f -

            echo "Created ${SECRET_NAME} secret with MinIO credentials"
          fi

          # Copy secret to other namespaces that need it
          for ns in ${COPY_NAMESPACES}; do
            echo "Copying ${SECRET_NAME} to namespace ${ns}..."
            if kubectl get ns "${ns}" &>/dev/null; then
              # Extract data from source secret and create in target namespace
              ROOT_USER=$(kubectl get secret "${SECRET_NAME}" -n "${TARGET_NAMESPACE}" -o jsonpath='{.data.root-user}' | base64 -d)
              ROOT_PASSWORD=$(kubectl get secret "${SECRET_NAME}" -n "${TARGET_NAMESPACE}" -o jsonpath='{.data.root-password}' | base64 -d)
              kubectl create secret generic "${SECRET_NAME}" \
                --from-literal=root-user="${ROOT_USER}" \
                --from-literal=root-password="${ROOT_PASSWORD}" \
                --from-literal=access-key="${ROOT_USER}" \
                --from-literal=secret-key="${ROOT_PASSWORD}" \
                --namespace="${ns}" \
                --dry-run=client -o yaml | kubectl apply -f -
              echo "Copied ${SECRET_NAME} to ${ns}"
            else
              echo "Namespace ${ns} does not exist yet, skipping"
            fi
          done

          # Restart deployment if it exists
          if kubectl get deployment minio -n "${TARGET_NAMESPACE}" &>/dev/null; then
            echo "Restarting MinIO deployment"
            kubectl rollout restart deployment minio -n "${TARGET_NAMESPACE}"
            kubectl rollout status deployment minio -n "${TARGET_NAMESPACE}" --timeout=5m || echo "Warning: Deployment rollout did not complete within timeout"
          fi

          echo "MinIO secret init complete"

