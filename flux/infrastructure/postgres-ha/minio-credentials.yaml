---
# Secret for MinIO backup credentials (your LOCAL MinIO)
apiVersion: v1
kind: Secret
metadata:
  name: minio-backup-credentials
  namespace: postgres-ha
type: Opaque
stringData:
  ACCESS_KEY_ID: "minioadmin"
  SECRET_ACCESS_KEY: "minioadmin"
---
# Job to sync credentials from external-secrets or flux-system
apiVersion: batch/v1
kind: Job
metadata:
  name: postgres-ha-minio-secret-sync
  namespace: postgres-ha
  annotations:
    kustomize.toolkit.fluxcd.io/prune: disabled
spec:
  ttlSecondsAfterFinished: 300
  template:
    spec:
      serviceAccountName: postgres-ha-secret-sync
      restartPolicy: OnFailure
      containers:
        - name: sync
          image: localhost:5001/kubectl:v1.34.0
          command:
            - /bin/sh
            - -c
            - |
              set -e
              echo "üîÑ Syncing MinIO credentials to postgres-ha namespace..."
              
              # Get MinIO credentials from minio namespace
              if kubectl get secret minio-credentials -n minio > /dev/null 2>&1; then
                ACCESS_KEY=$(kubectl get secret minio-credentials -n minio -o jsonpath='{.data.access-key}' | base64 -d)
                SECRET_KEY=$(kubectl get secret minio-credentials -n minio -o jsonpath='{.data.secret-key}' | base64 -d)
                
                kubectl create secret generic minio-backup-credentials \
                  --namespace postgres-ha \
                  --from-literal=ACCESS_KEY_ID="${ACCESS_KEY}" \
                  --from-literal=SECRET_ACCESS_KEY="${SECRET_KEY}" \
                  --dry-run=client -o yaml | kubectl apply -f -
                
                echo "‚úÖ MinIO credentials synced successfully"
              else
                echo "‚ö†Ô∏è  MinIO credentials not found, using defaults"
              fi
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: postgres-ha-secret-sync
  namespace: postgres-ha
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: postgres-ha-secret-sync
rules:
  - apiGroups: [""]
    resources: ["secrets"]
    verbs: ["get", "list", "create", "update", "patch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: postgres-ha-secret-sync
subjects:
  - kind: ServiceAccount
    name: postgres-ha-secret-sync
    namespace: postgres-ha
roleRef:
  kind: ClusterRole
  name: postgres-ha-secret-sync
  apiGroup: rbac.authorization.k8s.io

