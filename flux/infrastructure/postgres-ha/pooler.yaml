---
# PgBouncer Connection Pooler - Runs LOCAL alongside PostgreSQL
# 
# Benefits:
# - Connection pooling reduces PostgreSQL connection overhead
# - Automatic failover follows the primary
# - Load balancing for read replicas
#
apiVersion: postgresql.cnpg.io/v1
kind: Pooler
metadata:
  name: homepage-postgres-pooler-rw
  namespace: postgres-ha
spec:
  # Reference to the cluster
  cluster:
    name: homepage-postgres
  
  # 2 PgBouncer instances for HA
  instances: 2
  
  # Read-write connections go to primary
  type: rw
  
  # PgBouncer configuration
  pgbouncer:
    poolMode: transaction
    parameters:
      max_client_conn: "200"
      default_pool_size: "25"
      min_pool_size: "5"
      reserve_pool_size: "5"
      reserve_pool_timeout: "5"
      max_db_connections: "50"
      max_user_connections: "50"
      server_idle_timeout: "300"
      server_lifetime: "3600"
      query_wait_timeout: "60"
      client_idle_timeout: "0"
      log_connections: "1"
      log_disconnections: "1"
      stats_period: "60"
  
  # Resource limits
  template:
    spec:
      containers:
        - name: pgbouncer
          resources:
            requests:
              cpu: 50m
              memory: 64Mi
            limits:
              cpu: 200m
              memory: 128Mi

---
# Read-only pooler for read replicas (optional, for read scaling)
apiVersion: postgresql.cnpg.io/v1
kind: Pooler
metadata:
  name: homepage-postgres-pooler-ro
  namespace: postgres-ha
spec:
  cluster:
    name: homepage-postgres
  instances: 1
  type: ro  # Read-only, routes to replicas
  pgbouncer:
    poolMode: transaction
    parameters:
      max_client_conn: "100"
      default_pool_size: "10"

