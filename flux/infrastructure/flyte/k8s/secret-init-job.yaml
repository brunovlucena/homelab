---
# Secret sync job - copies postgres and minio credentials to flyte namespace
# Similar to knative-lambda-operator pattern
apiVersion: v1
kind: ServiceAccount
metadata:
  name: flyte-secret-init
  namespace: flyte
  labels:
    app: flyte
    component: secret-init
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: flyte-secret-init
  labels:
    app: flyte
    component: secret-init
rules:
- apiGroups: [""]
  resources: ["secrets", "namespaces"]
  verbs: ["get", "list", "create", "update", "patch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: flyte-secret-init
  labels:
    app: flyte
    component: secret-init
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: flyte-secret-init
subjects:
- kind: ServiceAccount
  name: flyte-secret-init
  namespace: flyte
---
apiVersion: batch/v1
kind: Job
metadata:
  name: flyte-secret-init
  namespace: flyte
  labels:
    app: flyte
    component: secret-init
  annotations:
    kustomize.toolkit.fluxcd.io/prune: disabled
spec:
  backoffLimit: 3
  ttlSecondsAfterFinished: 300
  template:
    metadata:
      labels:
        app: flyte
        component: secret-init
    spec:
      serviceAccountName: flyte-secret-init
      restartPolicy: OnFailure
      containers:
        - name: copy-secrets
          image: localhost:5001/kubectl:v1.34.0
          command:
            - sh
            - -c
            - |
              set -e
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo "ğŸ” Flyte Secret Bootstrap"
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo ""
              
              # Wait for postgres namespace and secret
              echo "â³ Waiting for postgres namespace..."
              until kubectl get namespace postgres &>/dev/null; do
                echo "   Postgres namespace not found, waiting..."
                sleep 2
              done
              echo "âœ… Postgres namespace found"
              
              # Get postgres password - try postgres namespace first, fallback to homepage secret
              echo ""
              echo "ğŸ”‘ Extracting postgres password..."
              POSTGRES_PASSWORD=""
              if kubectl get secret postgres -n postgres &>/dev/null; then
                echo "   Found postgres secret in postgres namespace"
                POSTGRES_PASSWORD=$(kubectl get secret postgres -n postgres -o jsonpath='{.data.password}' 2>/dev/null | base64 -d)
              fi
              
              # Fallback to homepage secret in flux-system
              if [ -z "${POSTGRES_PASSWORD}" ]; then
                echo "   Postgres secret not found, trying homepage secret in flux-system..."
                if kubectl get secret homepage -n flux-system &>/dev/null; then
                  POSTGRES_PASSWORD=$(kubectl get secret homepage -n flux-system -o jsonpath='{.data.homepage-postgres-password}' 2>/dev/null | base64 -d)
                fi
              fi
              
              if [ -z "${POSTGRES_PASSWORD}" ]; then
                echo "âŒ Error: Could not extract postgres password from postgres secret or homepage secret"
                exit 1
              fi
              echo "âœ… Postgres password extracted"
              
              # Create flyte-postgres secret with password key
              echo ""
              echo "ğŸ“¤ Creating flyte-postgres secret in flyte namespace..."
              kubectl create secret generic flyte-postgres \
                --from-literal=password="${POSTGRES_PASSWORD}" \
                --namespace=flyte \
                --dry-run=client -o yaml | kubectl apply -f -
              echo "âœ… Secret flyte-postgres created/updated successfully"
              
              # Wait for minio namespace and secret
              echo ""
              echo "â³ Waiting for minio namespace..."
              until kubectl get namespace minio &>/dev/null; do
                echo "   MinIO namespace not found, waiting..."
                sleep 2
              done
              echo "âœ… MinIO namespace found"
              
              echo ""
              echo "â³ Waiting for minio-credentials secret in minio namespace..."
              until kubectl get secret minio-credentials -n minio &>/dev/null; do
                echo "   Secret not found, waiting..."
                sleep 2
              done
              echo "âœ… MinIO secret found"
              
              # Copy minio secret
              echo ""
              echo "ğŸ“¤ Copying minio-credentials secret to flyte namespace..."
              if kubectl get secret minio-credentials -n flyte &>/dev/null; then
                echo "âœ… Secret minio-credentials already exists, updating..."
                kubectl get secret minio-credentials -n minio -o yaml | \
                  sed 's/namespace: minio/namespace: flyte/' | \
                  sed '/^  uid:/d' | \
                  sed '/^  resourceVersion:/d' | \
                  sed '/^  creationTimestamp:/d' | \
                  kubectl apply -f -
                echo "âœ… Secret updated"
              else
                kubectl get secret minio-credentials -n minio -o yaml | \
                  sed 's/namespace: minio/namespace: flyte/' | \
                  sed '/^  uid:/d' | \
                  sed '/^  resourceVersion:/d' | \
                  sed '/^  creationTimestamp:/d' | \
                  kubectl apply -f -
                echo "âœ… Secret copied successfully"
              fi
              
              # Create ghcr-secret for pulling images from GitHub Container Registry
              echo ""
              echo "ğŸ“¤ Creating ghcr-secret for GitHub Container Registry..."
              if kubectl get secret ghcr-secret -n flyte &>/dev/null; then
                echo "âœ… Secret ghcr-secret already exists"
              else
                # Get github-token from flux-system namespace
                if kubectl get secret github-token -n flux-system &>/dev/null; then
                  # Get token from password, token, or value key
                  GITHUB_TOKEN=""
                  for key in password token value; do
                    GITHUB_TOKEN=$(kubectl get secret github-token -n flux-system -o jsonpath="{.data.${key}}" 2>/dev/null | base64 -d)
                    [ -n "${GITHUB_TOKEN}" ] && break
                  done
                  
                  if [ -n "${GITHUB_TOKEN}" ]; then
                    # Get username if available, otherwise use token as username
                    GITHUB_USERNAME=$(kubectl get secret github-token -n flux-system -o jsonpath="{.data.username}" 2>/dev/null | base64 -d)
                    GITHUB_USERNAME="${GITHUB_USERNAME:-${GITHUB_TOKEN}}"
                    
                    kubectl create secret docker-registry ghcr-secret \
                      --docker-server=ghcr.io \
                      --docker-username="${GITHUB_USERNAME}" \
                      --docker-password="${GITHUB_TOKEN}" \
                      --namespace=flyte \
                      --dry-run=client -o yaml | kubectl apply -f -
                    echo "âœ… Created ghcr-secret"
                  else
                    echo "âš ï¸  Warning: Could not extract token from github-token secret, skipping ghcr-secret"
                  fi
                else
                  echo "âš ï¸  Warning: github-token secret not found in flux-system, skipping ghcr-secret"
                fi
              fi
              
              echo ""
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo "âœ… Flyte secret bootstrap complete!"
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
