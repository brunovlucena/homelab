---
apiVersion: batch/v1
kind: Job
metadata:
  name: trigger-agent-training
  namespace: flyte
  labels:
    app: flyte
    component: workflow-trigger
  annotations:
    kustomize.toolkit.fluxcd.io/force: "enabled"
    kustomize.toolkit.fluxcd.io/prune: "enabled"
spec:
  backoffLimit: 3
  ttlSecondsAfterFinished: 7200
  template:
    metadata:
      labels:
        app: flyte
        component: workflow-trigger
    spec:
      restartPolicy: OnFailure
      imagePullSecrets:
        - name: ghcr-secret
      containers:
        - name: trigger
          image: ghcr.io/brunovlucena/flyte-workflow-registry:latest
          imagePullPolicy: Always
          env:
            - name: FLYTE_CREDENTIALS_CLIENT_ID
              value: "flyteadmin"
            - name: FLYTE_CREDENTIALS_CLIENT_SECRET
              value: "flyteadmin"
            - name: FLYTE_PLATFORM_URL
              value: "flyteadmin.flyte.svc.cluster.local:81"
            - name: FLYTE_PLATFORM_INSECURE
              value: "true"
          command:
            - /bin/bash
            - -c
            - |
              set -e
              
              echo "ðŸš€ Triggering agent-sre fine-tuning workflow..."
              
              mkdir -p ~/.flyte
              cat > ~/.flyte/config.yaml <<EOF
              admin:
                endpoint: flyteadmin.flyte.svc.cluster.local:81
                insecure: true
              EOF
              
              # Use flytectl to trigger workflow (simpler and more reliable)
              echo "ðŸ“‹ Creating execution input file..."
              cat > /tmp/execution-inputs.json <<'INPUTS'
              {
                "agent_name": "agent-sre",
                "iters": 100,
                "batch_size": 2,
                "learning_rate": 0.0001,
                "lora_layers": 8,
                "lora_rank": 4,
                "lora_alpha": 8
              }
              INPUTS
              
              echo "ðŸš€ Triggering workflow execution..."
              
              # Use Python API to trigger workflow
              python3 << 'PYTHON_SCRIPT'
              import sys
              from flytekit.configuration import Config, PlatformConfig
              from flytekit.remote import FlyteRemote
              
              try:
                  # Create PlatformConfig with endpoint
                  platform_config = PlatformConfig(
                      endpoint="flyteadmin.flyte.svc.cluster.local:81",
                      insecure=True
                  )
                  
                  # Create Config with platform (this works - tested)
                  config = Config(platform=platform_config)
                  
                  print("ðŸ”Œ Connecting to Flyte admin...")
                  remote = FlyteRemote(config)
                  
                  print("ðŸ“‹ Fetching workflow...")
                  # Workflow name includes module prefix: agent_training.agent_training_pipeline
                  wf = remote.fetch_workflow(name="agent_training.agent_training_pipeline", project="homelab", domain="production")
                  print(f"âœ… Found workflow: {wf.name}")
                  
                  print("ðŸš€ Triggering execution...")
                  # Execute with explicit project and domain
                  execution = remote.execute(
                      wf,
                      project="homelab",
                      domain="production",
                      inputs={
                          "agent_name": "agent-sre",
                          "iters": 100,
                          "batch_size": 2,
                          "learning_rate": 0.0001,
                          "lora_layers": 8,
                          "lora_rank": 4,
                          "lora_alpha": 8
                      }
                  )
                  print(f"âœ… Execution triggered successfully!")
                  print(f"   Execution ID: {execution.id.name}")
                  print(f"   Project: {execution.id.project}")
                  print(f"   Domain: {execution.id.domain}")
                  sys.exit(0)
              except Exception as e:
                  print(f"âŒ Error triggering workflow: {e}")
                  import traceback
                  traceback.print_exc()
                  sys.exit(1)
              PYTHON_SCRIPT
              
              echo "âœ… Workflow execution triggered!"
          resources:
            requests:
              memory: "256Mi"
              cpu: "100m"
            limits:
              memory: "512Mi"
              cpu: "500m"

