apiVersion: v1
kind: ServiceAccount
metadata:
  name: minio-secret-init
  namespace: flyte
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: minio-secret-init-production
rules:
- apiGroups: [""]
  resources: ["secrets", "namespaces"]
  verbs: ["get", "list", "create", "update", "patch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: minio-secret-init-production
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: minio-secret-init-production
subjects:
- kind: ServiceAccount
  name: minio-secret-init
  namespace: flyte
---
apiVersion: batch/v1
kind: Job
metadata:
  name: minio-secret-init-production
  namespace: flyte
  labels:
    app.kubernetes.io/name: minio-secret-init
    app.kubernetes.io/component: bootstrap
  annotations:
    fluxcd.io/automation: "true"
spec:
  ttlSecondsAfterFinished: 300
  backoffLimit: 3
  template:
    metadata:
      labels:
        app.kubernetes.io/name: minio-secret-init
    spec:
      restartPolicy: OnFailure
      serviceAccountName: minio-secret-init
      containers:
        - name: create-secret
          image: localhost:5001/kubectl:v1.34.0
          imagePullPolicy: IfNotPresent
          command:
            - sh
            - -c
            - |
              set -e
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo "ğŸ” MinIO Secret Bootstrap for flyte"
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo ""
              
              # Try to find minio-credentials in common namespaces
              SOURCE_NAMESPACES=("minio" "flyte" "flux-system" "default")
              TARGET_NAMESPACE="flyte"
              SECRET_NAME="minio-credentials"
              
              SOURCE_NAMESPACE=""
              for ns in "${SOURCE_NAMESPACES[@]}"; do
                echo "â³ Checking namespace ${ns} for ${SECRET_NAME}..."
                if kubectl get secret "${SECRET_NAME}" -n "${ns}" &>/dev/null; then
                  SOURCE_NAMESPACE="${ns}"
                  echo "âœ… Found ${SECRET_NAME} in namespace ${ns}"
                  break
                fi
              done
              
              if [ -z "${SOURCE_NAMESPACE}" ]; then
                echo "âŒ Error: Could not find ${SECRET_NAME} in any of: ${SOURCE_NAMESPACES[*]}"
                exit 1
              fi
              
              echo ""
              echo "ğŸ“‹ Extracting secret data from ${SOURCE_NAMESPACE}..."
              
              # Get the secret and copy it to target namespace
              kubectl get secret "${SECRET_NAME}" -n "${SOURCE_NAMESPACE}" -o yaml | \
                sed "s/namespace: ${SOURCE_NAMESPACE}/namespace: ${TARGET_NAMESPACE}/" | \
                sed '/^  uid:/d' | \
                sed '/^  resourceVersion:/d' | \
                sed '/^  creationTimestamp:/d' | \
                kubectl apply -f -
              
              echo ""
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo "âœ… ${SECRET_NAME} copied successfully to ${TARGET_NAMESPACE}!"
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
