---
# ServiceAccount for ghcr-secret-init job in flyte
apiVersion: v1
kind: ServiceAccount
metadata:
  name: ghcr-secret-init
  namespace: flyte
  labels:
    app: flyte
    component: secret-init
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: ghcr-secret-init-production
  labels:
    app: flyte
    component: secret-init
rules:
- apiGroups: [""]
  resources: ["secrets", "namespaces"]
  verbs: ["get", "list", "create", "update", "patch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: ghcr-secret-init-production
  labels:
    app: flyte
    component: secret-init
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: ghcr-secret-init-production
subjects:
- kind: ServiceAccount
  name: ghcr-secret-init
  namespace: flyte
---
# Job to create ghcr-secret in flyte namespace for Flyte execution pods
apiVersion: batch/v1
kind: Job
metadata:
  name: ghcr-secret-init-production
  namespace: flyte
  labels:
    app: flyte
    component: secret-init
  annotations:
    kustomize.toolkit.fluxcd.io/prune: disabled
spec:
  backoffLimit: 3
  ttlSecondsAfterFinished: 300
  template:
    metadata:
      labels:
        app: flyte
        component: secret-init
    spec:
      serviceAccountName: ghcr-secret-init
      restartPolicy: OnFailure
      containers:
        - name: create-secret
          image: localhost:5001/kubectl:v1.34.0
          command:
            - sh
            - -c
            - |
              set -e
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo "ğŸ” GHCR Secret Bootstrap for flyte"
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo ""
              
              SOURCE_NAMESPACE="flux-system"
              TARGET_NAMESPACE="flyte"
              
              # Wait for flux-system namespace and github-token secret
              echo "â³ Waiting for github-token secret in ${SOURCE_NAMESPACE}..."
              until kubectl get secret github-token -n "${SOURCE_NAMESPACE}" &>/dev/null; do
                echo "   Secret not found, waiting..."
                sleep 2
              done
              echo "âœ… github-token secret found"
              
              echo ""
              echo "ğŸ“‹ Extracting GitHub token..."
              # Get token from password, token, or value key
              GITHUB_TOKEN=""
              for key in password token value; do
                GITHUB_TOKEN=$(kubectl get secret github-token -n "${SOURCE_NAMESPACE}" -o jsonpath="{.data.${key}}" 2>/dev/null | base64 -d)
                [ -n "${GITHUB_TOKEN}" ] && break
              done
              
              if [ -z "${GITHUB_TOKEN}" ]; then
                echo "âŒ Error: Could not extract token from github-token secret"
                exit 1
              fi
              echo "âœ… Token extracted"
              
              # Get username if available, otherwise use token as username
              GITHUB_USERNAME=$(kubectl get secret github-token -n "${SOURCE_NAMESPACE}" -o jsonpath="{.data.username}" 2>/dev/null | base64 -d)
              GITHUB_USERNAME="${GITHUB_USERNAME:-${GITHUB_TOKEN}}"
              
              echo ""
              echo "ğŸ“¤ Creating ghcr-secret in ${TARGET_NAMESPACE}..."
              kubectl create secret docker-registry ghcr-secret \
                --docker-server=ghcr.io \
                --docker-username="${GITHUB_USERNAME}" \
                --docker-password="${GITHUB_TOKEN}" \
                --namespace="${TARGET_NAMESPACE}" \
                --dry-run=client -o yaml | kubectl apply -f -
              
              echo ""
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo "âœ… ghcr-secret created successfully in ${TARGET_NAMESPACE}!"
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

