---
# MAG7 Battle - Exploit Spawner
# Generates exploit waves that attack the player
# This is an agent-redteam "tool" that creates LambdaFunctions as exploits!
apiVersion: lambda.knative.io/v1alpha1
kind: LambdaFunction
metadata:
  name: mag7-exploit-spawner
  namespace: demo-mag7-battle
  labels:
    app.kubernetes.io/name: mag7-exploit-spawner
    app.kubernetes.io/component: exploit-spawner
    app.kubernetes.io/part-of: demo-mag7-battle
    redteam.homelab.io/tool: "true"
  annotations:
    description: "Spawns exploit waves for MAG7 Battle demo"
    redteam.homelab.io/category: "game-tool"
spec:
  build:
    registry: localhost:5001
    registryType: local
    insecure: true
  source:
    type: inline
    inline:
      code: |
        """
        MAG7 Exploit Spawner - RedTeam Tool
        
        This LambdaFunction acts as a tool for agent-redteam.
        It spawns exploit waves during the MAG7 Battle game.
        
        Each exploit is represented as a projectile that agent-blueteam must block!
        """
        import random
        import json
        from datetime import datetime
        from uuid import uuid4
        
        # Exploit types based on real vulnerabilities
        EXPLOITS = [
            {
                "id": "blue-001",
                "name": "SSRF Attack",
                "emoji": "ðŸŒ",
                "color": "#ff6b6b",
                "damage": 15,
                "speed": 3,
                "description": "Server-Side Request Forgery via go-git",
            },
            {
                "id": "blue-002",
                "name": "Template Injection",
                "emoji": "ðŸ’‰",
                "color": "#feca57",
                "damage": 20,
                "speed": 4,
                "description": "Go Template Code Injection",
            },
            {
                "id": "vuln-001",
                "name": "Command Injection",
                "emoji": "âš¡",
                "color": "#ff9ff3",
                "damage": 25,
                "speed": 5,
                "description": "Shell command via git URL",
            },
            {
                "id": "vuln-003",
                "name": "Code Execution",
                "emoji": "ðŸ”¥",
                "color": "#54a0ff",
                "damage": 30,
                "speed": 4,
                "description": "Arbitrary inline code execution",
            },
            {
                "id": "vuln-004",
                "name": "RBAC Escalation",
                "emoji": "ðŸ‘‘",
                "color": "#5f27cd",
                "damage": 35,
                "speed": 3,
                "description": "Privilege escalation to cluster-admin",
            },
            {
                "id": "blue-006",
                "name": "Token Theft",
                "emoji": "ðŸ”‘",
                "color": "#00d2d3",
                "damage": 20,
                "speed": 4,
                "description": "Service Account token exposure",
            },
        ]
        
        # MAG7 special attacks
        MAG7_ATTACKS = [
            {
                "head": "apple",
                "name": "Walled Garden",
                "emoji": "ðŸŽ",
                "color": "#a8a8a8",
                "damage": 30,
                "effect": "Blocks your network policies",
            },
            {
                "head": "microsoft",
                "name": "Blue Screen",
                "emoji": "ðŸªŸ",
                "color": "#0078d4",
                "damage": 25,
                "effect": "Crashes random pods",
            },
            {
                "head": "google",
                "name": "Data Harvest",
                "emoji": "ðŸ”",
                "color": "#4285f4",
                "damage": 35,
                "effect": "Exfiltrates your secrets",
            },
            {
                "head": "amazon",
                "name": "Cloud Lock",
                "emoji": "ðŸ“¦",
                "color": "#ff9900",
                "damage": 20,
                "effect": "Scales your costs infinitely",
            },
            {
                "head": "meta",
                "name": "Privacy Void",
                "emoji": "ðŸ‘“",
                "color": "#0668e1",
                "damage": 40,
                "effect": "Leaks all your data",
            },
            {
                "head": "tesla",
                "name": "Self-Drive",
                "emoji": "âš¡",
                "color": "#cc0000",
                "damage": 45,
                "effect": "Autonomous attack mode",
            },
            {
                "head": "nvidia",
                "name": "GPU Meltdown",
                "emoji": "ðŸŽ®",
                "color": "#76b900",
                "damage": 50,
                "effect": "Resource exhaustion",
            },
        ]
        
        def spawn_wave(wave_number: int, difficulty: str = "normal") -> list:
            """
            Spawn a wave of exploits.
            
            Args:
                wave_number: Current wave (affects count and speed)
                difficulty: Game difficulty
            
            Returns:
                List of exploit objects to spawn
            """
            base_count = 3 + (wave_number * 2)
            
            if difficulty == "hard":
                base_count = int(base_count * 1.5)
            elif difficulty == "easy":
                base_count = max(2, base_count // 2)
            
            spawned = []
            
            for i in range(base_count):
                exploit = random.choice(EXPLOITS).copy()
                exploit["spawn_id"] = str(uuid4())[:8]
                exploit["x"] = random.randint(50, 750)  # Random x position
                exploit["y"] = -50  # Start above screen
                exploit["speed"] = exploit["speed"] + (wave_number * 0.5)
                exploit["spawned_at"] = datetime.utcnow().isoformat()
                spawned.append(exploit)
            
            # Add MAG7 attack every 3 waves
            if wave_number % 3 == 0:
                head_index = (wave_number // 3 - 1) % len(MAG7_ATTACKS)
                mag7_attack = MAG7_ATTACKS[head_index].copy()
                mag7_attack["spawn_id"] = str(uuid4())[:8]
                mag7_attack["is_boss_attack"] = True
                mag7_attack["x"] = 400  # Center
                mag7_attack["y"] = -100
                mag7_attack["speed"] = 2
                mag7_attack["spawned_at"] = datetime.utcnow().isoformat()
                spawned.append(mag7_attack)
            
            return spawned
        
        def handler(event):
            """
            CloudEvent handler for exploit spawning.
            
            Events:
            - io.homelab.demo.spawn.wave: Spawn a new wave
            - io.homelab.demo.spawn.single: Spawn single exploit
            """
            event_type = event.get("type", "")
            data = event.get("data", {})
            
            if event_type == "io.homelab.demo.spawn.wave":
                wave = data.get("wave", 1)
                difficulty = data.get("difficulty", "normal")
                exploits = spawn_wave(wave, difficulty)
                
                return {
                    "statusCode": 200,
                    "body": json.dumps({
                        "wave": wave,
                        "exploits": exploits,
                        "count": len(exploits),
                    }),
                }
            
            elif event_type == "io.homelab.demo.spawn.single":
                exploit_id = data.get("exploit_id")
                if exploit_id:
                    exploit = next((e for e in EXPLOITS if e["id"] == exploit_id), None)
                    if exploit:
                        exploit = exploit.copy()
                        exploit["spawn_id"] = str(uuid4())[:8]
                        exploit["x"] = data.get("x", random.randint(50, 750))
                        exploit["y"] = data.get("y", -50)
                        return {
                            "statusCode": 200,
                            "body": json.dumps({"exploit": exploit}),
                        }
                
                return {
                    "statusCode": 404,
                    "body": json.dumps({"error": "Exploit not found"}),
                }
            
            # Default: return catalog
            return {
                "statusCode": 200,
                "body": json.dumps({
                    "exploits": EXPLOITS,
                    "mag7_attacks": MAG7_ATTACKS,
                }),
            }
  runtime:
    language: python
    version: "3.11"
    handler: "main.handler"
  
  scaling:
    minReplicas: 0
    maxReplicas: 3
    targetConcurrency: 20
    scaleToZeroGracePeriod: 60s
  
  resources:
    requests:
      memory: "64Mi"
      cpu: "25m"
    limits:
      memory: "128Mi"
      cpu: "100m"
