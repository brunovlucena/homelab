---
# k6 Test for demo-mag7-battle game server
apiVersion: k6.io/v1alpha1
kind: TestRun
metadata:
  name: mag7-game-server-test
  namespace: demo-mag7-battle
  labels:
    app.kubernetes.io/name: demo-mag7-battle
    app.kubernetes.io/component: testing
    test-type: game-api
spec:
  parallelism: 1
  arguments: -o experimental-prometheus-rw
  script:
    configMap:
      name: mag7-game-server-test-script
      file: script.js
  runner:
    image: grafana/k6:0.47.0
    env:
      - name: TARGET_URL
        value: "http://mag7-game-server.demo-mag7-battle.svc.cluster.local:8080"
      - name: K6_PROMETHEUS_RW_SERVER_URL
        value: "http://kube-prometheus-stack-prometheus.prometheus.svc.cluster.local:9090/api/v1/write"
    resources:
      limits:
        memory: "256Mi"
        cpu: "200m"
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: mag7-game-server-test-script
  namespace: demo-mag7-battle
data:
  script.js: |
    import http from 'k6/http';
    import { check, sleep } from 'k6';
    import { Counter } from 'k6/metrics';
    
    const gamesStarted = new Counter('games_started');
    const exploitsBlocked = new Counter('game_exploits_blocked');
    
    export const options = {
      stages: [
        { duration: '10s', target: 2 },
        { duration: '20s', target: 2 },
        { duration: '10s', target: 0 },
      ],
      thresholds: {
        http_req_duration: ['p(95)<500'],
        http_req_failed: ['rate<0.1'],
      },
    };
    
    const BASE_URL = __ENV.TARGET_URL || 'http://localhost:8080';
    
    export default function() {
      // Test health endpoint
      let res = http.get(`${BASE_URL}/health`);
      check(res, {
        'health check ok': (r) => r.status === 200,
      });
      
      // Start a new game
      res = http.post(`${BASE_URL}/game/start`);
      check(res, {
        'game started': (r) => r.status === 200,
        'has game_id': (r) => r.json().game_id !== undefined,
      });
      
      if (res.status === 200) {
        const gameId = res.json().game_id;
        gamesStarted.add(1);
        
        // Get game state
        res = http.get(`${BASE_URL}/game/${gameId}`);
        check(res, {
          'game state retrieved': (r) => r.status === 200,
          'mag7 health is 1000': (r) => r.json().mag7_health === 1000,
        });
        
        // Block some exploits
        for (let i = 0; i < 3; i++) {
          res = http.post(`${BASE_URL}/game/${gameId}/block`, JSON.stringify({
            exploit_type: 'vuln-001',
            damage: 50
          }), { headers: { 'Content-Type': 'application/json' } });
          
          check(res, {
            'exploit blocked': (r) => r.status === 200,
          });
          
          if (res.status === 200) {
            exploitsBlocked.add(1);
          }
          
          sleep(0.2);
        }
        
        // Check updated state
        res = http.get(`${BASE_URL}/game/${gameId}`);
        check(res, {
          'mag7 took damage': (r) => r.json().mag7_health < 1000,
          'score increased': (r) => r.json().score > 0,
        });
      }
      
      sleep(1);
    }
