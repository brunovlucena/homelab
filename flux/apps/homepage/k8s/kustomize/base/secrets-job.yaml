---
apiVersion: batch/v1
kind: Job
metadata:
  name: homepage-secret-sync
  namespace: homepage
  labels:
    app: homepage
    component: secret-sync
spec:
  backoffLimit: 3
  ttlSecondsAfterFinished: 86400
  template:
    metadata:
      labels:
        app: homepage
        component: secret-sync
    spec:
      serviceAccountName: homepage-secret-sync
      restartPolicy: Never
      containers:
        - name: sync
          image: localhost:5001/kubectl:v1.34.0
          imagePullPolicy: IfNotPresent
          env:
            - name: SOURCE_NAMESPACE
              value: flux-system
            - name: TARGET_NAMESPACE
              value: homepage
            - name: SECRET_NAMES
              value: "github-token,homepage"
          command:
            - /bin/bash
            - -c
            - |
              set -euo pipefail

              echo "Creating ghcr-secret from github-token"
              # Get token from password, token, or value key
              for key in password token value; do
                GITHUB_TOKEN=$(kubectl get secret github-token -n "${SOURCE_NAMESPACE}" -o jsonpath="{.data.${key}}" 2>/dev/null | base64 -d)
                [ -n "${GITHUB_TOKEN}" ] && break
              done
              
              if [ -z "${GITHUB_TOKEN}" ]; then
                echo "Error: Could not extract token from github-token secret"
                exit 1
              fi
              
              # Get username if available, otherwise use token as username
              GITHUB_USERNAME=$(kubectl get secret github-token -n "${SOURCE_NAMESPACE}" -o jsonpath="{.data.username}" 2>/dev/null | base64 -d)
              GITHUB_USERNAME="${GITHUB_USERNAME:-${GITHUB_TOKEN}}"
              
              kubectl create secret docker-registry ghcr-secret \
                --docker-server=ghcr.io \
                --docker-username="${GITHUB_USERNAME}" \
                --docker-password="${GITHUB_TOKEN}" \
                --namespace="${TARGET_NAMESPACE}" \
                --dry-run=client -o yaml | kubectl apply -f -
              echo "✅ Created ghcr-secret"
              
              echo "Syncing homepage secret from ${SOURCE_NAMESPACE} to ${TARGET_NAMESPACE}"
              if ! kubectl get secret homepage -n "${SOURCE_NAMESPACE}" &>/dev/null; then
                echo "Error: homepage secret not found in ${SOURCE_NAMESPACE} namespace"
                exit 1
              fi
              
              # Copy the secret to target namespace
              kubectl get secret homepage -n "${SOURCE_NAMESPACE}" -o yaml | \
                sed "s/namespace: ${SOURCE_NAMESPACE}/namespace: ${TARGET_NAMESPACE}/" | \
                sed '/^  uid:/d' | \
                sed '/^  resourceVersion:/d' | \
                sed '/^  selfLink:/d' | \
                kubectl apply -f -
              echo "✅ Synced homepage secret"
              
              echo "Forcing rollout of all deployments in ${TARGET_NAMESPACE}"
              for deployment in $(kubectl get deployments -n "${TARGET_NAMESPACE}" -o jsonpath='{.items[*].metadata.name}'); do
                echo "Rolling out deployment ${deployment}"
                kubectl rollout restart deployment "${deployment}" -n "${TARGET_NAMESPACE}"
              done
              
              echo "Waiting for rollouts to complete"
              for deployment in $(kubectl get deployments -n "${TARGET_NAMESPACE}" -o jsonpath='{.items[*].metadata.name}'); do
                echo "Waiting for deployment ${deployment} to be ready"
                kubectl rollout status deployment "${deployment}" -n "${TARGET_NAMESPACE}" --timeout=5m || echo "Warning: Deployment ${deployment} rollout did not complete within timeout"
              done
              
              echo "✅ Secret sync and rollout complete"

