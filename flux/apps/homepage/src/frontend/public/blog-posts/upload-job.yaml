apiVersion: batch/v1
kind: Job
metadata:
  name: upload-three-scales-diagram
  namespace: default
spec:
  ttlSecondsAfterFinished: 300
  template:
    spec:
      restartPolicy: Never
      containers:
        - name: upload
          image: minio/mc:RELEASE.2025-08-13T08-35-41Z-cpuv1
          command:
            - /bin/sh
            - -c
            - |
              set -e
              echo "üì§ Uploading three-scales-framework to MinIO..."
              
              # Wait a bit for files to be available
              sleep 5
              
              # Configure MinIO client - try different endpoints
              ENDPOINTS=(
                "minio.minio.svc.cluster.local:9000"
                "localhost:9000"
                "127.0.0.1:9000"
              )
              
              for endpoint in "${ENDPOINTS[@]}"; do
                echo "üîó Trying endpoint: $endpoint"
                if mc alias set minio "http://$endpoint" "$MINIO_ACCESS_KEY" "$MINIO_SECRET_KEY" 2>/dev/null; then
                  if mc admin info minio >/dev/null 2>&1; then
                    echo "‚úÖ Connected to MinIO at $endpoint"
                    break
                  fi
                fi
              done
              
              # Create bucket if not exists
              mc mb -p minio/homepage-blog || true
              
              # Set public read policy
              mc anonymous set download minio/homepage-blog/images/ || true
              
              # Upload PNG (will be copied into pod via kubectl cp)
              if [ -f /tmp/three-scales-framework.png ]; then
                mc cp /tmp/three-scales-framework.png minio/homepage-blog/images/graphs/three-scales-framework.png
                echo "‚úÖ Uploaded: three-scales-framework.png"
              else
                echo "‚ùå PNG file not found in /tmp/"
                echo "üìã Contents of /tmp/:"
                ls -la /tmp/ || true
                exit 1
              fi
              
              # Upload SVG if exists
              if [ -f /tmp/three-scales-framework.svg ]; then
                mc cp /tmp/three-scales-framework.svg minio/homepage-blog/images/graphs/three-scales-framework.svg
                echo "‚úÖ Uploaded: three-scales-framework.svg"
              fi
              
              echo "üìã Verifying upload..."
              mc ls minio/homepage-blog/images/graphs/three-scales-framework.* || true
              
              echo "üéâ Upload complete!"
          env:
            - name: MINIO_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: minio-credentials
                  key: access-key
            - name: MINIO_SECRET_KEY
              valueFrom:
                secretKeyRef:
                  name: minio-credentials
                  key: secret-key
          volumeMounts:
            - name: tmp
              mountPath: /tmp
      volumes:
        - name: tmp
          emptyDir: {}
      serviceAccountName: default

