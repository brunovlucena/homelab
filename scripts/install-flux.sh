#!/bin/bash
set -e

# üöÄ Install Flux CD
# Based on: https://fluxcd.io/flux/installation/

CLUSTER_NAME=${1:-homelab}
CONTEXT="kind-${CLUSTER_NAME}"

echo "üöÄ Installing Flux CD on cluster: ${CLUSTER_NAME}"
echo "üìç Using context: ${CONTEXT}"

# Check if Flux is already installed
if kubectl get namespace flux-system --context "${CONTEXT}" >/dev/null 2>&1; then
    echo "‚úÖ Flux is already installed, skipping installation..."
    if flux check --context "${CONTEXT}" >/dev/null 2>&1; then
        echo "‚úÖ Flux is healthy!"
        exit 0
    else
        echo "‚ö†Ô∏è  Flux is installed but health check returned warnings (this may be normal)"
        exit 0
    fi
fi

# Pre-flight check
echo "‚úÖ Running pre-flight checks..."
if ! flux check --pre --context "${CONTEXT}"; then
    echo "‚ùå Pre-flight checks failed. Please address the issues before proceeding."
    exit 1
fi

# Install Flux with specific components
echo "üéØ Installing Flux CD components..."
if ! flux install \
    --components source-controller,kustomize-controller,helm-controller,notification-controller \
    --context "${CONTEXT}"; then
    echo "‚ùå Failed to install Flux CD"
    exit 1
fi

# Wait for Flux to be ready
echo "‚è≥ Waiting for Flux control plane to be ready..."
sleep 10  # Give it a moment to start creating resources

# Wait for flux-system namespace
kubectl wait --for=condition=Ready pods --all -n flux-system --timeout=300s --context "${CONTEXT}" || true

# Wait for Flux CRDs to be established
echo "‚è≥ Waiting for Flux CRDs to be established..."
kubectl wait --for condition=established --timeout=300s \
    crd/gitrepositories.source.toolkit.fluxcd.io \
    crd/helmrepositories.source.toolkit.fluxcd.io \
    crd/helmreleases.helm.toolkit.fluxcd.io \
    crd/kustomizations.kustomize.toolkit.fluxcd.io \
    --context "${CONTEXT}" 2>/dev/null || echo "‚ö†Ô∏è  Some Flux CRDs may not be available yet, continuing..."

# Verify installation
echo "üîç Verifying Flux installation..."
if flux check --context "${CONTEXT}"; then
    echo "‚úÖ Flux installation completed successfully!"
else
    echo "‚ö†Ô∏è  Flux check reported some issues, but installation is complete."
    echo "    You may need to wait a bit longer for all components to be ready."
fi

echo "üéâ Flux is now installed on ${CLUSTER_NAME}!"

