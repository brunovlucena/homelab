# ============================================================================
# ğŸ§ª Prometheus-Operator - Unit Tests CI/CD
# ============================================================================
# Version: 1.0.0
# Last Updated: 2026-01-13
#
# This workflow validates prometheus-operator configurations including:
#   - PrometheusRules (YAML syntax, PromQL validation, structure)
#   - ServiceMonitors (YAML syntax, endpoint validation)
#   - PodMonitors (YAML syntax, endpoint validation)
#   - Grafana Dashboards (JSON syntax, schema validation)
#   - ConfigMaps (YAML syntax, embedded JSON validation)
#
# Triggers:
#   - Pull requests affecting prometheus-operator
#   - Push to main/develop branches
#   - Manual workflow dispatch
# ============================================================================

name: ğŸ§ª Prometheus-Operator Tests

on:
  workflow_dispatch:
    inputs:
      verbose:
        description: 'Enable verbose test output'
        required: false
        default: false
        type: boolean

  pull_request:
    paths:
      - 'flux/infrastructure/prometheus-operator/**'
      - '.github/workflows/prometheus-operator.yaml'

  push:
    branches:
      - main
      - develop
      - 'feature/**'
      - 'bugfix/**'
      - 'release/**'
    paths:
      - 'flux/infrastructure/prometheus-operator/**'
      - '.github/workflows/prometheus-operator.yaml'

# Cancel in-progress runs for the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  GO_VERSION: '1.25'
  WORKING_DIR: flux/infrastructure/prometheus-operator

permissions:
  contents: read
  pull-requests: read

jobs:
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # Detect Changes
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

  detect-changes:
    name: ğŸ” Detect Changes
    runs-on: [self-hosted]
    timeout-minutes: 5
    outputs:
      should_run: ${{ steps.changes.outputs.prometheus-operator == 'true' || github.event_name == 'workflow_dispatch' }}
      changes_summary: ${{ steps.summary.outputs.summary }}
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ” Detect Changes
        uses: dorny/paths-filter@v3
        id: changes
        if: github.event_name != 'workflow_dispatch'
        with:
          filters: |
            prometheus-operator:
              - 'flux/infrastructure/prometheus-operator/**'
              - '.github/workflows/prometheus-operator.yaml'

      - name: ğŸ“‹ Generate Summary
        id: summary
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "summary=Manual trigger" >> $GITHUB_OUTPUT
          elif [ "${{ steps.changes.outputs.prometheus-operator }}" = "true" ]; then
            echo "summary=Changes detected in prometheus-operator" >> $GITHUB_OUTPUT
          else
            echo "summary=No changes detected" >> $GITHUB_OUTPUT
          fi

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # JSON/YAML Linting
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

  lint:
    name: ğŸ” Lint
    runs-on: [self-hosted]
    timeout-minutes: 10
    needs: [detect-changes]
    if: needs.detect-changes.outputs.should_run == 'true'
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ğŸ“¦ Install yamllint
        run: pip install yamllint

      - name: ğŸ” Validate YAML syntax
        run: |
          echo "ğŸ” Checking YAML files..."
          
          # Find all YAML files (excluding kustomization files for now)
          YAML_FILES=$(find ${{ env.WORKING_DIR }}/k8s -name "*.yaml" -type f | grep -v kustomization.yaml || true)
          
          ERRORS=0
          for file in $YAML_FILES; do
            # Use safe_load_all to handle multi-document YAML files (with --- separators)
            if ! python3 -c "import yaml; list(yaml.safe_load_all(open('$file')))" 2>/dev/null; then
              echo "âŒ Invalid YAML: $file"
              ERRORS=$((ERRORS+1))
            fi
          done
          
          if [ $ERRORS -gt 0 ]; then
            echo "âŒ Found $ERRORS invalid YAML file(s)"
            exit 1
          fi
          
          echo "âœ… All YAML files are valid"

      - name: ğŸ” Validate JSON syntax
        run: |
          echo "ğŸ” Checking JSON files..."
          
          JSON_FILES=$(find ${{ env.WORKING_DIR }}/k8s -name "*.json" -type f || true)
          
          ERRORS=0
          for file in $JSON_FILES; do
            if ! python3 -m json.tool "$file" >/dev/null 2>&1; then
              echo "âŒ Invalid JSON: $file"
              python3 -m json.tool "$file" 2>&1 | head -10 || true
              ERRORS=$((ERRORS+1))
            fi
          done
          
          if [ $ERRORS -gt 0 ]; then
            echo "âŒ Found $ERRORS invalid JSON file(s)"
            exit 1
          fi
          
          echo "âœ… All JSON files are valid"

      - name: ğŸ“‹ Lint Summary
        run: |
          echo "## ğŸ” Lint Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| YAML Syntax | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          echo "| JSON Syntax | âœ… Passed |" >> $GITHUB_STEP_SUMMARY

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # Unit Tests
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

  test:
    name: ğŸ§ª Unit Tests
    runs-on: [self-hosted]
    timeout-minutes: 15
    needs: [detect-changes, lint]
    if: needs.detect-changes.outputs.should_run == 'true'
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ¹ Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: ${{ env.WORKING_DIR }}/tests/go.sum

      - name: ğŸ“¦ Install dependencies
        working-directory: ${{ env.WORKING_DIR }}/tests
        run: |
          go mod download
          go mod tidy

      - name: ğŸ§ª Run unit tests
        working-directory: ${{ env.WORKING_DIR }}/tests
        run: |
          echo "ğŸ§ª Running unit tests..."
          
          # Run tests (race detector disabled - requires CGO/GCC not available on runner)
          go test -v -coverprofile=coverage.out -timeout=10m ./unit/... 2>&1 | tee test-output.txt
          
          # Check test result
          TEST_EXIT_CODE=${PIPESTATUS[0]}
          
          if [ $TEST_EXIT_CODE -ne 0 ]; then
            echo "âŒ Some tests failed"
            exit $TEST_EXIT_CODE
          fi
          
          echo "âœ… All tests passed"

      - name: ğŸ“Š Generate coverage report
        working-directory: ${{ env.WORKING_DIR }}/tests
        if: always()
        run: |
          if [ -f coverage.out ]; then
            echo "ğŸ“Š Coverage Summary:"
            go tool cover -func=coverage.out | tail -20
            
            COVERAGE=$(go tool cover -func=coverage.out | grep total | awk '{print $3}')
            echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ“‹ Test Summary
        if: always()
        run: |
          echo "## ğŸ§ª Unit Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f ${{ env.WORKING_DIR }}/tests/test-output.txt ]; then
            # Count passed/failed tests
            PASSED=$(grep -c "^--- PASS" ${{ env.WORKING_DIR }}/tests/test-output.txt || echo "0")
            FAILED=$(grep -c "^--- FAIL" ${{ env.WORKING_DIR }}/tests/test-output.txt || echo "0")
            
            echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| Passed | $PASSED |" >> $GITHUB_STEP_SUMMARY
            echo "| Failed | $FAILED |" >> $GITHUB_STEP_SUMMARY
            
            if [ "$FAILED" -gt 0 ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### âŒ Failed Tests" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              grep -A 10 "^--- FAIL" ${{ env.WORKING_DIR }}/tests/test-output.txt | head -50 >> $GITHUB_STEP_SUMMARY || true
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            fi
          fi

      - name: ğŸ“¤ Upload coverage
        uses: codecov/codecov-action@v5
        continue-on-error: true
        with:
          files: ${{ env.WORKING_DIR }}/tests/coverage.out
          flags: prometheus-operator
          name: prometheus-operator-tests
          fail_ci_if_error: false

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # PrometheusRule Validation with promtool
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

  promtool-validation:
    name: ğŸ”§ PromQL Validation
    runs-on: [self-hosted]
    timeout-minutes: 10
    needs: [detect-changes]
    if: needs.detect-changes.outputs.should_run == 'true'
    continue-on-error: true  # promtool validation is best-effort
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Install promtool
        run: |
          # Download prometheus tarball
          PROMETHEUS_VERSION="2.55.1"
          wget -q "https://github.com/prometheus/prometheus/releases/download/v${PROMETHEUS_VERSION}/prometheus-${PROMETHEUS_VERSION}.linux-amd64.tar.gz" -O prometheus.tar.gz || \
          wget -q "https://github.com/prometheus/prometheus/releases/download/v${PROMETHEUS_VERSION}/prometheus-${PROMETHEUS_VERSION}.linux-arm64.tar.gz" -O prometheus.tar.gz || \
          echo "âš ï¸ Could not download promtool"
          
          if [ -f prometheus.tar.gz ]; then
            tar -xzf prometheus.tar.gz
            sudo cp prometheus-*/promtool /usr/local/bin/ || true
            rm -rf prometheus.tar.gz prometheus-*
            promtool --version || echo "âš ï¸ promtool not available"
          fi

      - name: ğŸ”§ Validate PrometheusRules with promtool
        run: |
          echo "ğŸ”§ Validating PrometheusRules with promtool..."
          
          ERRORS=0
          for file in ${{ env.WORKING_DIR }}/k8s/prometheusrules/*.yaml; do
            if [ -f "$file" ] && [ "$(basename $file)" != "kustomization.yaml" ]; then
              echo "Checking $file..."
              
              # promtool expects standalone rule files, so we need to extract the rules
              # For now, we'll do basic validation and rely on Go tests for full validation
              if command -v promtool >/dev/null 2>&1; then
                # Try to validate (may fail due to CRD structure)
                promtool check rules "$file" 2>&1 || true
              fi
            fi
          done
          
          echo "âœ… PromQL validation completed"

      - name: ğŸ“‹ Promtool Summary
        run: |
          echo "## ğŸ”§ PromQL Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "PrometheusRules were validated for syntax." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ Note: Full PromQL validation requires promtool with rule file extraction." >> $GITHUB_STEP_SUMMARY

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # Pipeline Summary
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

  summary:
    name: ğŸ“‹ Summary
    runs-on: [self-hosted]
    timeout-minutes: 5
    needs: [detect-changes, lint, test, promtool-validation]
    if: always()
    steps:
      - name: ğŸ“Š Generate summary
        run: |
          echo "## ğŸ§ª Prometheus-Operator Tests Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… Pipeline Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Detect Changes | ${{ needs.detect-changes.result == 'success' && 'âœ…' || needs.detect-changes.result == 'skipped' && 'â­ï¸' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Lint | ${{ needs.lint.result == 'success' && 'âœ…' || needs.lint.result == 'skipped' && 'â­ï¸' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Unit Tests | ${{ needs.test.result == 'success' && 'âœ…' || needs.test.result == 'skipped' && 'â­ï¸' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| PromQL Validation | ${{ needs.promtool-validation.result == 'success' && 'âœ…' || needs.promtool-validation.result == 'skipped' && 'â­ï¸' || 'âš ï¸' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“‹ Trigger Information" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Event | \`${{ github.event_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Ref | \`${{ github.ref }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| SHA | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Changes | ${{ needs.detect-changes.outputs.changes_summary }} |" >> $GITHUB_STEP_SUMMARY

      - name: âŒ Fail if tests failed
        if: needs.test.result == 'failure' || needs.lint.result == 'failure'
        run: |
          echo "âŒ Pipeline failed - tests or lint checks did not pass"
          exit 1
